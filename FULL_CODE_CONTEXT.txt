PROJECT CONTEXT GENERATED ON 12/04/2025 16:06:00


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\auth.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AuthController } from './auth.controller';

describe('AuthController', () => {
  let controller: AuthController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [AuthController],
    }).compile();

    controller = module.get<AuthController>(AuthController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\auth.controller.ts
================================================================

import { Controller, Post, Body, UnauthorizedException } from '@nestjs/common';
import { AuthService } from './auth.service';

@Controller('auth')
export class AuthController {
    constructor(private authService: AuthService) { }

    @Post('login')
    async login(@Body() body: any) {
        const user = await this.authService.validateUser(body.email, body.password);
        if (!user) {
            throw new UnauthorizedException();
        }
        return this.authService.login(user);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\auth.module.ts
================================================================

import { Module } from '@nestjs/common';
import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { UsersModule } from '../users/users.module';
import { PassportModule } from '@nestjs/passport';
import { JwtModule } from '@nestjs/jwt';
import { JwtStrategy } from './jwt.strategy';

@Module({
  imports: [
    UsersModule,
    PassportModule,
    JwtModule.register({
      secret: 'SECRET_KEY_CAMBIAR_EN_PROD', // TODO: Env var
      signOptions: { expiresIn: '60m' },
    }),
  ],
  providers: [AuthService, JwtStrategy],
  controllers: [AuthController],
  exports: [AuthService],
})
export class AuthModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\auth.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AuthService } from './auth.service';

describe('AuthService', () => {
  let service: AuthService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [AuthService],
    }).compile();

    service = module.get<AuthService>(AuthService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\auth.service.ts
================================================================

import { Injectable, UnauthorizedException } from '@nestjs/common';
import { UsersService } from '../users/users.service';
import { JwtService } from '@nestjs/jwt';
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
    constructor(
        private usersService: UsersService,
        private jwtService: JwtService,
    ) { }

    async validateUser(email: string, pass: string): Promise<any> {
        const user = await this.usersService.findOne(email);
        if (user && (await bcrypt.compare(pass, user.passwordHash))) {
            const { passwordHash, ...result } = user;
            return result;
        }
        return null;
    }

    async login(user: any) {
        const payload = { email: user.email, sub: user.id, rol: user.rol };
        return {
            access_token: this.jwtService.sign(payload),
        };
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\jwt-auth.guard.ts
================================================================

import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\jwt.strategy.ts
================================================================

import { ExtractJwt, Strategy } from 'passport-jwt';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable } from '@nestjs/common';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
    constructor() {
        super({
            jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
            ignoreExpiration: false,
            secretOrKey: 'SECRET_KEY_CAMBIAR_EN_PROD', // TODO: Move to env vars
        });
    }

    async validate(payload: any) {
        return { userId: payload.sub, email: payload.email, rol: payload.rol };
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\roles.decorator.ts
================================================================

import { SetMetadata } from '@nestjs/common';

export const Roles = (...roles: string[]) => SetMetadata('roles', roles);



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\roles.enum.ts
================================================================

export enum UserRole {
    BROKER_EXTERNO = 'BROKER_EXTERNO',
    EJECUTIVO_PROMESA = 'EJECUTIVO_PROMESA',
    EJECUTIVO_ESCRITURA = 'EJECUTIVO_ESCRITURA',
    EJECUTIVO_CREDITO = 'EJECUTIVO_CREDITO',
    CONTABILIDAD = 'CONTABILIDAD',
    GERENCIA = 'GERENCIA',
    ADMIN = 'ADMIN',
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\auth\roles.guard.ts
================================================================

import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';

@Injectable()
export class RolesGuard implements CanActivate {
    constructor(private reflector: Reflector) { }

    canActivate(context: ExecutionContext): boolean {
        const roles = this.reflector.get<string[]>('roles', context.getHandler());
        if (!roles) {
            return true;
        }
        const request = context.switchToHttp().getRequest();
        const user = request.user;
        return roles.some(role => user.rol === role);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\clients\dto\create-client.dto.ts
================================================================

import { ApiProperty } from '@nestjs/swagger';

export class CreateClientDto {
    @ApiProperty({ example: 'Juan', description: 'Primer nombre del cliente' })
    nombre1: string;

    @ApiProperty({ example: 'Andres', description: 'Segundo nombre del cliente', required: false })
    nombre2?: string;

    @ApiProperty({ example: 'Perez', description: 'Primer apellido del cliente' })
    apellido1: string;

    @ApiProperty({ example: 'Gonzalez', description: 'Segundo apellido del cliente', required: false })
    apellido2?: string;

    @ApiProperty({ example: '12.345.678-9', description: 'RUT del cliente' })
    rut: string;

    @ApiProperty({ example: 'juan.perez@example.com', description: 'Email del cliente' })
    email: string;

    @ApiProperty({ example: '+56912345678', description: 'TelÃ©fono del cliente', required: false })
    telefono?: string;

    @ApiProperty({ example: '1985-05-15', description: 'Fecha de nacimiento', required: false })
    fechaNacimiento?: Date;

    @ApiProperty({ example: 'Casado', description: 'Estado civil', required: false })
    estadoCivil?: string;

    @ApiProperty({ example: 'Ingeniero', description: 'ProfesiÃ³n', required: false })
    profesion?: string;

    @ApiProperty({ example: 1500000, description: 'Renta mensual', required: false })
    renta?: number;

    @ApiProperty({ example: 'Chilena', description: 'Nacionalidad', required: false })
    nacionalidad?: string;

    @ApiProperty({ example: 'Av. Libertador', description: 'Calle de direcciÃ³n', required: false })
    direccionCalle?: string;

    @ApiProperty({ example: '1234', description: 'NÃºmero de direcciÃ³n', required: false })
    direccionNumero?: string;

    @ApiProperty({ example: 'Santiago', description: 'Comuna', required: false })
    direccionComuna?: string;

    @ApiProperty({ example: 'Santiago', description: 'Ciudad', required: false })
    direccionCiudad?: string;

    @ApiProperty({ example: 'Metropolitana', description: 'RegiÃ³n', required: false })
    direccionRegion?: string;

    @ApiProperty({ example: 'Chile', description: 'PaÃ­s', required: false })
    direccionPais?: string;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\clients\clients.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { ClientsController } from './clients.controller';

describe('ClientsController', () => {
  let controller: ClientsController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [ClientsController],
    }).compile();

    controller = module.get<ClientsController>(ClientsController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\clients\clients.controller.ts
================================================================

import { Controller, Get, Post, Body, Param, Patch, Query, UseGuards } from '@nestjs/common';
import { ClientsService } from './clients.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';

@Controller('clients')
@UseGuards(JwtAuthGuard, RolesGuard)
export class ClientsController {
    constructor(private readonly clientsService: ClientsService) { }

    @Post()
    @Roles('Agente', 'Broker', 'Admin')
    create(@Body() createClientDto: any) {
        return this.clientsService.create(createClientDto);
    }

    @Get()
    @Roles('Agente', 'Broker', 'Admin')
    findAll(@Query('search') search: string) {
        return this.clientsService.findAll(search);
    }

    @Get(':id')
    @Roles('Agente', 'Broker', 'Admin')
    findOne(@Param('id') id: string) {
        return this.clientsService.findOne(+id);
    }

    @Patch(':id')
    @Roles('Agente', 'Broker', 'Admin')
    update(@Param('id') id: string, @Body() updateClientDto: any) {
        return this.clientsService.update(+id, updateClientDto);
    }

    @Post(':id/documents')
    @Roles('Agente', 'Broker', 'Admin')
    addDocument(@Param('id') id: string, @Body() documentDto: any) {
        return this.clientsService.addDocument(+id, documentDto);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\clients\clients.module.ts
================================================================

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ClientsService } from './clients.service';
import { ClientsController } from './clients.controller';
import { Cliente } from '../entities/cliente.entity';
import { DocumentoCliente } from '../entities/documento-cliente.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Cliente, DocumentoCliente])],
  controllers: [ClientsController],
  providers: [ClientsService],
})
export class ClientsModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\clients\clients.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { ClientsService } from './clients.service';

describe('ClientsService', () => {
  let service: ClientsService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [ClientsService],
    }).compile();

    service = module.get<ClientsService>(ClientsService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\clients\clients.service.ts
================================================================

import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, Like } from 'typeorm';
import { Cliente } from '../entities/cliente.entity';
import { DocumentoCliente } from '../entities/documento-cliente.entity';

@Injectable()
export class ClientsService {
    constructor(
        @InjectRepository(Cliente)
        private clientsRepository: Repository<Cliente>,
        @InjectRepository(DocumentoCliente)
        private documentsRepository: Repository<DocumentoCliente>,
    ) { }

    async create(createClientDto: Partial<Cliente>): Promise<Cliente> {
        const newClient = this.clientsRepository.create(createClientDto);
        return this.clientsRepository.save(newClient);
    }

    async findAll(search?: string): Promise<Cliente[]> {
        if (search) {
            return this.clientsRepository.find({
                where: [
                    { nombreCompleto: Like(`%${search}%`) },
                    { rut: Like(`%${search}%`) },
                ],
            });
        }
        return this.clientsRepository.find();
    }

    async findOne(id: number): Promise<Cliente> {
        const client = await this.clientsRepository.findOne({
            where: { id },
            relations: ['documentos'],
        });
        if (!client) {
            throw new NotFoundException(`Client with ID ${id} not found`);
        }
        return client;
    }

    async update(id: number, updateClientDto: Partial<Cliente>): Promise<Cliente> {
        const client = await this.findOne(id);
        this.clientsRepository.merge(client, updateClientDto);
        return this.clientsRepository.save(client);
    }

    async addDocument(clientId: number, document: Partial<DocumentoCliente>): Promise<DocumentoCliente> {
        const newDoc = this.documentsRepository.create({ ...document, clienteId: clientId });
        return this.documentsRepository.save(newDoc);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\commissions\commissions.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { CommissionsController } from './commissions.controller';

describe('CommissionsController', () => {
  let controller: CommissionsController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [CommissionsController],
    }).compile();

    controller = module.get<CommissionsController>(CommissionsController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\commissions\commissions.controller.ts
================================================================

import { Controller, Get, Post, Patch, Param, UseGuards, Request, Body } from '@nestjs/common';
import { CommissionsService } from './commissions.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';

@Controller('commissions')
@UseGuards(JwtAuthGuard, RolesGuard)
export class CommissionsController {
    constructor(private readonly commissionsService: CommissionsService) { }

    @Post('calculate/:fichaId')
    @Roles('Admin', 'Contabilidad')
    calculate(@Param('fichaId') fichaId: string) {
        return this.commissionsService.calculateCommission(+fichaId);
    }

    @Patch(':fichaId/status')
    @Roles('Admin', 'Contabilidad')
    updateStatus(@Param('fichaId') fichaId: string, @Body('status') status: string) {
        return this.commissionsService.updateCommissionStatus(+fichaId, status);
    }

    @Get('my')
    @Roles('Broker')
    getMyCommissions(@Request() req) {
        return this.commissionsService.getCommissions(req.user.userId);
    }

    @Get('all')
    @Roles('Admin', 'Contabilidad')
    getAll() {
        return this.commissionsService.getCommissions();
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\commissions\commissions.module.ts
================================================================

import { Module } from '@nestjs/common';
import { CommissionsService } from './commissions.service';
import { CommissionsController } from './commissions.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { Usuario } from '../entities/usuario.entity';

@Module({
  imports: [TypeOrmModule.forFeature([FichaVenta, Usuario])],
  providers: [CommissionsService],
  controllers: [CommissionsController]
})
export class CommissionsModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\commissions\commissions.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { CommissionsService } from './commissions.service';

describe('CommissionsService', () => {
  let service: CommissionsService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [CommissionsService],
    }).compile();

    service = module.get<CommissionsService>(CommissionsService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\commissions\commissions.service.ts
================================================================

import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { Usuario } from '../entities/usuario.entity';
import { UserRole } from '../auth/roles.enum';

@Injectable()
export class CommissionsService {
    constructor(
        @InjectRepository(FichaVenta)
        private fichaRepository: Repository<FichaVenta>,
        @InjectRepository(Usuario)
        private usuarioRepository: Repository<Usuario>,
    ) { }

    async calculateCommission(fichaId: number): Promise<FichaVenta> {
        const ficha = await this.fichaRepository.findOne({ where: { id: fichaId } });
        if (!ficha) throw new NotFoundException('Ficha no encontrada');

        const agent = await this.usuarioRepository.findOne({ where: { id: ficha.agenteId } });
        if (!agent || agent.rol !== UserRole.BROKER_EXTERNO) {
            // If not a broker, we might still want to set commission to 0 or handle differently.
            // For now, we just return the ficha without changes if not a broker.
            return ficha;
        }

        // Fixed 2% commission for Brokers
        const porcentaje = 2.0;
        const monto = (ficha.valorTotalUf * porcentaje) / 100;

        ficha.comisionBrokerMonto = monto;
        ficha.estadoComisionBroker = 'Pendiente';

        return this.fichaRepository.save(ficha);
    }

    async updateCommissionStatus(fichaId: number, status: string): Promise<FichaVenta> {
        const ficha = await this.fichaRepository.findOne({ where: { id: fichaId } });
        if (!ficha) throw new NotFoundException('Ficha no encontrada');

        const validStatuses = ['Pendiente', 'Solicitar Factura', 'Factura Recibida', 'Pagada'];
        if (!validStatuses.includes(status)) {
            throw new BadRequestException('Estado de comisiÃ³n invÃ¡lido');
        }

        ficha.estadoComisionBroker = status;
        return this.fichaRepository.save(ficha);
    }

    async getCommissions(brokerId?: number): Promise<FichaVenta[]> {
        const query = this.fichaRepository.createQueryBuilder('ficha')
            .leftJoinAndSelect('ficha.unidad', 'unidad')
            .leftJoinAndSelect('ficha.agente', 'agente')
            .where('ficha.comisionBrokerMonto > 0');

        if (brokerId) {
            query.andWhere('ficha.agenteId = :brokerId', { brokerId });
        }

        return query.getMany();
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\dashboard\dashboard.controller.ts
================================================================

import { Controller, Get, UseGuards } from '@nestjs/common';
import { DashboardService } from './dashboard.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';
import { UserRole } from '../auth/roles.enum';

@Controller('dashboard')
@UseGuards(JwtAuthGuard, RolesGuard)
export class DashboardController {
    constructor(private readonly dashboardService: DashboardService) { }

    @Get('kpis')
    @Roles(UserRole.GERENCIA, UserRole.ADMIN)
    async getKPIs() {
        return this.dashboardService.getKPIs();
    }

    @Get('sales-by-broker')
    @Roles(UserRole.GERENCIA, UserRole.ADMIN)
    async getSalesByBroker() {
        return this.dashboardService.getSalesByBroker();
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\dashboard\dashboard.module.ts
================================================================

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { DashboardController } from './dashboard.controller';
import { DashboardService } from './dashboard.service';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { Cuota } from '../entities/cuota.entity';
import { GuaranteedRentBenefit } from '../entities/guaranteed-rent-benefit.entity';

@Module({
    imports: [TypeOrmModule.forFeature([FichaVenta, Cuota, GuaranteedRentBenefit])],
    controllers: [DashboardController],
    providers: [DashboardService],
})
export class DashboardModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\dashboard\dashboard.service.ts
================================================================

import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, Between, LessThan } from 'typeorm';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { Cuota } from '../entities/cuota.entity';
import { GuaranteedRentBenefit } from '../entities/guaranteed-rent-benefit.entity';
import { EstadoFicha } from '../sales/enums/estado-ficha.enum';

@Injectable()
export class DashboardService {
    constructor(
        @InjectRepository(FichaVenta)
        private fichaRepository: Repository<FichaVenta>,
        @InjectRepository(Cuota)
        private cuotaRepository: Repository<Cuota>,
        @InjectRepository(GuaranteedRentBenefit)
        private benefitRepository: Repository<GuaranteedRentBenefit>,
    ) { }

    async getKPIs() {
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        // 1. Ventas del Mes
        const ventasMes = await this.fichaRepository.count({
            where: {
                createdAt: Between(firstDayOfMonth, lastDayOfMonth),
                estadoFicha: EstadoFicha.PROMESA // Assuming approved sales are Promesa
            }
        });

        // 2. Monto Total Fundit Colocado
        const funditSales = await this.fichaRepository.find({
            where: { hasFundit: true, estadoFicha: EstadoFicha.PROMESA },
            select: ['creditoFunditMonto']
        });
        const totalFundit = funditSales.reduce((sum, sale) => sum + Number(sale.creditoFunditMonto || 0), 0);

        // 3. Cuotas Atrasadas
        const cuotasAtrasadas = await this.cuotaRepository.count({
            where: {
                estado: 'Pendiente',
                fechaVencimiento: LessThan(now)
            }
        });

        // 4. Propiedades en Arriendo Garantizado
        const activeBenefits = await this.benefitRepository.count({
            where: { active: true }
        });

        return {
            ventasMes,
            totalFundit,
            cuotasAtrasadas,
            activeBenefits
        };
    }

    async getSalesByBroker() {
        // Group sales by broker and count
        const sales = await this.fichaRepository
            .createQueryBuilder('ficha')
            .leftJoinAndSelect('ficha.usuario', 'usuario')
            .select('usuario.nombre', 'name')
            .addSelect('COUNT(ficha.id)', 'value')
            .where('ficha.estadoFicha = :status', { status: EstadoFicha.PROMESA })
            .groupBy('usuario.nombre')
            .getRawMany();

        return sales;
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\documents\documents.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { DocumentsController } from './documents.controller';

describe('DocumentsController', () => {
  let controller: DocumentsController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [DocumentsController],
    }).compile();

    controller = module.get<DocumentsController>(DocumentsController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\documents\documents.controller.ts
================================================================

import { Controller, Get, Param, Res, UseGuards } from '@nestjs/common';
import { DocumentsService } from './documents.service';
import type { Response } from 'express';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';

@Controller('documents')
@UseGuards(JwtAuthGuard, RolesGuard)
export class DocumentsController {
    constructor(private readonly documentsService: DocumentsService) { }

    @Get('promesa/:id')
    @Roles('Agente', 'Broker', 'Admin')
    async downloadPromesa(@Param('id') id: string, @Res() res: Response) {
        const buffer = await this.documentsService.generatePromesa(+id);

        res.set({
            'Content-Type': 'application/pdf',
            'Content-Disposition': `attachment; filename=promesa-${id}.pdf`,
            'Content-Length': buffer.length,
        });

        res.end(buffer);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\documents\documents.module.ts
================================================================

import { Module } from '@nestjs/common';
import { DocumentsService } from './documents.service';
import { DocumentsController } from './documents.controller';
import { SalesModule } from '../sales/sales.module';

@Module({
  imports: [SalesModule],
  providers: [DocumentsService],
  controllers: [DocumentsController]
})
export class DocumentsModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\documents\documents.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { DocumentsService } from './documents.service';

describe('DocumentsService', () => {
  let service: DocumentsService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [DocumentsService],
    }).compile();

    service = module.get<DocumentsService>(DocumentsService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\documents\documents.service.ts
================================================================

import { Injectable, NotFoundException } from '@nestjs/common';
import PDFDocument = require('pdfkit');
import { SalesService } from '../sales/sales.service';

@Injectable()
export class DocumentsService {
    constructor(private salesService: SalesService) { }

    async generatePromesa(fichaId: number): Promise<Buffer> {
        const ficha = await this.salesService.findOne(fichaId) as any;
        if (!ficha) throw new NotFoundException('Ficha no encontrada');

        return new Promise((resolve) => {
            const doc = new PDFDocument();
            const buffers: Buffer[] = [];

            doc.on('data', buffers.push.bind(buffers));
            doc.on('end', () => {
                resolve(Buffer.concat(buffers));
            });

            // Header
            doc.fontSize(20).text('PROMESA DE COMPRAVENTA', { align: 'center' });
            doc.moveDown();

            // Content
            doc.fontSize(12).text(`En Santiago, a ${new Date().toLocaleDateString()}, comparecen:`);
            doc.moveDown();

            doc.text(`VENDEDOR: INMOBILIARIA EJEMPLO S.A.`);
            doc.text(`COMPRADOR: ${ficha.clientePrincipal?.nombreCompleto || 'N/A'}, RUT: ${ficha.clientePrincipal?.rut || 'N/A'}`);
            doc.moveDown();

            doc.text(`PRIMERO: Por el presente acto, la Inmobiliaria promete vender y el Comprador promete comprar la unidad ${ficha.unidad.nombre} del proyecto ${ficha.unidad.proyecto.nombre}.`);
            doc.moveDown();

            doc.text(`SEGUNDO: El precio de la venta es de ${ficha.valorTotalUf} UF.`);
            doc.moveDown();

            doc.text('TERCERO: Forma de pago:');
            const plan = ficha.planesPago[0];
            if (plan) {
                doc.text(`- Pie: ${plan.montoPie} UF`);
                doc.text(`- Reserva: ${plan.montoReserva} UF`);
                doc.text(`- Saldo a financiar: ${plan.saldoAPagar} UF`);
            }
            doc.moveDown();

            doc.text('Firma Comprador: __________________________');
            doc.moveDown();
            doc.text('Firma Inmobiliaria: __________________________');

            doc.end();
        });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\adicional.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn, Index } from 'typeorm';
import { Proyecto } from './proyecto.entity';

@Entity('adicionales')
@Index(['proyecto', 'tipo', 'nombre'], { unique: true })
export class Adicional {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'proyecto_id' })
    proyectoId: number;

    @ManyToOne(() => Proyecto, (proyecto) => proyecto.adicionales, { onDelete: 'RESTRICT' })
    @JoinColumn({ name: 'proyecto_id' })
    proyecto: Proyecto;

    @Column()
    tipo: string; // 'Bodega', 'Estacionamiento', 'Bicicletero'

    @Column()
    nombre: string;

    @Column({ name: 'valor_uf', type: 'decimal', precision: 10, scale: 2 })
    valorUf: number;

    @Column({ default: 'Disponible' })
    estado: string; // 'Disponible', 'Asignado', 'Vendido'

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\broker-company.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, OneToMany, CreateDateColumn } from 'typeorm';
import { Usuario } from './usuario.entity';

@Entity('broker_companies')
export class BrokerCompany {
    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    nombre: string;

    @Column({ nullable: true })
    rut: string;

    @Column({ nullable: true })
    direccion: string;

    @Column({ nullable: true })
    contacto_nombre: string;

    @Column({ nullable: true })
    contacto_email: string;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;

    @OneToMany(() => Usuario, (usuario) => usuario.brokerCompany)
    usuarios: Usuario[];
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\broker-proyecto.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, Index } from 'typeorm';
import { Usuario } from './usuario.entity';
import { Proyecto } from './proyecto.entity';

@Entity('broker_proyectos')
@Index(['broker', 'proyecto'], { unique: true })
export class BrokerProyecto {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'broker_id' })
    brokerId: number;

    @ManyToOne(() => Usuario, (usuario) => usuario.proyectosAsignados, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'broker_id' })
    broker: Usuario;

    @Column({ name: 'proyecto_id' })
    proyectoId: number;

    @ManyToOne(() => Proyecto, (proyecto) => proyecto.brokersAsignados, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'proyecto_id' })
    proyecto: Proyecto;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\cliente.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, OneToMany, Index } from 'typeorm';
import { DocumentoCliente } from './documento-cliente.entity';
import { FichaCliente } from './ficha-cliente.entity';

@Entity('clientes')
export class Cliente {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'nombre_1', nullable: true })
    nombre1: string;

    @Column({ name: 'nombre_2', nullable: true })
    nombre2: string;

    @Column({ name: 'apellido_1', nullable: true })
    apellido1: string;

    @Column({ name: 'apellido_2', nullable: true })
    apellido2: string;

    @Column({ name: 'nombre_completo', nullable: true })
    nombreCompleto: string;

    @Column({ unique: true })
    @Index()
    rut: string;

    @Column()
    email: string;

    @Column({ nullable: true })
    telefono: string;

    @Column({ name: 'fecha_nacimiento', type: 'date', nullable: true })
    fechaNacimiento: Date;

    @Column({ name: 'estado_civil', nullable: true })
    estadoCivil: string;

    @Column({ nullable: true })
    profesion: string;

    @Column({ nullable: true })
    renta: number;

    @Column({ nullable: true })
    nacionalidad: string;

    @Column({ name: 'direccion_calle', nullable: true })
    direccionCalle: string;

    @Column({ name: 'direccion_numero', nullable: true })
    direccionNumero: string;

    @Column({ name: 'direccion_comuna', nullable: true })
    direccionComuna: string;

    @Column({ name: 'direccion_ciudad', nullable: true })
    direccionCiudad: string;

    @Column({ name: 'direccion_region', nullable: true })
    direccionRegion: string;

    @Column({ name: 'direccion_pais', default: 'Chile', nullable: true })
    direccionPais: string;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;

    @OneToMany(() => DocumentoCliente, (doc) => doc.cliente)
    documentos: DocumentoCliente[];

    @OneToMany(() => FichaCliente, (fc) => fc.cliente)
    fichasAsociadas: FichaCliente[];
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\comision.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, CreateDateColumn, UpdateDateColumn } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';
import { Usuario } from './usuario.entity';

@Entity()
export class Comision {
    @PrimaryGeneratedColumn()
    id: number;

    @ManyToOne(() => FichaVenta)
    fichaVenta: FichaVenta;

    @ManyToOne(() => Usuario)
    broker: Usuario;

    @Column({ type: 'decimal', precision: 10, scale: 2 })
    monto: number;

    @Column({ type: 'decimal', precision: 5, scale: 2 })
    porcentaje: number;

    @Column({ default: 'Pendiente' })
    estado: string; // 'Pendiente', 'Pagada', 'Anulada'

    @Column({ type: 'date', nullable: true })
    fechaPago: Date;

    @CreateDateColumn()
    createdAt: Date;

    @UpdateDateColumn()
    updatedAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\cuota.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn, Index } from 'typeorm';
import { PlanPago } from './plan-pago.entity';

@Entity('cuotas')
export class Cuota {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'plan_pago_id' })
    @Index()
    planPagoId: number;

    @ManyToOne(() => PlanPago, (pp) => pp.cuotas, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'plan_pago_id' })
    planPago: PlanPago;

    @Column({ name: 'numero_cuota' })
    numeroCuota: number;

    @Column({ name: 'monto_cuota', type: 'decimal', precision: 12, scale: 2 })
    montoCuota: number;

    @Column({ name: 'fecha_vencimiento', type: 'date' })
    fechaVencimiento: Date;

    @Column({ default: 'Pendiente' })
    @Index()
    estado: string; // 'Pendiente', 'Pagada'

    @Column({ name: 'fecha_pago', type: 'date', nullable: true })
    fechaPago: Date;

    @Column({ name: 'comprobante_pago_url', nullable: true })
    comprobantePagoUrl: string;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\documento-cliente.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn, Index } from 'typeorm';
import { Cliente } from './cliente.entity';

@Entity('documentos_cliente')
export class DocumentoCliente {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'cliente_id' })
    @Index()
    clienteId: number;

    @ManyToOne(() => Cliente, (cliente) => cliente.documentos, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'cliente_id' })
    cliente: Cliente;

    @Column({ name: 'tipo_documento' })
    tipoDocumento: string;

    @Column({ name: 'url_s3', type: 'text' })
    urlS3: string;

    @Column({ name: 'estado_validacion', default: 'Pendiente' })
    estadoValidacion: string; // 'Pendiente', 'Aprobado', 'Rechazado'

    @Column({ name: 'observacion_rechazo', type: 'text', nullable: true })
    observacionRechazo: string;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\documento-venta.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn, Index } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';

@Entity('documentos_venta')
export class DocumentoVenta {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'ficha_venta_id' })
    @Index()
    fichaVentaId: number;

    @ManyToOne(() => FichaVenta, (fv) => fv.documentos, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'ficha_venta_id' })
    fichaVenta: FichaVenta;

    @Column({ name: 'tipo_documento' })
    tipoDocumento: string; // 'Acta de Entrega', 'Cuadratura Final', 'GarantÃ­as'

    @Column({ name: 'url_s3', type: 'text' })
    urlS3: string;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\entrega.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn, OneToOne, JoinColumn } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';

@Entity('entregas')
export class Entrega {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'ficha_id' })
    fichaId: number;

    @OneToOne(() => FichaVenta)
    @JoinColumn({ name: 'ficha_id' })
    fichaVenta: FichaVenta;

    @Column({ name: 'fecha_programada', type: 'date', nullable: true })
    fechaProgramada: Date;

    @Column({ name: 'fecha_real', type: 'timestamp', nullable: true })
    fechaReal: Date;

    @Column({ default: false })
    firmada: boolean;

    @Column({ type: 'text', nullable: true })
    observaciones: string;

    @CreateDateColumn({ name: 'created_at' })
    createdAt: Date;

    @UpdateDateColumn({ name: 'updated_at' })
    updatedAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\escritura.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn, OneToOne, JoinColumn } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';

@Entity('escrituras')
export class Escritura {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'ficha_id' })
    fichaId: number;

    @OneToOne(() => FichaVenta)
    @JoinColumn({ name: 'ficha_id' })
    fichaVenta: FichaVenta;

    @Column({ default: 'En RedacciÃ³n' })
    estado: string;

    @Column({ nullable: true })
    notaria: string;

    @Column({ name: 'repertorio', nullable: true })
    repertorio: string;

    @Column({ name: 'fecha_firma', type: 'date', nullable: true })
    fechaFirma: Date;

    @Column({ name: 'fecha_inscripcion', type: 'date', nullable: true })
    fechaInscripcion: Date;

    @Column({ type: 'text', nullable: true })
    observaciones: string;

    @CreateDateColumn({ name: 'created_at' })
    createdAt: Date;

    @UpdateDateColumn({ name: 'updated_at' })
    updatedAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\ficha-adicional.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, Index } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';
import { Adicional } from './adicional.entity';

@Entity('ficha_adicionales')
@Index(['fichaVenta', 'adicional'], { unique: true })
export class FichaAdicional {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'ficha_venta_id' })
    @Index()
    fichaVentaId: number;

    @ManyToOne(() => FichaVenta, (fv) => fv.adicionales, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'ficha_venta_id' })
    fichaVenta: FichaVenta;

    @Column({ name: 'adicional_id' })
    adicionalId: number;

    @ManyToOne(() => Adicional, { onDelete: 'RESTRICT' })
    @JoinColumn({ name: 'adicional_id' })
    adicional: Adicional;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\ficha-cliente.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, ManyToOne, JoinColumn, Index } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';
import { Cliente } from './cliente.entity';

@Entity('ficha_clientes')
@Index(['fichaVenta', 'cliente'], { unique: true })
export class FichaCliente {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'ficha_venta_id' })
    @Index()
    fichaVentaId: number;

    @ManyToOne(() => FichaVenta, (fv) => fv.clientes, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'ficha_venta_id' })
    fichaVenta: FichaVenta;

    @Column({ name: 'cliente_id' })
    @Index()
    clienteId: number;

    @ManyToOne(() => Cliente, (c) => c.fichasAsociadas, { onDelete: 'RESTRICT' })
    @JoinColumn({ name: 'cliente_id' })
    cliente: Cliente;

    @Column({ default: 'Principal' })
    rol: string; // 'Principal', 'Co-Comprador'
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\ficha-venta.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn, OneToMany, Index, OneToOne } from 'typeorm';
import { Unidad } from './unidad.entity';
import { Usuario } from './usuario.entity';
import { FichaCliente } from './ficha-cliente.entity';
import { FichaAdicional } from './ficha-adicional.entity';
import { DocumentoVenta } from './documento-venta.entity';
import { PlanPago } from './plan-pago.entity';
import { Escritura } from './escritura.entity';
import { Entrega } from './entrega.entity';

import { EstadoFicha } from '../sales/enums/estado-ficha.enum';

@Entity('fichas_venta')
export class FichaVenta {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ unique: true })
    folio: string;

    @Column({ name: 'unidad_id' })
    unidadId: number;

    @ManyToOne(() => Unidad, { onDelete: 'RESTRICT' })
    @JoinColumn({ name: 'unidad_id' })
    unidad: Unidad;

    @Column({ name: 'agente_id' })
    agenteId: number;

    @ManyToOne(() => Usuario, { onDelete: 'RESTRICT' })
    @JoinColumn({ name: 'agente_id' })
    agente: Usuario;

    @Column({ type: 'enum', enum: EstadoFicha, default: EstadoFicha.BORRADOR, name: 'estado_ficha' })
    @Index()
    estadoFicha: EstadoFicha;

    @Column({ name: 'valor_total_uf', type: 'decimal', precision: 12, scale: 2 })
    valorTotalUf: number;

    @Column({ name: 'descuento_porcentaje', type: 'decimal', precision: 5, scale: 2, nullable: true })
    descuentoPorcentaje: number;

    @Column({ name: 'valor_descuento_uf', type: 'decimal', precision: 12, scale: 2, default: 0 })
    valorDescuentoUf: number;

    @Column({ name: 'bono_pie', default: false })
    bonoPie: boolean;

    @Column({ name: 'credito_fundit_monto', type: 'decimal', precision: 12, scale: 2, default: 0 })
    creditoFunditMonto: number;

    @Column({ name: 'has_fundit', default: false })
    hasFundit: boolean;

    // Escritura
    @Column({ name: 'estado_escritura', default: 'Pendiente' })
    @Index()
    estadoEscritura: string;

    @Column({ name: 'banco_hipotecario', nullable: true })
    bancoHipotecario: string;

    @Column({ name: 'monto_hipotecario', type: 'decimal', precision: 12, scale: 2, default: 0 })
    montoHipotecario: number;

    @Column({ name: 'fecha_firma_escritura_cliente', type: 'date', nullable: true })
    fechaFirmaEscrituraCliente: Date;

    // Entrega
    @Column({ name: 'estado_entrega', default: 'Pendiente' })
    estadoEntrega: string;

    // ComisiÃ³n
    @Column({ name: 'comision_broker_monto', type: 'decimal', precision: 12, scale: 2, default: 0 })
    comisionBrokerMonto: number;

    @Column({ name: 'estado_comision_broker', default: 'Pendiente' })
    @Index()
    estadoComisionBroker: string;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;

    @OneToMany(() => FichaCliente, (fc) => fc.fichaVenta)
    clientes: FichaCliente[];

    @OneToMany(() => FichaAdicional, (fa) => fa.fichaVenta)
    adicionales: FichaAdicional[];

    @OneToMany(() => DocumentoVenta, (dv) => dv.fichaVenta)
    documentos: DocumentoVenta[];

    @OneToMany(() => PlanPago, (pp) => pp.fichaVenta)
    planesPago: PlanPago[];

    @OneToOne(() => Escritura, (e) => e.fichaVenta)
    escritura: Escritura;

    @OneToOne(() => Entrega, (e) => e.fichaVenta)
    entrega: Entrega;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\guaranteed-rent-benefit.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, OneToOne, JoinColumn } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';

@Entity('guaranteed_rent_benefits')
export class GuaranteedRentBenefit {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'ficha_venta_id' })
    fichaVentaId: number;

    @OneToOne(() => FichaVenta)
    @JoinColumn({ name: 'ficha_venta_id' })
    fichaVenta: FichaVenta;

    @Column({ name: 'duration_months' })
    durationMonths: number; // 24, 36, 48

    @Column({ name: 'monthly_amount', type: 'decimal', precision: 12, scale: 2 })
    monthlyAmount: number;

    @Column({ name: 'start_date', type: 'date' })
    startDate: Date;

    @Column({ name: 'end_date', type: 'date' })
    endDate: Date;

    @Column({ default: true })
    active: boolean;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\index.ts
================================================================

export * from './proyecto.entity';
export * from './unidad.entity';
export * from './adicional.entity';
export * from './usuario.entity';
export * from './broker-proyecto.entity';
export * from './cliente.entity';
export * from './documento-cliente.entity';
export * from './ficha-venta.entity';
export * from './ficha-cliente.entity';
export * from './ficha-adicional.entity';
export * from './documento-venta.entity';
export * from './plan-pago.entity';
export * from './cuota.entity';
export * from './escritura.entity';
export * from './entrega.entity';
export * from './comision.entity';
export * from './broker-company.entity';
export * from './guaranteed-rent-benefit.entity';
export * from './task.entity';



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\plan-pago.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn, OneToMany, Index } from 'typeorm';
import { FichaVenta } from './ficha-venta.entity';
import { Cuota } from './cuota.entity';

@Entity('planes_pago')
export class PlanPago {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'ficha_venta_id' })
    @Index()
    fichaVentaId: number;

    @ManyToOne(() => FichaVenta, (fv) => fv.planesPago, { onDelete: 'CASCADE' })
    @JoinColumn({ name: 'ficha_venta_id' })
    fichaVenta: FichaVenta;

    @Column({ name: 'tipo_plan' })
    tipoPlan: string; // 'PagarÃ©', 'Arriendo Garantizado', 'CrÃ©dito Directo'

    @Column({ name: 'monto_total', type: 'decimal', precision: 12, scale: 2 })
    montoTotal: number;

    @Column({ name: 'monto_pie', type: 'decimal', precision: 12, scale: 2, default: 0 })
    montoPie: number;

    @Column({ name: 'monto_reserva', type: 'decimal', precision: 12, scale: 2, default: 0 })
    montoReserva: number;

    @Column({ name: 'saldo_a_pagar', type: 'decimal', precision: 12, scale: 2, default: 0 })
    saldoAPagar: number;

    @Column({ name: 'numero_cuotas' })
    numeroCuotas: number;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;

    @OneToMany(() => Cuota, (cuota) => cuota.planPago)
    cuotas: Cuota[];
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\proyecto.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, OneToMany } from 'typeorm';
import { Unidad } from './unidad.entity';
import { Adicional } from './adicional.entity';
import { BrokerProyecto } from './broker-proyecto.entity';

@Entity('proyectos')
export class Proyecto {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ unique: true })
    nombre: string;

    @Column({ nullable: true })
    direccion: string;

    @Column({ nullable: true })
    comuna: string;

    @Column({ name: 'imagen_principal_url', type: 'text', nullable: true })
    imagenPrincipalUrl: string;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;

    @OneToMany(() => Unidad, (unidad) => unidad.proyecto)
    unidades: Unidad[];

    @OneToMany(() => Adicional, (adicional) => adicional.proyecto)
    adicionales: Adicional[];

    @OneToMany(() => BrokerProyecto, (bp) => bp.proyecto)
    brokersAsignados: BrokerProyecto[];
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\task.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, Index } from 'typeorm';

@Entity('tasks')
export class Task {
    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    title: string;

    @Column({ type: 'text', nullable: true })
    description: string;

    @Column({ default: 'Pendiente' })
    @Index()
    status: string; // 'Pendiente', 'En Progreso', 'Completada'

    @Column({ name: 'assigned_role', nullable: true })
    assignedRole: string; // 'Contabilidad', 'Gerencia', etc.

    @Column({ name: 'related_entity_id', nullable: true })
    relatedEntityId: number;

    @Column({ name: 'related_entity_type', nullable: true })
    relatedEntityType: string; // 'GuaranteedRentBenefit', etc.

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\unidad.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn, Index } from 'typeorm';
import { Proyecto } from './proyecto.entity';

@Entity('unidades')
@Index(['proyecto', 'nombre'], { unique: true })
export class Unidad {
    @PrimaryGeneratedColumn()
    id: number;

    @Column({ name: 'proyecto_id' })
    proyectoId: number;

    @ManyToOne(() => Proyecto, (proyecto) => proyecto.unidades, { onDelete: 'RESTRICT' })
    @JoinColumn({ name: 'proyecto_id' })
    proyecto: Proyecto;

    @Column({ length: 100 })
    nombre: string;

    @Column({ nullable: true })
    tipologia: string;

    @Column({ name: 'metros_cuadrados', type: 'decimal', precision: 10, scale: 2, nullable: true })
    metrosCuadrados: number;

    @Column({ default: 1 })
    piso: number;

    @Column({ name: 'valor_uf', type: 'decimal', precision: 12, scale: 2 })
    valorUf: number;

    @Column({ default: 'Disponible' })
    @Index()
    estado: string; // 'Disponible', 'Reservada', 'Vendida'

    @Column({ name: 'reserva_expira_en', type: 'timestamptz', nullable: true })
    reservaExpiraEn: Date;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\entities\usuario.entity.ts
================================================================

import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, OneToMany, ManyToOne, JoinColumn } from 'typeorm';
import { BrokerProyecto } from './broker-proyecto.entity';
import { BrokerCompany } from './broker-company.entity';
import { UserRole } from '../auth/roles.enum';

@Entity('usuarios')
export class Usuario {
    @PrimaryGeneratedColumn()
    id: number;

    @Column()
    nombre: string;

    @Column({ unique: true })
    email: string;

    @Column({ name: 'password_hash', type: 'text' })
    passwordHash: string;

    @Column({
        type: 'enum',
        enum: UserRole,
        default: UserRole.BROKER_EXTERNO
    })
    rol: UserRole;

    @CreateDateColumn({ name: 'created_at', type: 'timestamptz' })
    createdAt: Date;

    @OneToMany(() => BrokerProyecto, (bp) => bp.broker)
    proyectosAsignados: BrokerProyecto[];

    @Column({ name: 'broker_company_id', nullable: true })
    brokerCompanyId: number;

    @ManyToOne(() => BrokerCompany, (company) => company.usuarios, { nullable: true })
    @JoinColumn({ name: 'broker_company_id' })
    brokerCompany: BrokerCompany;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\finance\finance.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { FinanceController } from './finance.controller';

describe('FinanceController', () => {
  let controller: FinanceController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [FinanceController],
    }).compile();

    controller = module.get<FinanceController>(FinanceController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\finance\finance.controller.ts
================================================================

import { Controller, Get, Param, Patch, UseGuards } from '@nestjs/common';
import { FinanceService } from './finance.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';

@Controller('finance')
@UseGuards(JwtAuthGuard, RolesGuard)
export class FinanceController {
    constructor(private readonly financeService: FinanceService) { }

    @Get('fichas/:id/plan')
    @Roles('Admin', 'Contabilidad', 'Broker', 'Agente')
    getPlan(@Param('id') id: string) {
        return this.financeService.getPlanByFicha(+id);
    }

    @Patch('cuotas/:id/pay')
    @Roles('Admin', 'Contabilidad')
    markAsPaid(@Param('id') id: string) {
        return this.financeService.markCuotaAsPaid(+id);
    }

    @Get('fichas/:id/debt')
    @Roles('Admin', 'Contabilidad', 'Gerencia')
    getDebt(@Param('id') id: string) {
        return this.financeService.recalculateDebt(+id);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\finance\finance.module.ts
================================================================

import { Module } from '@nestjs/common';
import { FinanceService } from './finance.service';
import { FinanceController } from './finance.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { PlanPago } from '../entities/plan-pago.entity';
import { Cuota } from '../entities/cuota.entity';

@Module({
  imports: [TypeOrmModule.forFeature([PlanPago, Cuota])],
  providers: [FinanceService],
  controllers: [FinanceController]
})
export class FinanceModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\finance\finance.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { FinanceService } from './finance.service';

describe('FinanceService', () => {
  let service: FinanceService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [FinanceService],
    }).compile();

    service = module.get<FinanceService>(FinanceService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\finance\finance.service.ts
================================================================

import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { PlanPago } from '../entities/plan-pago.entity';
import { Cuota } from '../entities/cuota.entity';

@Injectable()
export class FinanceService {
    constructor(
        @InjectRepository(PlanPago)
        private planPagoRepository: Repository<PlanPago>,
        @InjectRepository(Cuota)
        private cuotaRepository: Repository<Cuota>,
    ) { }

    async getPlanByFicha(fichaId: number): Promise<PlanPago> {
        const plan = await this.planPagoRepository.findOne({
            where: { fichaVentaId: fichaId },
            relations: ['cuotas'],
            order: {
                cuotas: {
                    numeroCuota: 'ASC'
                }
            }
        });
        if (!plan) throw new NotFoundException('Plan de pago no encontrado');
        return plan;
    }

    async markCuotaAsPaid(cuotaId: number): Promise<Cuota> {
        const cuota = await this.cuotaRepository.findOne({ where: { id: cuotaId } });
        if (!cuota) throw new NotFoundException('Cuota no encontrada');

        cuota.estado = 'Pagada';
        cuota.fechaPago = new Date();
        return this.cuotaRepository.save(cuota);
    }
    async recalculateDebt(fichaId: number): Promise<{ totalDeuda: number, cuotasPendientes: number }> {
        const plan = await this.planPagoRepository.findOne({
            where: { fichaVentaId: fichaId },
            relations: ['cuotas']
        });

        if (!plan) throw new NotFoundException('Plan de pago no encontrado');

        const cuotasPendientes = plan.cuotas.filter(c => c.estado === 'Pendiente');
        const totalDeuda = cuotasPendientes.reduce((sum, c) => sum + Number(c.montoCuota), 0);

        // Update plan saldo
        plan.saldoAPagar = totalDeuda;
        await this.planPagoRepository.save(plan);

        return {
            totalDeuda,
            cuotasPendientes: cuotasPendientes.length
        };
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\post-sales\post-sales.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { PostSalesController } from './post-sales.controller';

describe('PostSalesController', () => {
  let controller: PostSalesController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [PostSalesController],
    }).compile();

    controller = module.get<PostSalesController>(PostSalesController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\post-sales\post-sales.controller.ts
================================================================

import { Controller, Get, Post, Patch, Body, Param, UseGuards } from '@nestjs/common';
import { PostSalesService } from './post-sales.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';

@Controller('post-sales')
@UseGuards(JwtAuthGuard, RolesGuard)
export class PostSalesController {
    constructor(private readonly postSalesService: PostSalesService) { }

    // Escritura Endpoints
    @Post('escrituras/:fichaId')
    @Roles('Admin', 'Contabilidad', 'Agente')
    createEscritura(@Param('fichaId') fichaId: string, @Body() data: any) {
        return this.postSalesService.createEscritura(+fichaId, data);
    }

    @Patch('escrituras/:id')
    @Roles('Admin', 'Contabilidad')
    updateEscritura(@Param('id') id: string, @Body() data: any) {
        return this.postSalesService.updateEscritura(+id, data);
    }

    @Get('escrituras/ficha/:fichaId')
    @Roles('Admin', 'Contabilidad', 'Agente', 'Broker')
    getEscritura(@Param('fichaId') fichaId: string) {
        return this.postSalesService.getEscrituraByFicha(+fichaId);
    }

    // Entrega Endpoints
    @Post('entregas/:fichaId/schedule')
    @Roles('Admin', 'Agente')
    scheduleEntrega(@Param('fichaId') fichaId: string, @Body('date') date: string) {
        return this.postSalesService.scheduleEntrega(+fichaId, new Date(date));
    }

    @Patch('entregas/:id/complete')
    @Roles('Admin', 'Agente')
    completeEntrega(@Param('id') id: string, @Body('observations') observations: string) {
        return this.postSalesService.completeEntrega(+id, observations);
    }

    @Get('entregas/ficha/:fichaId')
    @Roles('Admin', 'Agente', 'Broker')
    getEntrega(@Param('fichaId') fichaId: string) {
        return this.postSalesService.getEntregaByFicha(+fichaId);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\post-sales\post-sales.module.ts
================================================================

import { Module } from '@nestjs/common';
import { PostSalesService } from './post-sales.service';
import { PostSalesController } from './post-sales.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Escritura } from '../entities/escritura.entity';
import { Entrega } from '../entities/entrega.entity';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { GuaranteedRentBenefit } from '../entities/guaranteed-rent-benefit.entity';
import { Task } from '../entities/task.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Escritura, Entrega, FichaVenta, GuaranteedRentBenefit, Task])],
  providers: [PostSalesService],
  controllers: [PostSalesController]
})
export class PostSalesModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\post-sales\post-sales.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { PostSalesService } from './post-sales.service';

describe('PostSalesService', () => {
  let service: PostSalesService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [PostSalesService],
    }).compile();

    service = module.get<PostSalesService>(PostSalesService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\post-sales\post-sales.service.ts
================================================================

import { Injectable, NotFoundException, BadRequestException, Logger } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, LessThanOrEqual, MoreThanOrEqual } from 'typeorm';
import { Cron, CronExpression } from '@nestjs/schedule';
import { Escritura } from '../entities/escritura.entity';
import { Entrega } from '../entities/entrega.entity';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { GuaranteedRentBenefit } from '../entities/guaranteed-rent-benefit.entity';
import { Task } from '../entities/task.entity';

@Injectable()
export class PostSalesService {
    private readonly logger = new Logger(PostSalesService.name);

    constructor(
        @InjectRepository(Escritura)
        private escrituraRepository: Repository<Escritura>,
        @InjectRepository(Entrega)
        private entregaRepository: Repository<Entrega>,
        @InjectRepository(FichaVenta)
        private fichaRepository: Repository<FichaVenta>,
        @InjectRepository(GuaranteedRentBenefit)
        private benefitRepository: Repository<GuaranteedRentBenefit>,
        @InjectRepository(Task)
        private taskRepository: Repository<Task>,
    ) { }

    @Cron(CronExpression.EVERY_DAY_AT_MIDNIGHT)
    async checkGuaranteedRents() {
        this.logger.debug('Checking guaranteed rent benefits...');
        const today = new Date();

        // Find active benefits where today is within the range
        const activeBenefits = await this.benefitRepository.find({
            where: {
                active: true,
                startDate: LessThanOrEqual(today),
                endDate: MoreThanOrEqual(today),
            },
            relations: ['fichaVenta', 'fichaVenta.unidad'],
        });

        for (const benefit of activeBenefits) {
            // Check if payment is due today (e.g., same day of month as start date)
            if (today.getDate() === benefit.startDate.getDate()) {
                await this.createPaymentTask(benefit);
            }
        }
    }

    private async createPaymentTask(benefit: GuaranteedRentBenefit) {
        const task = new Task();
        task.title = `Pago Arriendo Garantizado - Ficha ${benefit.fichaVenta.folio} `;
        task.description = `Realizar pago de $${benefit.monthlyAmount} por unidad ${benefit.fichaVenta.unidad.nombre}.`;
        task.status = 'Pendiente';
        task.assignedRole = 'Contabilidad';
        task.relatedEntityId = benefit.id;
        task.relatedEntityType = 'GuaranteedRentBenefit';

        await this.taskRepository.save(task);
        this.logger.log(`Created payment task for benefit ${benefit.id}`);
    }

    // Escritura Methods
    async createEscritura(fichaId: number, data: Partial<Escritura>): Promise<Escritura> {
        const ficha = await this.fichaRepository.findOne({ where: { id: fichaId } });
        if (!ficha) throw new NotFoundException('Ficha no encontrada');

        const existing = await this.escrituraRepository.findOne({ where: { fichaVenta: { id: fichaId } } });
        if (existing) throw new BadRequestException('Ya existe una escritura para esta venta');

        const escritura = this.escrituraRepository.create({ ...data, fichaVenta: ficha });
        return this.escrituraRepository.save(escritura);
    }

    async updateEscritura(id: number, data: Partial<Escritura>): Promise<Escritura | null> {
        await this.escrituraRepository.update(id, data);
        return this.escrituraRepository.findOne({ where: { id } });
    }

    async getEscrituraByFicha(fichaId: number): Promise<Escritura | null> {
        return this.escrituraRepository.findOne({ where: { fichaVenta: { id: fichaId } } });
    }

    // Entrega Methods
    async scheduleEntrega(fichaId: number, date: Date): Promise<Entrega> {
        const ficha = await this.fichaRepository.findOne({ where: { id: fichaId } });
        if (!ficha) throw new NotFoundException('Ficha no encontrada');

        let entrega = await this.entregaRepository.findOne({ where: { fichaVenta: { id: fichaId } } });
        if (!entrega) {
            entrega = this.entregaRepository.create({ fichaVenta: ficha });
        }

        entrega.fechaProgramada = date;
        return this.entregaRepository.save(entrega);
    }

    async completeEntrega(id: number, observations: string): Promise<Entrega> {
        const entrega = await this.entregaRepository.findOne({ where: { id } });
        if (!entrega) throw new NotFoundException('Entrega no encontrada');

        entrega.fechaReal = new Date();
        entrega.observaciones = observations;
        entrega.firmada = true;
        return this.entregaRepository.save(entrega);
    }

    async getEntregaByFicha(fichaId: number): Promise<Entrega | null> {
        return this.entregaRepository.findOne({ where: { fichaVenta: { id: fichaId } } });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\projects\dto\inventory.dto.ts
================================================================

export interface UnitDTO {
    id: string;
    number: string;
    status: 'AVAILABLE' | 'RESERVED' | 'SOLD';
    typology: string; // e.g., "1D1B"
    area: number; // m2
    orientation: string; // e.g., "NE", "SW"
    price: number; // UF or CLP
}

export interface FloorDTO {
    floorNumber: number;
    units: UnitDTO[];
}

export interface BuildingResponseDTO {
    id: string;
    name: string;
    totalFloors: number;
    floorStructure: FloorDTO[];
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\projects\projects.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { ProjectsController } from './projects.controller';

describe('ProjectsController', () => {
  let controller: ProjectsController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [ProjectsController],
    }).compile();

    controller = module.get<ProjectsController>(ProjectsController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\projects\projects.controller.ts
================================================================

import { Controller, Get, Post, Body, Param, UseGuards } from '@nestjs/common';
import { ProjectsService } from './projects.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';

@Controller('projects')
// @UseGuards(JwtAuthGuard, RolesGuard) // Temporarily disabled for public access
export class ProjectsController {
    constructor(private readonly projectsService: ProjectsService) { }

    @Get()
    findAll() {
        return this.projectsService.findAll();
    }

    @Get(':id')
    findOne(@Param('id') id: string) {
        return this.projectsService.findOne(+id);
    }

    @Post()
    @Roles('Admin')
    create(@Body() createProjectDto: any) {
        return this.projectsService.create(createProjectDto);
    }

    @Post(':id/units')
    @Roles('Admin')
    createUnit(@Param('id') id: string, @Body() createUnitDto: any) {
        return this.projectsService.createUnit({ ...createUnitDto, proyectoId: +id });
    }

    @Get(':id/units')
    getUnits(@Param('id') id: string) {
        return this.projectsService.getUnitsByProject(+id);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\projects\projects.module.ts
================================================================

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ProjectsService } from './projects.service';
import { ProjectsController } from './projects.controller';
import { Proyecto } from '../entities/proyecto.entity';
import { Unidad } from '../entities/unidad.entity';
import { Adicional } from '../entities/adicional.entity';
import { BrokerProyecto } from '../entities/broker-proyecto.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Proyecto, Unidad, Adicional, BrokerProyecto])],
  controllers: [ProjectsController],
  providers: [ProjectsService],
})
export class ProjectsModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\projects\projects.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { ProjectsService } from './projects.service';

describe('ProjectsService', () => {
  let service: ProjectsService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [ProjectsService],
    }).compile();

    service = module.get<ProjectsService>(ProjectsService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\projects\projects.service.ts
================================================================

import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Proyecto } from '../entities/proyecto.entity';
import { Unidad } from '../entities/unidad.entity';

@Injectable()
export class ProjectsService {
    constructor(
        @InjectRepository(Proyecto)
        private projectsRepository: Repository<Proyecto>,
        @InjectRepository(Unidad)
        private unitsRepository: Repository<Unidad>,
    ) { }

    async findAll(): Promise<Proyecto[]> {
        return this.projectsRepository.find({ relations: ['unidades'] });
    }

    async findOne(id: number): Promise<Proyecto> {
        const project = await this.projectsRepository.findOne({
            where: { id },
            relations: ['unidades'],
        });
        if (!project) {
            throw new NotFoundException(`Project with ID ${id} not found`);
        }
        return project;
    }

    async create(proyecto: Partial<Proyecto>): Promise<Proyecto> {
        const newProject = this.projectsRepository.create(proyecto);
        return this.projectsRepository.save(newProject);
    }

    async createUnit(unit: Partial<Unidad>): Promise<Unidad> {
        const newUnit = this.unitsRepository.create(unit);
        return this.unitsRepository.save(newUnit);
    }

    async getUnitsByProject(projectId: number): Promise<Unidad[]> {
        return this.unitsRepository.find({ where: { proyectoId: projectId } });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\dto\cotizacion.dto.ts
================================================================

import { ApiProperty } from '@nestjs/swagger';

export class CotizacionItemDto {
    @ApiProperty()
    descripcion: string;

    @ApiProperty()
    valorUf: number;
}

export class CotizacionDto {
    @ApiProperty()
    clienteNombre: string;

    @ApiProperty()
    clienteRut: string;

    @ApiProperty()
    proyectoNombre: string;

    @ApiProperty()
    unidadNumero: string;

    @ApiProperty()
    unidadTipo: string;

    @ApiProperty()
    valorBaseUf: number;

    @ApiProperty({ required: false })
    descuentoPorcentaje?: number;

    @ApiProperty({ required: false })
    valorDescuentoUf?: number;

    @ApiProperty()
    valorConDescuentoUf: number;

    @ApiProperty({ required: false })
    valorEstacionamientoUf?: number;

    @ApiProperty({ required: false })
    valorBodegaUf?: number;

    @ApiProperty()
    subtotalUf: number;

    @ApiProperty({ required: false })
    valorAporteInmobiliariaUf?: number;

    @ApiProperty()
    valorTotalUf: number;

    @ApiProperty()
    formaPago: {
        reserva: number;
        ahorro: number;
        aporteInmobiliario: number;
        creditoFundit: number;
        creditoHipotecario: number;
    };

    @ApiProperty()
    fechaCotizacion: Date;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\dto\create-ficha-venta.dto.ts
================================================================

import { IsBoolean, IsNumber, IsOptional, IsObject, ValidateNested, Min, Max } from 'class-validator';
import { Type } from 'class-transformer';
import { ApiProperty } from '@nestjs/swagger';

export class FormaPagoDto {
    @ApiProperty({ description: 'Monto de reserva en UF' })
    @IsNumber()
    @Min(0)
    reserva: number;

    @ApiProperty({ description: 'Monto de ahorro/transferencia en UF' })
    @IsNumber()
    @Min(0)
    ahorro: number;

    @ApiProperty({ description: 'Monto de aporte inmobiliario en UF' })
    @IsNumber()
    @Min(0)
    aporteInmobiliario: number;

    @ApiProperty({ description: 'Monto de crÃ©dito Fundit en UF' })
    @IsNumber()
    @Min(0)
    creditoFundit: number;

    @ApiProperty({ description: 'Monto de crÃ©dito hipotecario en UF' })
    @IsNumber()
    @Min(0)
    creditoHipotecario: number;
}

export class CreateFichaVentaDto {
    @ApiProperty({ description: 'ID de la unidad' })
    @IsNumber()
    unidadId: number;

    @ApiProperty({ description: 'ID del cliente' })
    @IsNumber()
    clienteId: number;

    @ApiProperty({ description: 'Porcentaje de descuento (1-15%)', required: false })
    @IsOptional()
    @IsNumber()
    @Min(1)
    @Max(15)
    descuentoPorcentaje?: number;

    @ApiProperty({ description: 'Incluye estacionamiento' })
    @IsBoolean()
    incluyeEstacionamiento: boolean;

    @ApiProperty({ description: 'Incluye bodega' })
    @IsBoolean()
    incluyeBodega: boolean;

    @ApiProperty({ description: 'Usa aporte inmobiliaria' })
    @IsBoolean()
    usaAporteInmobiliaria: boolean;

    @ApiProperty({ description: 'Detalle de forma de pago' })
    @IsObject()
    @ValidateNested()
    @Type(() => FormaPagoDto)
    formaPago: FormaPagoDto;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\enums\estado-ficha.enum.ts
================================================================

export enum EstadoFicha {
    BORRADOR = 'Borrador',
    RESERVA = 'Reserva',
    PROMESA = 'Promesa',
    ESCRITURADO = 'Escriturado',
    VENCIDA = 'Vencida'
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\sales.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { SalesController } from './sales.controller';

describe('SalesController', () => {
  let controller: SalesController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [SalesController],
    }).compile();

    controller = module.get<SalesController>(SalesController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\sales.controller.ts
================================================================

import { Controller, Post, Body, UseGuards, Request, Get, Param } from '@nestjs/common';
import { SalesService } from './sales.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';
import { CreateFichaVentaDto } from './dto/create-ficha-venta.dto';
import { CotizacionDto } from './dto/cotizacion.dto';

@Controller('sales')
@UseGuards(JwtAuthGuard, RolesGuard)
export class SalesController {
    constructor(private readonly salesService: SalesService) { }

    @Post()
    @Roles('Agente', 'Broker', 'Admin')
    create(@Body() createFichaDto: CreateFichaVentaDto, @Request() req) {
        return this.salesService.createFicha(createFichaDto, req.user.userId);
    }

    @Post('cotizacion')
    @Roles('Agente', 'Broker', 'Admin')
    generateCotizacion(@Body() createFichaDto: CreateFichaVentaDto): Promise<CotizacionDto> {
        return this.salesService.generateCotizacion(createFichaDto);
    }

    @Get()
    @Roles('Agente', 'Broker', 'Admin')
    findAll() {
        return this.salesService.findAll();
    }

    @Get(':id')
    @Roles('Agente', 'Broker', 'Admin', 'Contabilidad')
    findOne(@Param('id') id: string) {
        return this.salesService.findOne(+id);
    }

    @Post(':id/approve')
    @Roles('Gerencia', 'Admin')
    approve(@Param('id') id: string) {
        return this.salesService.approveFicha(+id);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\sales.module.ts
================================================================

import { Module } from '@nestjs/common';
import { SalesService } from './sales.service';
import { SalesController } from './sales.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { Unidad } from '../entities/unidad.entity';
import { Cliente } from '../entities/cliente.entity';
import { FichaCliente } from '../entities/ficha-cliente.entity';
import { PlanPago } from '../entities/plan-pago.entity';
import { Cuota } from '../entities/cuota.entity';
import { FichaAdicional } from '../entities/ficha-adicional.entity';
import { Adicional } from '../entities/adicional.entity';
import { DocumentoVenta } from '../entities/documento-venta.entity';
import { Escritura } from '../entities/escritura.entity';
import { Entrega } from '../entities/entrega.entity';

@Module({
  imports: [TypeOrmModule.forFeature([FichaVenta, Unidad, Cliente, FichaCliente, PlanPago, Cuota, FichaAdicional, Adicional, DocumentoVenta, Escritura, Entrega])],
  providers: [SalesService],
  controllers: [SalesController],
  exports: [SalesService]
})
export class SalesModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\sales.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { SalesService } from './sales.service';

describe('SalesService', () => {
  let service: SalesService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [SalesService],
    }).compile();

    service = module.get<SalesService>(SalesService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\sales\sales.service.ts
================================================================

import { Injectable, BadRequestException, InternalServerErrorException, NotFoundException } from '@nestjs/common';
import { DataSource } from 'typeorm';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { Unidad } from '../entities/unidad.entity';
import { Cliente } from '../entities/cliente.entity';
import { FichaCliente } from '../entities/ficha-cliente.entity';
import { PlanPago } from '../entities/plan-pago.entity';
import { Cuota } from '../entities/cuota.entity';
import { EstadoFicha } from './enums/estado-ficha.enum';
import { CreateFichaVentaDto } from './dto/create-ficha-venta.dto';
import { CotizacionDto } from './dto/cotizacion.dto';
import { Adicional } from '../entities/adicional.entity';

@Injectable()
export class SalesService {
    constructor(private dataSource: DataSource) { }

    async createFicha(data: CreateFichaVentaDto, userId: number): Promise<FichaVenta> {
        const queryRunner = this.dataSource.createQueryRunner();

        await queryRunner.connect();
        await queryRunner.startTransaction();

        try {
            // 1. Verificar y Bloquear Unidad
            const unidad = await queryRunner.manager.findOne(Unidad, {
                where: { id: data.unidadId },
                lock: { mode: 'pessimistic_write' },
                relations: ['proyecto']
            });

            if (!unidad) {
                throw new BadRequestException('Unidad no encontrada');
            }

            if (unidad.estado !== 'Disponible') {
                throw new BadRequestException('La unidad ya no estÃ¡ disponible');
            }

            // Calculate Financials
            const valorBase = Number(unidad.valorUf);
            let descuentoMonto = 0;
            if (data.descuentoPorcentaje && data.descuentoPorcentaje > 0) {
                descuentoMonto = valorBase * (data.descuentoPorcentaje / 100);
            }
            const valorConDescuento = valorBase - descuentoMonto;

            let valorEstacionamiento = 0;
            let valorBodega = 0;

            // Logic to find available optionals (simplified: find first available)
            // In a real scenario, the user might select specific ones.
            // Here we just need the value for the calculation as per requirements.
            // However, to be correct, we should probably assign them if we are creating the sale.
            // For now, let's assume we just add the value if requested, and maybe assign later or find one now.
            // Let's try to find one now to be accurate on price.

            if (data.incluyeEstacionamiento) {
                const estacionamiento = await queryRunner.manager.findOne(Adicional, {
                    where: { proyectoId: unidad.proyectoId, tipo: 'Estacionamiento', estado: 'Disponible' }
                });
                if (estacionamiento) {
                    valorEstacionamiento = Number(estacionamiento.valorUf);
                    // We should probably reserve it too, but let's stick to the financial logic for now.
                    // If we don't reserve it, the price is just theoretical. 
                    // Let's assume for this task we just need the financial structure.
                }
            }

            if (data.incluyeBodega) {
                const bodega = await queryRunner.manager.findOne(Adicional, {
                    where: { proyectoId: unidad.proyectoId, tipo: 'Bodega', estado: 'Disponible' }
                });
                if (bodega) {
                    valorBodega = Number(bodega.valorUf);
                }
            }

            const subtotal = valorConDescuento + valorEstacionamiento + valorBodega;
            let aporteMonto = 0;
            if (data.usaAporteInmobiliaria) {
                aporteMonto = subtotal * 0.10;
            }

            const valorTotal = subtotal + aporteMonto;

            // Validate Payment Sum
            const formaPagoSum =
                Number(data.formaPago.reserva) +
                Number(data.formaPago.ahorro) +
                Number(data.formaPago.aporteInmobiliario) +
                Number(data.formaPago.creditoFundit) +
                Number(data.formaPago.creditoHipotecario);

            // Allow a small margin of error for floating point arithmetic
            if (Math.abs(formaPagoSum - valorTotal) > 0.01) {
                throw new BadRequestException(`La suma de la forma de pago (${formaPagoSum}) no coincide con el valor total (${valorTotal})`);
            }

            unidad.estado = 'Reservada';
            await queryRunner.manager.save(unidad);

            // 2. Crear Ficha Venta
            const ficha = new FichaVenta();
            ficha.folio = `F-${Date.now()}`;
            ficha.estadoFicha = EstadoFicha.BORRADOR;
            ficha.unidad = unidad;
            ficha.agenteId = userId;
            ficha.valorTotalUf = valorTotal;
            ficha.descuentoPorcentaje = data.descuentoPorcentaje || 0;
            ficha.valorDescuentoUf = descuentoMonto;
            ficha.bonoPie = data.usaAporteInmobiliaria; // Assuming bonoPie flag tracks usage of Aporte
            ficha.hasFundit = data.formaPago.creditoFundit > 0;
            ficha.creditoFunditMonto = data.formaPago.creditoFundit;
            ficha.montoHipotecario = data.formaPago.creditoHipotecario;

            const savedFicha = await queryRunner.manager.save(FichaVenta, ficha);

            // 3. Asociar Cliente (FichaCliente)
            const cliente = await queryRunner.manager.findOne(Cliente, { where: { id: data.clienteId } });
            if (!cliente) throw new BadRequestException('Cliente no encontrado');

            const fichaCliente = new FichaCliente();
            fichaCliente.fichaVenta = savedFicha;
            fichaCliente.cliente = cliente;
            fichaCliente.rol = 'Principal';
            await queryRunner.manager.save(FichaCliente, fichaCliente);

            // 4. Crear Plan de Pago (Simplified for now, storing the breakdown might need more structure)
            const plan = new PlanPago();
            plan.fichaVenta = savedFicha;
            plan.montoTotal = valorTotal;
            plan.montoPie = data.formaPago.ahorro; // Assuming ahorro is part of the pie
            plan.montoReserva = data.formaPago.reserva;
            plan.saldoAPagar = valorTotal - plan.montoPie - plan.montoReserva; // This logic might need adjustment based on full requirements
            plan.tipoPlan = 'Mixto'; // Or derive from payment method
            plan.numeroCuotas = 1;

            await queryRunner.manager.save(PlanPago, plan);

            await queryRunner.commitTransaction();
            return savedFicha;

        } catch (err) {
            await queryRunner.rollbackTransaction();
            throw new InternalServerErrorException(err.message);
        } finally {
            await queryRunner.release();
        }
    }

    async generateCotizacion(data: CreateFichaVentaDto): Promise<CotizacionDto> {
        const unidad = await this.dataSource.getRepository(Unidad).findOne({
            where: { id: data.unidadId },
            relations: ['proyecto']
        });
        if (!unidad) throw new BadRequestException('Unidad no encontrada');

        const cliente = await this.dataSource.getRepository(Cliente).findOne({ where: { id: data.clienteId } });
        if (!cliente) throw new BadRequestException('Cliente no encontrado');

        const valorBase = Number(unidad.valorUf);
        let descuentoMonto = 0;
        if (data.descuentoPorcentaje && data.descuentoPorcentaje > 0) {
            descuentoMonto = valorBase * (data.descuentoPorcentaje / 100);
        }
        const valorConDescuento = valorBase - descuentoMonto;

        let valorEstacionamiento = 0;
        if (data.incluyeEstacionamiento) {
            // Fetch generic price if not assigning specific one, or find one.
            const est = await this.dataSource.getRepository(Adicional).findOne({ where: { proyectoId: unidad.proyectoId, tipo: 'Estacionamiento' } });
            if (est) valorEstacionamiento = Number(est.valorUf);
        }
        let valorBodega = 0;
        if (data.incluyeBodega) {
            const bod = await this.dataSource.getRepository(Adicional).findOne({ where: { proyectoId: unidad.proyectoId, tipo: 'Bodega' } });
            if (bod) valorBodega = Number(bod.valorUf);
        }

        const subtotal = valorConDescuento + valorEstacionamiento + valorBodega;
        let aporteMonto = 0;
        if (data.usaAporteInmobiliaria) {
            aporteMonto = subtotal * 0.10;
        }
        const valorTotal = subtotal + aporteMonto;

        return {
            clienteNombre: cliente.nombreCompleto || `${cliente.nombre1} ${cliente.apellido1}`,
            clienteRut: cliente.rut,
            proyectoNombre: unidad.proyecto.nombre,
            unidadNumero: unidad.nombre,
            unidadTipo: unidad.tipologia,
            valorBaseUf: valorBase,
            descuentoPorcentaje: data.descuentoPorcentaje,
            valorDescuentoUf: descuentoMonto,
            valorConDescuentoUf: valorConDescuento,
            valorEstacionamientoUf: valorEstacionamiento,
            valorBodegaUf: valorBodega,
            subtotalUf: subtotal,
            valorAporteInmobiliariaUf: aporteMonto,
            valorTotalUf: valorTotal,
            formaPago: data.formaPago,
            fechaCotizacion: new Date()
        };
    }

    async findAll(): Promise<FichaVenta[]> {
        return this.dataSource.getRepository(FichaVenta).find({
            relations: ['unidad', 'clientes', 'clientes.cliente']
        });
    }

    async findOne(id: number): Promise<FichaVenta> {
        const ficha = await this.dataSource.getRepository(FichaVenta).findOne({
            where: { id },
            relations: ['unidad', 'clientes', 'clientes.cliente', 'planesPago', 'planesPago.cuotas']
        });
        if (!ficha) throw new NotFoundException('Venta no encontrada');
        return ficha;
    }
    async approveFicha(id: number): Promise<FichaVenta> {
        const queryRunner = this.dataSource.createQueryRunner();
        await queryRunner.connect();
        await queryRunner.startTransaction();

        try {
            const ficha = await queryRunner.manager.findOne(FichaVenta, { where: { id } });
            if (!ficha) throw new NotFoundException('Venta no encontrada');

            ficha.estadoFicha = EstadoFicha.PROMESA;
            await queryRunner.manager.save(FichaVenta, ficha);

            if (ficha.hasFundit) {
                const plan = new PlanPago();
                plan.fichaVenta = ficha;
                plan.tipoPlan = 'Fundit';
                plan.montoTotal = ficha.creditoFunditMonto;
                plan.numeroCuotas = 60;
                plan.saldoAPagar = ficha.creditoFunditMonto;
                plan.montoPie = 0;
                plan.montoReserva = 0;

                const savedPlan = await queryRunner.manager.save(PlanPago, plan);

                const cuotaValue = ficha.creditoFunditMonto / 60;
                const today = new Date();

                for (let i = 1; i <= 60; i++) {
                    const cuota = new Cuota();
                    cuota.planPago = savedPlan;
                    cuota.numeroCuota = i;
                    cuota.montoCuota = cuotaValue;

                    const vencimiento = new Date(today);
                    vencimiento.setMonth(vencimiento.getMonth() + i);
                    cuota.fechaVencimiento = vencimiento;

                    cuota.estado = 'Pendiente';
                    await queryRunner.manager.save(Cuota, cuota);
                }
            }

            await queryRunner.commitTransaction();
            return ficha;
        } catch (err) {
            await queryRunner.rollbackTransaction();
            throw new InternalServerErrorException(err.message);
        } finally {
            await queryRunner.release();
        }
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\tasks\tasks.module.ts
================================================================

import { Module } from '@nestjs/common';
import { TasksService } from './tasks.service';
import { ScheduleModule } from '@nestjs/schedule';
import { TypeOrmModule } from '@nestjs/typeorm';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { Unidad } from '../entities/unidad.entity';

@Module({
  imports: [
    ScheduleModule.forRoot(),
    TypeOrmModule.forFeature([Unidad, FichaVenta])
  ],
  providers: [TasksService]
})
export class TasksModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\tasks\tasks.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { TasksService } from './tasks.service';

describe('TasksService', () => {
  let service: TasksService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [TasksService],
    }).compile();

    service = module.get<TasksService>(TasksService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\tasks\tasks.service.ts
================================================================

import { Injectable, Logger } from '@nestjs/common';
import { Cron, CronExpression } from '@nestjs/schedule';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, LessThan } from 'typeorm';
import { Unidad } from '../entities/unidad.entity';
import { FichaVenta } from '../entities/ficha-venta.entity';
import { EstadoFicha } from '../sales/enums/estado-ficha.enum';

@Injectable()
export class TasksService {
    private readonly logger = new Logger(TasksService.name);

    constructor(
        @InjectRepository(Unidad)
        private unidadRepository: Repository<Unidad>,
        @InjectRepository(FichaVenta)
        private fichaVentaRepository: Repository<FichaVenta>,
    ) { }

    @Cron(CronExpression.EVERY_HOUR)
    async handleCron() {
        this.logger.debug('Checking for expired reservations...');

        const expirationDate = new Date();
        expirationDate.setHours(expirationDate.getHours() - 48);

        const expiredFichas = await this.fichaVentaRepository.find({
            where: {
                estadoFicha: EstadoFicha.BORRADOR,
                createdAt: LessThan(expirationDate),
            },
            relations: ['unidad'],
        });

        if (expiredFichas.length === 0) {
            this.logger.debug('No expired reservations found.');
            return;
        }

        this.logger.log(`Found ${expiredFichas.length} expired reservations. Processing...`);

        for (const ficha of expiredFichas) {
            // Update Ficha status
            ficha.estadoFicha = EstadoFicha.VENCIDA;
            await this.fichaVentaRepository.save(ficha);

            // Release Unit
            if (ficha.unidad) {
                ficha.unidad.estado = 'Disponible';
                await this.unidadRepository.save(ficha.unidad);
                this.logger.log(`Released unit ${ficha.unidad.nombre} from ficha ${ficha.folio}`);
            }
        }
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\users\users.controller.ts
================================================================

import { Controller, Get, UseGuards, Request, Param, ForbiddenException } from '@nestjs/common';
import { UsersService } from './users.service';
import { JwtAuthGuard } from '../auth/jwt-auth.guard';
import { RolesGuard } from '../auth/roles.guard';
import { Roles } from '../auth/roles.decorator';
import { UserRole } from '../auth/roles.enum';

@Controller('users')
@UseGuards(JwtAuthGuard, RolesGuard)
export class UsersController {
    constructor(private usersService: UsersService) { }

    @Get('profile')
    getProfile(@Request() req) {
        return req.user;
    }

    @Get()
    @Roles(UserRole.GERENCIA, UserRole.ADMIN)
    findAll() {
        return this.usersService.findAll();
    }

    @Get(':id')
    async findOne(@Param('id') id: string, @Request() req) {
        const user = await this.usersService.findOneById(+id);

        // Access Control Logic
        const isGerenciaOrAdmin = req.user.rol === UserRole.GERENCIA || req.user.rol === UserRole.ADMIN;
        const isOwnProfile = req.user.id === +id;

        if (!isGerenciaOrAdmin && !isOwnProfile) {
            throw new ForbiddenException('You can only view your own profile');
        }

        return user;
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\users\users.module.ts
================================================================

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { UsersService } from './users.service';
import { Usuario } from '../entities/usuario.entity';
import { BrokerCompany } from '../entities/broker-company.entity';
import { UsersController } from './users.controller';

@Module({
    imports: [TypeOrmModule.forFeature([Usuario, BrokerCompany])],
    controllers: [UsersController],
    providers: [UsersService],
    exports: [UsersService],
})
export class UsersModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\users\users.service.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { UsersService } from './users.service';

describe('UsersService', () => {
  let service: UsersService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [UsersService],
    }).compile();

    service = module.get<UsersService>(UsersService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\users\users.service.ts
================================================================

import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Usuario } from '../entities/usuario.entity';
import * as bcrypt from 'bcrypt';

@Injectable()
export class UsersService {
    constructor(
        @InjectRepository(Usuario)
        private usersRepository: Repository<Usuario>,
    ) { }

    async findOne(email: string): Promise<Usuario | null> {
        return this.usersRepository.findOne({ where: { email }, relations: ['brokerCompany'] });
    }

    async findOneById(id: number): Promise<Usuario | null> {
        return this.usersRepository.findOne({ where: { id }, relations: ['brokerCompany'] });
    }

    async findAll(): Promise<Usuario[]> {
        return this.usersRepository.find({ relations: ['brokerCompany'] });
    }

    async create(usuario: Partial<Usuario>): Promise<Usuario> {
        if (!usuario.passwordHash) {
            throw new Error('Password is required');
        }
        const salt = await bcrypt.genSalt();
        const passwordHash = await bcrypt.hash(usuario.passwordHash, salt);

        const newUser = this.usersRepository.create({
            ...usuario,
            passwordHash,
        });
        return this.usersRepository.save(newUser);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\app.controller.spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\app.controller.ts
================================================================

import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\app.module.ts
================================================================

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { UsersModule } from './users/users.module';
import { AuthModule } from './auth/auth.module';
import { ProjectsModule } from './projects/projects.module';
import { ClientsModule } from './clients/clients.module';
import { SalesModule } from './sales/sales.module';
import { FinanceModule } from './finance/finance.module';
import { DocumentsModule } from './documents/documents.module';
import { TasksModule } from './tasks/tasks.module';
import { PostSalesModule } from './post-sales/post-sales.module';
import { CommissionsModule } from './commissions/commissions.module';
import { DashboardModule } from './dashboard/dashboard.module';

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: 'postgres',
      host: 'localhost',
      port: 5433,
      username: 'postgres',
      password: 'Xav123qwe.',
      database: 'inmoapp_db',
      autoLoadEntities: true,
      synchronize: false,
    }),
    UsersModule,
    AuthModule,
    ProjectsModule,
    ClientsModule,
    SalesModule,
    FinanceModule,
    DocumentsModule,
    TasksModule,
    PostSalesModule,
    CommissionsModule,
    DashboardModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\app.service.ts
================================================================

import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\main.ts
================================================================

import { NestFactory } from '@nestjs/core';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Enable CORS for frontend
  app.enableCors({
    origin: 'http://localhost:4200',
    credentials: true,
  });

  const config = new DocumentBuilder()
    .setTitle('AppInmo API')
    .setDescription('The AppInmo API description')
    .setVersion('1.0')
    .build();
  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api/docs', app, document);

  await app.listen(process.env.PORT ?? 3000);
  console.log(`Application is running on: http://localhost:${process.env.PORT ?? 3000}`);
}
bootstrap();



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\src\seed.ts
================================================================

import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { getRepositoryToken } from '@nestjs/typeorm';
import { Unidad } from './entities/unidad.entity';
import { FichaVenta } from './entities/ficha-venta.entity';
import { BrokerCompany } from './entities/broker-company.entity';
import { Proyecto } from './entities/proyecto.entity';
import { Adicional } from './entities/adicional.entity';
import { Cliente } from './entities/cliente.entity';
import { FichaCliente } from './entities/ficha-cliente.entity';
import { FichaAdicional } from './entities/ficha-adicional.entity';
import { Usuario } from './entities/usuario.entity';
import { BrokerProyecto } from './entities/broker-proyecto.entity';
import { UserRole } from './auth/roles.enum';
import { Repository } from 'typeorm';
import { EstadoFicha } from './sales/enums/estado-ficha.enum';

async function bootstrap() {
    const app = await NestFactory.createApplicationContext(AppModule);

    // Inject Repositories
    const brokerCompanyRepo = app.get<Repository<BrokerCompany>>(getRepositoryToken(BrokerCompany));
    const proyectoRepo = app.get<Repository<Proyecto>>(getRepositoryToken(Proyecto));
    const unidadRepo = app.get<Repository<Unidad>>(getRepositoryToken(Unidad));
    const adicionalRepo = app.get<Repository<Adicional>>(getRepositoryToken(Adicional));
    const clienteRepo = app.get<Repository<Cliente>>(getRepositoryToken(Cliente));
    const fichaVentaRepo = app.get<Repository<FichaVenta>>(getRepositoryToken(FichaVenta));
    const fichaClienteRepo = app.get<Repository<FichaCliente>>(getRepositoryToken(FichaCliente));
    const fichaAdicionalRepo = app.get<Repository<FichaAdicional>>(getRepositoryToken(FichaAdicional));
    const usuarioRepo = app.get<Repository<Usuario>>(getRepositoryToken(Usuario));
    const brokerProyectoRepo = app.get<Repository<BrokerProyecto>>(getRepositoryToken(BrokerProyecto));

    console.log('Starting seed...');

    // ---------------------------------------------------------
    // 1. SETUP BÃSICO (Empresa y Broker)
    // ---------------------------------------------------------
    const companyRut = '77.077.181-0';
    let brokerCompany = await brokerCompanyRepo.findOne({ where: { rut: companyRut } });
    if (!brokerCompany) {
        console.log('Creating BrokerCompany...');
        brokerCompany = await brokerCompanyRepo.save({
            nombre: 'Inmobiliaria Vista San Martin SPA',
            rut: companyRut,
            direccion: 'San Martin (Referencial)',
            contacto_nombre: 'Contacto Inmobiliaria'
        });
    }

    const brokerEmail = 'contacto@vistasanmartin.cl';
    let brokerUser = await usuarioRepo.findOne({ where: { email: brokerEmail } });
    if (!brokerUser) {
        console.log('Creating Broker User...');
        brokerUser = await usuarioRepo.save({
            nombre: 'Vendedor Vista San Martin',
            email: brokerEmail,
            passwordHash: 'password123',
            rol: UserRole.BROKER_EXTERNO,
            brokerCompany: brokerCompany
        });
    }

    // ---------------------------------------------------------
    // 2. PROYECTO: Edificio Teatinos 750
    // ---------------------------------------------------------
    const projectName = "Edificio Teatinos 750";
    let proyecto = await proyectoRepo.findOne({ where: { nombre: projectName } });

    if (!proyecto) {
        console.log(`Creating Project: ${projectName}...`);
        proyecto = await proyectoRepo.save({
            nombre: projectName,
            direccion: "Teatinos 750, Santiago",
            comuna: "Santiago",
            imagenPrincipalUrl: "/uploads/teatinos-750.jpg"
            // Nota: El estado 'entrega_inmediata' no existe en la entidad Proyecto, se omite.
        });

        // Asignar broker al proyecto
        await brokerProyectoRepo.save({
            broker: brokerUser,
            proyecto: proyecto
        });
    } else {
        console.log(`Project ${projectName} already exists.`);
    }

    // ---------------------------------------------------------
    // 3. DATA DE ENTRADA (JSON)
    // ---------------------------------------------------------
    const teatinosData = [
        { "depto": "D-201", "estado": "OFERTA", "piso": "2", "precio": 2511.02, "cliente": "RAMIREZ CANCHICA RODHELLY KARINNA" },
        { "depto": "D-202", "estado": "BLOQUEADO", "piso": "2", "precio": 2654.88, "cliente": null },
        { "depto": "D-204", "estado": "BLOQUEADO", "piso": "2", "precio": 3273.96, "cliente": null },
        { "depto": "D-205", "estado": "BLOQUEADO", "piso": "2", "precio": 3447.53, "cliente": null },
        { "depto": "D-206", "estado": "BLOQUEADO", "piso": "2", "precio": 3324.01, "cliente": null },
        { "depto": "D-207", "estado": "BLOQUEADO", "piso": "2", "precio": 3263.31, "cliente": null },
        { "depto": "D-208", "estado": "BLOQUEADO", "piso": "2", "precio": 3246.29, "cliente": null },
        { "depto": "D-209", "estado": "OFERTA", "piso": "2", "precio": 3174.30, "cliente": "MARTINEZ MOLINA ESTEBAN ISRAEL" },
        { "depto": "D-210", "estado": "VENTA", "piso": "2", "precio": 3239.90, "cliente": null },
        { "depto": "D-211", "estado": "VENTA", "piso": "2", "precio": 3239.90, "cliente": null },
        { "depto": "D-212", "estado": "VENTA", "piso": "2", "precio": 3236.80, "cliente": null },
        { "depto": "D-304", "estado": "VENTA", "piso": "3", "precio": 3304.01, "cliente": null },
        { "depto": "D-305", "estado": "OFERTA", "piso": "3", "precio": 3435.52, "cliente": "ESCALONA ORDENES SEBASTIAN MATIAS" },
        { "depto": "D-306", "estado": "VENTA", "piso": "3", "precio": 3355.23, "cliente": null },
        { "depto": "D-307", "estado": "BLOQUEADO", "piso": "3", "precio": 3215.88, "cliente": null },
        { "depto": "D-308", "estado": "OFERTA", "piso": "3", "precio": 3117.70, "cliente": "RETAMAL BARAHONA MACARENA ISIDORA" },
        { "depto": "D-309", "estado": "OFERTA", "piso": "3", "precio": 3255.00, "cliente": "MARTINEZ MOLINA ESTEBAN ISRAEL" },
        { "depto": "D-310", "estado": "VENTA", "piso": "3", "precio": 3318.08, "cliente": null },
        { "depto": "D-311", "estado": "OFERTA", "piso": "3", "precio": 3673.42, "cliente": "PEREIRA GARRETON CRISTOBAL ROBERTO" },
        { "depto": "D-312", "estado": "OFERTA", "piso": "3", "precio": 3666.64, "cliente": "MEWES ACHONDO MARTIN LUIS" },
        { "depto": "D-404", "estado": "OFERTA", "piso": "4", "precio": 3243.90, "cliente": "TAPIA VASQUEZ FERNANDO PATRICIO" },
        { "depto": "D-405", "estado": "BLOQUEADO", "piso": "4", "precio": 3479.60, "cliente": null },
        { "depto": "D-406", "estado": "VENTA", "piso": "4", "precio": 3355.23, "cliente": null },
        { "depto": "D-407", "estado": "OFERTA", "piso": "4", "precio": 3338.98, "cliente": "GONZALEZ WOLF NATASCHA ALEJANDRA" },
        { "depto": "D-408", "estado": "BLOQUEADO", "piso": "4", "precio": 3324.53, "cliente": null },
        { "depto": "D-409", "estado": "OFERTA", "piso": "4", "precio": 3579.44, "cliente": "MAZO MEZA VALENTIN JOSE" },
        { "depto": "D-410", "estado": "OFERTA", "piso": "4", "precio": 2972.06, "cliente": "ROSENKRANZ MARTIN MARIA JESUS" },
        { "depto": "D-411", "estado": "OFERTA", "piso": "4", "precio": 3111.66, "cliente": "RETAMAL BARAHONA MACARENA ISIDORA" },
        { "depto": "D-412", "estado": "OFERTA", "piso": "4", "precio": 3311.44, "cliente": "MENDEZ MEDINA NOHELANY" },
        { "depto": "D-504", "estado": "BLOQUEADO", "piso": "5", "precio": 3334.87, "cliente": null },
        { "depto": "D-505", "estado": "OFERTA", "piso": "5", "precio": 3431.37, "cliente": "PAREDES ARANCIBIA CARLOS ALBERTO" },
        { "depto": "D-506", "estado": "VENTA", "piso": "5", "precio": 3386.44, "cliente": null },
        { "depto": "D-507", "estado": "BLOQUEADO", "piso": "5", "precio": 3369.80, "cliente": null },
        { "depto": "D-508", "estado": "OFERTA", "piso": "5", "precio": 3209.34, "cliente": "ALIAGA GODOY MACARENA FERNANDA" },
        { "depto": "D-509", "estado": "OFERTA", "piso": "5", "precio": 3553.89, "cliente": "PEREZ MALDONADO EDUARDO ANDRES" },
        { "depto": "D-510", "estado": "VENTA", "piso": "5", "precio": 3348.66, "cliente": null },
        { "depto": "D-511", "estado": "OFERTA", "piso": "5", "precio": 3684.36, "cliente": "UROCUR SOCIEDAD MEDICA LIMITADA" },
        { "depto": "D-512", "estado": "OFERTA", "piso": "5", "precio": 3730.84, "cliente": "OSSA OLLARZU MANUEL ALBERTO" },
        { "depto": "D-604", "estado": "OFERTA", "piso": "6", "precio": 3484.69, "cliente": "FIGUEROA TOLOSA LORETO ALEJANDRA" },
        { "depto": "D-605", "estado": "BLOQUEADO", "piso": "6", "precio": 3511.67, "cliente": null },
        { "depto": "D-606", "estado": "BLOQUEADO", "piso": "6", "precio": 3386.44, "cliente": null },
        { "depto": "D-607", "estado": "OFERTA", "piso": "6", "precio": 3369.74, "cliente": "BRICEÃ‘O MOYA JAVIERA PAZ" },
        { "depto": "D-608", "estado": "OFERTA", "piso": "6", "precio": 3711.29, "cliente": "ARANCIBIA FUENTES ROCIO MANUELA" },
        { "depto": "D-609", "estado": "OFERTA", "piso": "6", "precio": 3165.00, "cliente": "NEME ABUD JACQUELINE ANDREA" },
        { "depto": "D-610", "estado": "BLOQUEADO", "piso": "6", "precio": 3348.66, "cliente": null },
        { "depto": "D-611", "estado": "OFERTA", "piso": "6", "precio": 3649.29, "cliente": "SAAVEDRA ARIAS LEONARDO OCTAVIO" },
        { "depto": "D-612", "estado": "OFERTA", "piso": "6", "precio": 3398.56, "cliente": "MUÃ‘OZ DEL PINO DIEGO JAVIER" },
        { "depto": "D-704", "estado": "OFERTA", "piso": "7", "precio": 3302.29, "cliente": "GONZALEZ CALFUQUEO DAVID ESTEBAN" },
        { "depto": "D-705", "estado": "BLOQUEADO", "piso": "7", "precio": 3511.67, "cliente": null },
        { "depto": "D-706", "estado": "BLOQUEADO", "piso": "7", "precio": 3386.44, "cliente": null },
        { "depto": "D-707", "estado": "BLOQUEADO", "piso": "7", "precio": 3369.75, "cliente": null },
        { "depto": "D-708", "estado": "VENTA", "piso": "7", "precio": 3355.17, "cliente": null },
        { "depto": "D-709", "estado": "OFERTA", "piso": "7", "precio": 3165.00, "cliente": "LAGOS SOZA JOSE AGUSTIN" },
        { "depto": "D-710", "estado": "VENTA", "piso": "7", "precio": 3348.66, "cliente": null },
        { "depto": "D-711", "estado": "BLOQUEADO", "piso": "7", "precio": 3348.66, "cliente": null },
        { "depto": "D-712", "estado": "OFERTA", "piso": "7", "precio": 3309.12, "cliente": "ZUÃ‘IGA BAUMANN MARCO ANTONIO" },
        { "depto": "D-804", "estado": "VENTA", "piso": "8", "precio": 3365.32, "cliente": null },
        { "depto": "D-805", "estado": "OFERTA", "piso": "8", "precio": 3900.64, "cliente": "FERNANDEZ FELLAY DOMINGO" },
        { "depto": "D-806", "estado": "VENTA", "piso": "8", "precio": 3417.65, "cliente": null },
        { "depto": "D-807", "estado": "OFERTA", "piso": "8", "precio": 3459.51, "cliente": "MUÃ‘OZ DEL PINO DIEGO JAVIER" },
        { "depto": "D-808", "estado": "VENTA", "piso": "8", "precio": 3385.81, "cliente": null },
        { "depto": "D-809", "estado": "VENTA", "piso": "8", "precio": 3315.00, "cliente": null },
        { "depto": "D-810", "estado": "VENTA", "piso": "8", "precio": 3379.24, "cliente": null },
        { "depto": "D-811", "estado": "VENTA", "piso": "8", "precio": 3379.24, "cliente": null },
        { "depto": "D-812", "estado": "VENTA", "piso": "8", "precio": 3372.48, "cliente": null },
        { "depto": "D-904", "estado": "OFERTA", "piso": "9", "precio": 3000.24, "cliente": "RAMIREZ CANCHICA RODHELLY KARINNA" },
        { "depto": "D-905", "estado": "OFERTA", "piso": "9", "precio": 3510.58, "cliente": "FERNANDEZ FELLAY ERNESTO" },
        { "depto": "D-906", "estado": "VENTA", "piso": "9", "precio": 3417.65, "cliente": null },
        { "depto": "D-907", "estado": "OFERTA", "piso": "9", "precio": 3048.85, "cliente": "MELLADO MUÃ‘OZ FRANCISCO JAVIER" },
        { "depto": "D-908", "estado": "OFERTA", "piso": "9", "precio": 3760.91, "cliente": "BLASCHKE VILLALOBOS ERWIN IGNACIO" },
        { "depto": "D-909", "estado": "OFERTA", "piso": "9", "precio": 3195.00, "cliente": "LABBE BASCUÃ‘AN TOBIAS GUILLERMO" },
        { "depto": "D-910", "estado": "VENTA", "piso": "9", "precio": 3379.24, "cliente": null },
        { "depto": "D-911", "estado": "VENTA", "piso": "9", "precio": 3379.24, "cliente": null },
        { "depto": "D-912", "estado": "VENTA", "piso": "9", "precio": 3372.48, "cliente": null },
        { "depto": "D-1004", "estado": "VENTA", "piso": "10", "precio": 3365.32, "cliente": null },
        { "depto": "D-1005", "estado": "VENTA", "piso": "10", "precio": 3543.74, "cliente": null },
        { "depto": "D-1006", "estado": "VENTA", "piso": "10", "precio": 3417.65, "cliente": null },
        { "depto": "D-1007", "estado": "OFERTA", "piso": "10", "precio": 2949.69, "cliente": "CALDERON VELASCO GONZALO JOSE" },
        { "depto": "D-1008", "estado": "VENTA", "piso": "10", "precio": 3385.81, "cliente": null },
        { "depto": "D-1009", "estado": "OFERTA", "piso": "10", "precio": 3315.00, "cliente": "MARTINEZ MOLINA ESTEBAN ISRAEL" },
        { "depto": "D-1010", "estado": "VENTA", "piso": "10", "precio": 3379.24, "cliente": null },
        { "depto": "D-1011", "estado": "OFERTA", "piso": "10", "precio": 3329.30, "cliente": "BARAHONA CABEZAS FRANCISCA ALEJANDRA" },
        { "depto": "D-1012", "estado": "VENTA", "piso": "10", "precio": 3372.48, "cliente": null },
        { "depto": "D-1104", "estado": "OFERTA", "piso": "11", "precio": 3387.66, "cliente": "DONOSO SERRANO CATALINA" },
        { "depto": "D-1105", "estado": "VENTA", "piso": "11", "precio": 3543.74, "cliente": null },
        { "depto": "D-1106", "estado": "VENTA", "piso": "11", "precio": 3417.65, "cliente": null },
        { "depto": "D-1107", "estado": "OFERTA", "piso": "11", "precio": 3721.88, "cliente": "CAMPONOVO FERRARI ANTONIO OSCAR" },
        { "depto": "D-1108", "estado": "OFERTA", "piso": "11", "precio": 3353.90, "cliente": "BRANDT NAVARRO JUAN CARLOS" },
        { "depto": "D-1109", "estado": "OFERTA", "piso": "11", "precio": 3639.44, "cliente": "VICUÃ‘A SUTIL HERNAN" },
        { "depto": "D-1110", "estado": "OFERTA", "piso": "11", "precio": 3329.30, "cliente": "BARAHONA CABEZAS FRANCISCA ALEJANDRA" },
        { "depto": "D-1111", "estado": "OFERTA", "piso": "11", "precio": 3412.65, "cliente": "SOLAR DE LA BARRERA CRISTOBAL MATIAS" },
        { "depto": "D-1112", "estado": "VENTA", "piso": "11", "precio": 3372.48, "cliente": null },
        { "depto": "D-1204", "estado": "VENTA", "piso": "12", "precio": 3365.32, "cliente": null },
        { "depto": "D-1205", "estado": "OFERTA", "piso": "12", "precio": 3550.63, "cliente": "RODRIGUEZ CHAPARRO CESAR MAURICIO" },
        { "depto": "D-1206", "estado": "VENTA", "piso": "12", "precio": 3417.65, "cliente": null },
        { "depto": "D-1207", "estado": "VENTA", "piso": "12", "precio": 3400.53, "cliente": null },
        { "depto": "D-1208", "estado": "BLOQUEADO", "piso": "12", "precio": 3385.81, "cliente": null },
        { "depto": "D-1209", "estado": "OFERTA", "piso": "12", "precio": 3703.88, "cliente": "MARTINEZ MOLINA ESTEBAN ISRAEL" },
        { "depto": "D-1210", "estado": "OFERTA", "piso": "12", "precio": 3680.72, "cliente": "TAPIA AGUILAR RODRIGO MARCELO" },
        { "depto": "D-1211", "estado": "VENTA", "piso": "12", "precio": 3379.24, "cliente": null },
        { "depto": "D-1212", "estado": "BLOQUEADO", "piso": "12", "precio": 3372.48, "cliente": null },
        { "depto": "D-1304", "estado": "VENTA", "piso": "13", "precio": 3365.32, "cliente": null },
        { "depto": "D-1305", "estado": "VENTA", "piso": "13", "precio": 3543.74, "cliente": null },
        { "depto": "D-1306", "estado": "VENTA", "piso": "13", "precio": 3417.65, "cliente": null },
        { "depto": "D-1307", "estado": "VENTA", "piso": "13", "precio": 3400.53, "cliente": null },
        { "depto": "D-1308", "estado": "OFERTA", "piso": "13", "precio": 3299.51, "cliente": "ARAYA MARTINEZ JOSE ESTEBAN" },
        { "depto": "D-1309", "estado": "VENTA", "piso": "13", "precio": 3315.00, "cliente": null },
        { "depto": "D-1310", "estado": "VENTA", "piso": "13", "precio": 3379.24, "cliente": null },
        { "depto": "D-1311", "estado": "VENTA", "piso": "13", "precio": 3379.24, "cliente": null },
        { "depto": "D-1312", "estado": "VENTA", "piso": "13", "precio": 3372.48, "cliente": null },
        { "depto": "D-1404", "estado": "VENTA", "piso": "14", "precio": 3365.32, "cliente": null },
        { "depto": "D-1405", "estado": "VENTA", "piso": "14", "precio": 3543.74, "cliente": null },
        { "depto": "D-1406", "estado": "VENTA", "piso": "14", "precio": 3417.65, "cliente": null },
        { "depto": "D-1407", "estado": "OFERTA", "piso": "14", "precio": 3060.48, "cliente": "LINARES ESPITIA CINDY CAROLAYN" },
        { "depto": "D-1408", "estado": "VENTA", "piso": "14", "precio": 2969.56, "cliente": null },
        { "depto": "D-1409", "estado": "VENTA", "piso": "14", "precio": 3315.00, "cliente": null },
        { "depto": "D-1410", "estado": "OFERTA", "piso": "14", "precio": 3736.28, "cliente": "PRUDENCIO FLAÃ‘O SIMON" },
        { "depto": "D-1411", "estado": "VENTA", "piso": "14", "precio": 3379.24, "cliente": null },
        { "depto": "D-1412", "estado": "OFERTA", "piso": "14", "precio": 3729.38, "cliente": "GREGO PARRA KRISTIAN JURAJ" },
        { "depto": "D-1504", "estado": "OFERTA", "piso": "15", "precio": 3423.69, "cliente": "AMENABAR MANCILLA JOAQUIN ALFONSO" },
        { "depto": "D-1505", "estado": "OFERTA", "piso": "15", "precio": 3144.57, "cliente": "GALVEZ HERRERA MAURICIO ANDRES" },
        { "depto": "D-1506", "estado": "VENTA", "piso": "15", "precio": 3417.65, "cliente": null },
        { "depto": "D-1507", "estado": "OFERTA", "piso": "15", "precio": 3163.56, "cliente": "LEDEZMA FUENTEALBA CARLOS LUIS" },
        { "depto": "D-1508", "estado": "OFERTA", "piso": "15", "precio": 3779.04, "cliente": "RIVAS VESCO JORGE ENRIQUE" },
        { "depto": "D-1509", "estado": "VENTA", "piso": "15", "precio": 3315.00, "cliente": null },
        { "depto": "D-1510", "estado": "OFERTA", "piso": "15", "precio": 3736.28, "cliente": "AMENABAR MORENO EMILIO JOSE" },
        { "depto": "D-1511", "estado": "VENTA", "piso": "15", "precio": 3379.24, "cliente": null },
        { "depto": "D-1512", "estado": "BLOQUEADO", "piso": "15", "precio": 3372.48, "cliente": null },
        { "depto": "D-1604", "estado": "BLOQUEADO", "piso": "16", "precio": 3273.96, "cliente": null },
        { "depto": "D-1605", "estado": "VENTA", "piso": "16", "precio": 3447.50, "cliente": null },
        { "depto": "D-1606", "estado": "VENTA", "piso": "16", "precio": 3324.01, "cliente": null },
        { "depto": "D-1607", "estado": "OFERTA", "piso": "16", "precio": 3273.59, "cliente": "DE LA CERDA BASULTO LUCAS" },
        { "depto": "D-1608", "estado": "OFERTA", "piso": "16", "precio": 3257.29, "cliente": "GARIN SCHMID SERGIO ANTONIO" },
        { "depto": "D-1609", "estado": "VENTA", "piso": "16", "precio": 3225.00, "cliente": null },
        { "depto": "D-1610", "estado": "OFERTA", "piso": "16", "precio": 3697.53, "cliente": "ZANDEE MEDOVIC DIRK DUSAN" },
        { "depto": "D-1611", "estado": "OFERTA", "piso": "16", "precio": 3250.97, "cliente": "GARIN SCHMID SERGIO ANTONIO" },
        { "depto": "D-1612", "estado": "OFERTA", "piso": "16", "precio": 2921.75, "cliente": "ESPINOLA SOLAR LUIS EDUARDO" },
        { "depto": "D-S203", "estado": "OFERTA", "piso": "S2", "precio": 2324.91, "cliente": "MALUENDA SERRANO KATHERINE TESS" },
        { "depto": "D-S213", "estado": "BLOQUEADO", "piso": "S2", "precio": 2529.19, "cliente": null },
        { "depto": "D-S214", "estado": "OFERTA", "piso": "S2", "precio": 1938.22, "cliente": "HAYDEN OFFERMANN EDUARDO ANDRES" },
        { "depto": "D-S215", "estado": "OFERTA", "piso": "S2", "precio": 1943.24, "cliente": "VILLAVICENCIO CORREA PRISCILLA ANDREA" },
        { "depto": "D-S301", "estado": "OFERTA", "piso": "S3", "precio": 2838.88, "cliente": "PEREZ DIAZ SIMON IGNACIO" },
        { "depto": "D-S302", "estado": "OFERTA", "piso": "S3", "precio": 2733.08, "cliente": "JURI CASTILLO DIEGO EDUARDO" },
        { "depto": "D-S303", "estado": "BLOQUEADO", "piso": "S3", "precio": 2485.45, "cliente": null },
        { "depto": "D-S313", "estado": "OFERTA", "piso": "S3", "precio": 2303.72, "cliente": "LEDDIHN HERNANDEZ CARMEN GLORIA" },
        { "depto": "D-S314", "estado": "VENTA", "piso": "S3", "precio": 2491.23, "cliente": null },
        { "depto": "D-S315", "estado": "VENTA", "piso": "S3", "precio": 2488.50, "cliente": null },
        { "depto": "D-S401", "estado": "OFERTA", "piso": "S4", "precio": 2423.79, "cliente": "GUTIERREZ ARIAS IVAN NICOLAS" },
        { "depto": "D-S402", "estado": "OFERTA", "piso": "S4", "precio": 2733.08, "cliente": "CARRASCO SEARLE BENJAMIN MAURICIO" },
        { "depto": "D-S403", "estado": "OFERTA", "piso": "S4", "precio": 2078.74, "cliente": "ROSENKRANZ MARTIN MARIA JESUS" },
        { "depto": "D-S413", "estado": "OFERTA", "piso": "S4", "precio": 2166.18, "cliente": "MAZO MEZA VALENTIN JOSE" },
        { "depto": "D-S414", "estado": "OFERTA", "piso": "S4", "precio": 2175.22, "cliente": "MAZO MEZA VALENTIN JOSE" },
        { "depto": "D-S415", "estado": "VENTA", "piso": "S4", "precio": 2488.50, "cliente": null },
        { "depto": "D-S501", "estado": "OFERTA", "piso": "S5", "precio": 2446.44, "cliente": "CALDERON GALAZ HUGO CESAR" },
        { "depto": "D-S502", "estado": "OFERTA", "piso": "S5", "precio": 2130.26, "cliente": "RODRIGUEZ CHAPARRO CESAR MAURICIO" },
        { "depto": "D-S503", "estado": "OFERTA", "piso": "S5", "precio": 2382.50, "cliente": "TAPIA JULIO CRISTIAN ADRIAN" },
        { "depto": "D-S513", "estado": "BLOQUEADO", "piso": "S5", "precio": 2572.24, "cliente": null },
        { "depto": "D-S514", "estado": "OFERTA", "piso": "S5", "precio": 2327.18, "cliente": "ARAVENA BUSTOS ESTEBAN PABLO" },
        { "depto": "D-S515", "estado": "VENTA", "piso": "S5", "precio": 2509.50, "cliente": null },
        { "depto": "D-S601", "estado": "OFERTA", "piso": "S6", "precio": 2446.44, "cliente": "LEON LOPEZ PAULINA ANDREA" },
        { "depto": "D-S602", "estado": "OFERTA", "piso": "S6", "precio": 2781.43, "cliente": "BLANCO CABRERA MIGUEL ANGEL" },
        { "depto": "D-S603", "estado": "OFERTA", "piso": "S6", "precio": 2733.37, "cliente": "FARIAS PAVEZ JORGE ANDRES" },
        { "depto": "D-S613", "estado": "OFERTA", "piso": "S6", "precio": 2248.50, "cliente": "MUÃ‘OZ JARA GUILLERMO ANGEL" },
        { "depto": "D-S614", "estado": "OFERTA", "piso": "S6", "precio": 2327.18, "cliente": "QUIJADA JARA JONATHAN ALEJANDRO" },
        { "depto": "D-S615", "estado": "VENTA", "piso": "S6", "precio": 2509.50, "cliente": null },
        { "depto": "D-S701", "estado": "OFERTA", "piso": "S7", "precio": 2497.19, "cliente": "CLAVIJO MATURANA BRIAN EDUARDO" },
        { "depto": "D-S702", "estado": "OFERTA", "piso": "S7", "precio": 2153.29, "cliente": "SILVA PODADERA CRISTOBAL ISAAC" },
        { "depto": "D-S703", "estado": "OFERTA", "piso": "S7", "precio": 2357.16, "cliente": "SILVA JONES JAVIERA PAZ" },
        { "depto": "D-S713", "estado": "BLOQUEADO", "piso": "S7", "precio": 2572.24, "cliente": null },
        { "depto": "D-S714", "estado": "OFERTA", "piso": "S7", "precio": 2327.18, "cliente": "ARAVENA BUSTOS ESTEBAN PABLO" },
        { "depto": "D-S715", "estado": "VENTA", "piso": "S7", "precio": 2509.50, "cliente": null },
        { "depto": "D-S801", "estado": "OFERTA", "piso": "S8", "precio": 2469.08, "cliente": "ZUÃ‘IGA BAUMANN MARCO ANTONIO" },
        { "depto": "D-S802", "estado": "OFERTA", "piso": "S8", "precio": 2723.04, "cliente": "TAPIA AGUILAR RODRIGO MARCELO" },
        { "depto": "D-S803", "estado": "OFERTA", "piso": "S8", "precio": 2302.74, "cliente": "GOMEZ PRIETO REINALDO MIGUEL" },
        { "depto": "D-S813", "estado": "OFERTA", "piso": "S8", "precio": 2209.28, "cliente": "RODRIGUEZ GUTIERREZ DIEGO EDUARDO" },
        { "depto": "D-S814", "estado": "VENTA", "piso": "S8", "precio": 2533.27, "cliente": null },
        { "depto": "D-S815", "estado": "OFERTA", "piso": "S8", "precio": 2272.08, "cliente": "VALENZUELA SEPULVEDA BENJAMIN IGNACIO" },
        { "depto": "D-S901", "estado": "OFERTA", "piso": "S9", "precio": 2222.18, "cliente": "ORELLANA CASTILLO FERNANDO IGNACIO" },
        { "depto": "D-S902", "estado": "OFERTA", "piso": "S9", "precio": 2288.41, "cliente": "SANDOVAL RIOS RODRIGO IVAN" },
        { "depto": "D-S903", "estado": "OFERTA", "piso": "S9", "precio": 2422.47, "cliente": "ALARCON BARBE MARTIN ANTONIO" },
        { "depto": "D-S913", "estado": "BLOQUEADO", "piso": "S9", "precio": 2593.76, "cliente": null },
        { "depto": "D-S914", "estado": "VENTA", "piso": "S9", "precio": 2533.27, "cliente": null },
        { "depto": "D-S915", "estado": "OFERTA", "piso": "S9", "precio": 2152.50, "cliente": "BOLUMBURU PEREZ IGNACIO" },
        { "depto": "D-S1001", "estado": "OFERTA", "piso": "", "precio": 2402.36, "cliente": "JIMENEZ PALMA GUILLERMO IGNACIO" },
        { "depto": "D-S1002", "estado": "OFERTA", "piso": "", "precio": 2092.61, "cliente": "CALDERON VELASCO GONZALO JOSE" },
        { "depto": "D-S1003", "estado": "OFERTA", "piso": "", "precio": 2302.74, "cliente": "LABBE BASCUÃ‘AN TOBIAS GUILLERMO" },
        { "depto": "D-S1013", "estado": "OFERTA", "piso": "", "precio": 2160.25, "cliente": "LEDEZMA FUENTEALBA CARLOS LUIS" },
        { "depto": "D-S1014", "estado": "OFERTA", "piso": "", "precio": 2066.20, "cliente": "GONZALEZ FONTAINE PEDRO PABLO" },
        { "depto": "D-S1015", "estado": "OFERTA", "piso": "", "precio": 2215.50, "cliente": "OJEDA TORREBLANCA MARIA JAVIERA" },
        { "depto": "D-S1101", "estado": "VENTA", "piso": "", "precio": 2796.67, "cliente": null },
        { "depto": "D-S1102", "estado": "OFERTA", "piso": "", "precio": 3167.49, "cliente": "CATALAN RODRIGUEZ CARLOS ALFREDO" },
        { "depto": "D-S1103", "estado": "OFERTA", "piso": "", "precio": 2691.63, "cliente": "IRIARTE GALDAMES MARIA JESUS" },
        { "depto": "D-S1113", "estado": "BLOQUEADO", "piso": "", "precio": 2658.34, "cliente": null },
        { "depto": "D-S1114", "estado": "OFERTA", "piso": "", "precio": 2055.09, "cliente": "QUEZADA VIANCOS CAMILA ANDREA" },
        { "depto": "D-S1115", "estado": "OFERTA", "piso": "", "precio": 2215.50, "cliente": "CASTRO BARROS CRISTIAN" },
        { "depto": "D-S1201", "estado": "OFERTA", "piso": "", "precio": 2469.09, "cliente": "OLGUIN CACERES ANGEL FERNANDO" },
        { "depto": "D-S1202", "estado": "OFERTA", "piso": "", "precio": 2549.38, "cliente": "ZAPATA BUSTOS JOSE JAVIER" },
        { "depto": "D-S1203", "estado": "OFERTA", "piso": "", "precio": 2302.74, "cliente": "NEUMANN CORRAL CAMILA" },
        { "depto": "D-S1213", "estado": "BLOQUEADO", "piso": "", "precio": 2658.34, "cliente": null },
        { "depto": "D-S1214", "estado": "OFERTA", "piso": "", "precio": 2555.05, "cliente": "COVARRUBIAS ROSS ALBERTO" },
        { "depto": "D-S1215", "estado": "OFERTA", "piso": "", "precio": 2215.50, "cliente": "LAGOS VALDIVIESO IGNACIO" },
        { "depto": "D-S1301", "estado": "OFERTA", "piso": "", "precio": 2509.13, "cliente": "MIRANDA ROJAS JONATHAN ALEXI" },
        { "depto": "D-S1302", "estado": "VENTA", "piso": "", "precio": 2721.25, "cliente": null },
        { "depto": "D-S1303", "estado": "OFERTA", "piso": "", "precio": 2480.03, "cliente": "CAMPOS GUEVARA CAROLINA ANDREA" },
        { "depto": "D-S1313", "estado": "OFERTA", "piso": "", "precio": 2103.40, "cliente": "SOTELO PEREIRA ANDRES ANTONIO" },
        { "depto": "D-S1314", "estado": "VENTA", "piso": "", "precio": 2596.34, "cliente": null },
        { "depto": "D-S1315", "estado": "OFERTA", "piso": "", "precio": 2215.50, "cliente": "FALCONE SAID PIERO" },
        { "depto": "D-S1401", "estado": "OFERTA", "piso": "", "precio": 2913.53, "cliente": "REYES TRONCOSO ISIDORA FRANCISCA" },
        { "depto": "D-S1402", "estado": "OFERTA", "piso": "", "precio": 2092.61, "cliente": "ARAYA PAQUAY JUAN VICENTE" },
        { "depto": "D-S1403", "estado": "OFERTA", "piso": "", "precio": 2302.74, "cliente": "NEUMANN CORRAL CAMILA" },
        { "depto": "D-S1413", "estado": "OFERTA", "piso": "", "precio": 2362.38, "cliente": "PALMA SANCHEZ FRANCISCO IGNACIO" },
        { "depto": "D-S1414", "estado": "OFERTA", "piso": "", "precio": 2221.72, "cliente": "ZUÃ‘IGA ZUÃ‘IGA JOSE ANDRES" },
        { "depto": "D-S1415", "estado": "VENTA", "piso": "", "precio": 2593.50, "cliente": null },
        { "depto": "D-S1501", "estado": "VENTA", "piso": "", "precio": 2796.67, "cliente": null },
        { "depto": "D-S1502", "estado": "OFERTA", "piso": "", "precio": 2428.46, "cliente": "RODRIGUEZ CHAPARRO CESAR MAURICIO" },
        { "depto": "D-S1503", "estado": "OFERTA", "piso": "", "precio": 2689.45, "cliente": "BALDOVINO SCHWENKE MAXIMILIANO GUILLERMO" },
        { "depto": "D-S1513", "estado": "OFERTA", "piso": "", "precio": 3047.23, "cliente": "ASTRAIN RAMIREZ JAVIER ANDRES" },
        { "depto": "D-S1514", "estado": "OFERTA", "piso": "", "precio": 2077.31, "cliente": "ARANGUIZ MERCADO FERNANDA LORETO" },
        { "depto": "D-S1515", "estado": "OFERTA", "piso": "", "precio": 2215.50, "cliente": "BENADO ALBAGLI VALENTINA" },
        { "depto": "D-S1601", "estado": "OFERTA", "piso": "", "precio": 2336.24, "cliente": "MUÃ‘OZ COFRE CRISTIAN BERNARDO" },
        { "depto": "D-S1602", "estado": "OFERTA", "piso": "", "precio": 2321.43, "cliente": "BOSAGNA URIBE PABLO ALBERTO SEBASTIAN" },
        { "depto": "D-S1603", "estado": "OFERTA", "piso": "", "precio": 2178.99, "cliente": "DONOSO ALLIENDE JUAN CRISTOBAL" },
        { "depto": "D-S1613", "estado": "OFERTA", "piso": "", "precio": 2065.69, "cliente": "RODRIGUEZ PEREZ CRISTIAN MANUEL" },
        { "depto": "D-S1614", "estado": "OFERTA", "piso": "", "precio": 1996.66, "cliente": "ESPINOLA SOLAR LUIS EDUARDO" },
        { "depto": "D-S1615", "estado": "OFERTA", "piso": "", "precio": 2212.29, "cliente": "BRANDT NAVARRO JUAN CARLOS" }
    ];

    // ---------------------------------------------------------
    // 4. PROCESAMIENTO DE UNIDADES
    // ---------------------------------------------------------
    for (const item of teatinosData) {
        console.log(`Processing unit ${item.depto}...`);

        // A. Parseo de Piso
        let pisoNum = 0;

        // Si el piso estÃ¡ vacÃ­o, extraerlo del nombre del departamento
        if (!item.piso || item.piso.trim() === '') {
            // Extraer del nombre del departamento
            // D-S1001 -> piso 10 (Studio)
            // D-S203 -> piso 2 (Studio)
            // D-201 -> piso 2 (Normal)
            const match = item.depto.match(/D-S?(\d+)/);
            if (match) {
                const deptoNumber = match[1];
                // Extraer los primeros 1 o 2 dÃ­gitos como nÃºmero de piso
                if (deptoNumber.length >= 3) {
                    // D-S1001 -> "10", D-S1201 -> "12", etc.
                    pisoNum = parseInt(deptoNumber.substring(0, 2));
                } else {
                    // D-S203 -> "2", D-201 -> "2", etc.
                    pisoNum = parseInt(deptoNumber.charAt(0));
                }
            }
        } else if (item.piso.startsWith('S')) {
            // "S2" -> piso 2 (Studio), "S3" -> piso 3, etc.
            pisoNum = parseInt(item.piso.substring(1));
        } else {
            // Pisos normales: "2" -> 2, "10" -> 10, etc.
            pisoNum = parseInt(item.piso);
        }

        // B. Determinar tipologÃ­a basÃ¡ndose en el nombre
        let tipologia = 'DEPTO'; // Valor por defecto
        if (item.depto.includes('-S')) {
            tipologia = 'STUDIO';
        }

        // C. Mapeo de Estados
        let estadoDb = 'Disponible';
        let clientNameForFicha: string | null = null;

        if (item.estado === 'VENTA') {
            estadoDb = 'Disponible';
        } else if (item.estado === 'OFERTA') {
            estadoDb = 'Reservada'; // O 'Vendida' segÃºn lÃ³gica de negocio, pero 'OFERTA' suele ser Reserva.
            clientNameForFicha = item.cliente;
        } else if (item.estado === 'BLOQUEADO') {
            estadoDb = 'Reservada';
            clientNameForFicha = 'Reservado Interno';
        }

        // D. Crear/Actualizar Unidad
        let unidad = await unidadRepo.findOne({ where: { nombre: item.depto, proyecto: { id: proyecto.id } } });

        if (!unidad) {
            unidad = await unidadRepo.save({
                proyecto: proyecto,
                nombre: item.depto,
                tipologia: tipologia, // Usar la tipologÃ­a determinada (STUDIO o DEPTO)
                valorUf: item.precio,
                piso: pisoNum,
                estado: estadoDb,
                metrosCuadrados: 45 // Valor por defecto ya que no viene en el JSON
            });
        } else {
            // Actualizar TODOS los campos relevantes, incluyendo piso y tipologÃ­a
            unidad.estado = estadoDb;
            unidad.valorUf = item.precio;
            unidad.piso = pisoNum;
            unidad.tipologia = tipologia;
            await unidadRepo.save(unidad);
        }

        // D. GestiÃ³n de Cliente y Ficha (Solo si no estÃ¡ disponible)
        if (estadoDb === 'Reservada' || estadoDb === 'Vendida') {
            if (clientNameForFicha) {
                // 1. Buscar o Crear Cliente
                // Usamos un email ficticio basado en el nombre para unicidad en este seed
                const safeName = clientNameForFicha.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                const clientEmail = `${safeName}@import.cl`;

                let cliente = await clienteRepo.findOne({ where: { email: clientEmail } });

                if (!cliente) {
                    // Generar RUT ficticio para evitar colisiones
                    const randomRut = `${Math.floor(Math.random() * 90000000)}-${Math.floor(Math.random() * 9)}`;

                    cliente = await clienteRepo.save({
                        nombreCompleto: clientNameForFicha,
                        rut: randomRut,
                        email: clientEmail,
                        telefono: '+56900000000'
                    });
                }

                // 2. Crear FichaVenta si no existe
                // Asumimos que si la unidad estÃ¡ reservada, debe tener una ficha activa
                const fichaExistente = await fichaVentaRepo.findOne({
                    where: { unidad: { id: unidad.id } }
                });

                if (!fichaExistente) {
                    console.log(`Creating FichaVenta for ${item.depto} - Client: ${clientNameForFicha}`);
                    const nuevaFicha = await fichaVentaRepo.save({
                        unidad: unidad,
                        agente: brokerUser,
                        estadoFicha: EstadoFicha.RESERVA,
                        valorTotalUf: unidad.valorUf,
                        folio: `FV-${unidad.nombre}-${Date.now()}`,
                        createdAt: new Date()
                    });

                    // Asociar Cliente a Ficha
                    await fichaClienteRepo.save({
                        fichaVenta: nuevaFicha,
                        cliente: cliente,
                        rol: 'Principal'
                    });
                }
            }
        }
    }

    console.log('Seed for Edificio Teatinos 750 completed successfully.');
    await app.close();
}
bootstrap();



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\test\app.e2e-spec.ts
================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { App } from 'supertest/types';
import { AppModule } from './../src/app.module';

describe('AppController (e2e)', () => {
  let app: INestApplication<App>;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/ (GET)', () => {
    return request(app.getHttpServer())
      .get('/')
      .expect(200)
      .expect('Hello World!');
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\test\jest-e2e.json
================================================================

{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\nest-cli.json
================================================================

{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\package.json
================================================================

{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "seed": "ts-node src/seed.ts",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.1",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.1",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@nestjs/schedule": "^6.0.1",
    "@nestjs/swagger": "^11.2.3",
    "@nestjs/typeorm": "^11.0.0",
    "@types/pdfkit": "^0.17.3",
    "bcrypt": "^6.0.0",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.2",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "pdfkit": "^0.17.2",
    "pg": "^8.16.3",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "swagger-ui-express": "^5.0.1",
    "typeorm": "^0.3.27"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/bcrypt": "^6.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/passport-jwt": "^4.0.1",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\setup_db.sql
================================================================

-- Create the database
CREATE DATABASE inmoapp_db;

-- Create the user with password
CREATE USER admin WITH PASSWORD 'adminpassword';

-- Grant all privileges on the database to the user
GRANT ALL PRIVILEGES ON DATABASE inmoapp_db TO admin;

-- Connect to the new database and grant schema privileges
\c inmoapp_db
GRANT ALL ON SCHEMA public TO admin;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO admin;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO admin;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO admin;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO admin;



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\tsconfig.build.json
================================================================

{
  "extends": "./tsconfig.json",
  "exclude": ["node_modules", "test", "dist", "**/*spec.ts"]
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\backend\tsconfig.json
================================================================

{
  "compilerOptions": {
    "module": "nodenext",
    "moduleResolution": "nodenext",
    "resolvePackageJsonExports": true,
    "esModuleInterop": true,
    "isolatedModules": true,
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2023",
    "sourceMap": true,
    "outDir": "./dist",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "noFallthroughCasesInSwitch": false
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\database\init.sql
================================================================

-- Script de CreaciÃ³n de Base de Datos para InmoApp (V 4.0 - ERP Completo)
-- Base de Datos: PostgreSQL

-- Tabla de Proyectos Inmobiliarios
CREATE TABLE Proyectos (
    id SERIAL PRIMARY KEY,
    nombre VARCHAR(255) NOT NULL UNIQUE,
    direccion VARCHAR(255),
    comuna VARCHAR(100),
    imagen_principal_url TEXT, -- URL a la imagen en S3
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tabla de Unidades (Departamentos, etc.)
CREATE TABLE Unidades (
    id SERIAL PRIMARY KEY,
    proyecto_id INT NOT NULL REFERENCES Proyectos(id) ON DELETE RESTRICT,
    nombre VARCHAR(100) NOT NULL, -- ej. "Depto 101", "Oficina 202"
    tipologia VARCHAR(100), -- ej. "2D/1B", "Estudio"
    metros_cuadrados DECIMAL(10, 2),
    piso INT NOT NULL DEFAULT 1, -- Para la vista de edificio
    valor_uf DECIMAL(12, 2) NOT NULL,
    estado VARCHAR(50) NOT NULL DEFAULT 'Disponible', -- 'Disponible', 'Reservada', 'Vendida'
    reserva_expira_en TIMESTAMP WITH TIME ZONE DEFAULT NULL, -- Para el timer de reserva
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(proyecto_id, nombre), -- No pueden existir dos "Depto 101" en el mismo proyecto
    CHECK (estado IN ('Disponible', 'Reservada', 'Vendida'))
);

-- Tabla de Adicionales (Bodegas, Estacionamientos)
CREATE TABLE Adicionales (
    id SERIAL PRIMARY KEY,
    proyecto_id INT NOT NULL REFERENCES Proyectos(id) ON DELETE RESTRICT,
    tipo VARCHAR(100) NOT NULL, -- 'Bodega', 'Estacionamiento', 'Bicicletero'
    nombre VARCHAR(100) NOT NULL, -- ej. "B-101", "E-20"
    valor_uf DECIMAL(10, 2) NOT NULL,
    estado VARCHAR(50) NOT NULL DEFAULT 'Disponible', -- 'Disponible', 'Asignado', 'Vendido'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(proyecto_id, tipo, nombre),
    CHECK (estado IN ('Disponible', 'Asignado', 'Vendido'))
);

-- Tabla de Usuarios del Sistema (Admins, Agentes, Brokers)
CREATE TABLE Usuarios (
    id SERIAL PRIMARY KEY,
    nombre VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL, -- Se guarda el hash, NUNCA la clave en texto plano
    rol VARCHAR(50) NOT NULL DEFAULT 'Broker', -- 'Admin', 'Agente', 'Broker', 'Contabilidad'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (rol IN ('Admin', 'Agente', 'Broker', 'Contabilidad'))
);

-- Tabla Pivote para asignar quÃ© Proyectos puede ver cada Broker
CREATE TABLE Broker_Proyectos (
    id SERIAL PRIMARY KEY,
    broker_id INT NOT NULL REFERENCES Usuarios(id) ON DELETE CASCADE,
    proyecto_id INT NOT NULL REFERENCES Proyectos(id) ON DELETE CASCADE,
    
    UNIQUE(broker_id, proyecto_id) -- Un broker solo puede estar asignado una vez a un proyecto
);

-- Tabla de Clientes (Compradores)
CREATE TABLE Clientes (
    id SERIAL PRIMARY KEY,
    nombre_completo VARCHAR(255) NOT NULL,
    rut VARCHAR(20) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL,
    telefono VARCHAR(50),
    fecha_nacimiento DATE,
    estado_civil VARCHAR(50), -- 'Soltero', 'Casado (SB)', 'Casado (SC)', 'Casado (CP)', 'Viudo', 'Divorciado'
    profesion VARCHAR(100),
    direccion_calle VARCHAR(255),
    direccion_comuna VARCHAR(100),
    direccion_ciudad VARCHAR(100),
    direccion_pais VARCHAR(100) DEFAULT 'Chile',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tabla para los Documentos del Cliente (almacenados en S3)
CREATE TABLE Documentos_Cliente (
    id SERIAL PRIMARY KEY,
    cliente_id INT NOT NULL REFERENCES Clientes(id) ON DELETE CASCADE,
    tipo_documento VARCHAR(100) NOT NULL, -- 'Carnet (Anverso)', 'Carnet (Reverso)', 'Liquidacion 1', 'CMF'
    url_s3 TEXT NOT NULL,
    estado_validacion VARCHAR(50) NOT NULL DEFAULT 'Pendiente', -- 'Pendiente', 'Aprobado', 'Rechazado'
    observacion_rechazo TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tabla principal de Fichas de Venta (el corazÃ³n del negocio)
CREATE TABLE Fichas_Venta (
    id SERIAL PRIMARY KEY,
    unidad_id INT NOT NULL REFERENCES Unidades(id) ON DELETE RESTRICT,
    agente_id INT NOT NULL REFERENCES Usuarios(id) ON DELETE RESTRICT, -- El agente/broker que hizo la venta
    estado_ficha VARCHAR(50) NOT NULL DEFAULT 'Borrador', -- 'Borrador', 'En RevisiÃ³n', 'Aprobada', 'Rechazada'
    valor_total_uf DECIMAL(12, 2) NOT NULL, -- Suma de unidad + adicionales
    bono_pie BOOLEAN DEFAULT FALSE,
    credito_fundit_monto DECIMAL(12, 2) DEFAULT 0,
    
    -- CAMPOS DE ESCRITURA
    estado_escritura VARCHAR(50) DEFAULT 'Pendiente', -- 'Pendiente', 'En Banco', 'En NotarÃ­a', 'Firmada Cliente', 'Firmada Inmo', 'Finalizada'
    banco_hipotecario VARCHAR(100) DEFAULT NULL,
    monto_hipotecario DECIMAL(12, 2) DEFAULT 0,
    fecha_firma_escritura_cliente DATE DEFAULT NULL,

    -- CAMPOS DE ENTREGA
    estado_entrega VARCHAR(50) DEFAULT 'Pendiente', -- 'Pendiente', 'Coordinada', 'Realizada'
    
    -- CAMPOS DE COMISIÃ“N
    comision_broker_monto DECIMAL(12, 2) DEFAULT 0,
    estado_comision_broker VARCHAR(50) DEFAULT 'Pendiente', -- 'Pendiente', 'Solicitar Factura', 'Factura Recibida', 'Pagada'
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (estado_ficha IN ('Borrador', 'En RevisiÃ³n', 'Aprobada', 'Rechazada')),
    CHECK (estado_escritura IN ('Pendiente', 'En Banco', 'En NotarÃ­a', 'Firmada Cliente', 'Firmada Inmo', 'Finalizada')),
    CHECK (estado_entrega IN ('Pendiente', 'Coordinada', 'Realizada')),
    CHECK (estado_comision_broker IN ('Pendiente', 'Solicitar Factura', 'Factura Recibida', 'Pagada'))
);

-- Tabla Pivote para asociar MÃšLTIPLES Clientes a una Ficha de Venta (Manejo de Co-Compradores)
CREATE TABLE Ficha_Clientes (
    id SERIAL PRIMARY KEY,
    ficha_venta_id INT NOT NULL REFERENCES Fichas_Venta(id) ON DELETE CASCADE,
    cliente_id INT NOT NULL REFERENCES Clientes(id) ON DELETE RESTRICT,
    rol VARCHAR(50) NOT NULL DEFAULT 'Principal', -- 'Principal', 'Co-Comprador'
    
    UNIQUE(ficha_venta_id, cliente_id) -- No se puede agregar el mismo cliente dos veces a la misma ficha
);

-- Tabla Pivote para asociar Adicionales a una Ficha de Venta
CREATE TABLE Ficha_Adicionales (
    id SERIAL PRIMARY KEY,
    ficha_venta_id INT NOT NULL REFERENCES Fichas_Venta(id) ON DELETE CASCADE,
    adicional_id INT NOT NULL REFERENCES Adicionales(id) ON DELETE RESTRICT,
    
    UNIQUE(ficha_venta_id, adicional_id)
);

-- Documentos asociados a la VENTA (ej. Acta de Entrega, Cuadratura)
CREATE TABLE Documentos_Venta (
    id SERIAL PRIMARY KEY,
    ficha_venta_id INT NOT NULL REFERENCES Fichas_Venta(id) ON DELETE CASCADE,
    tipo_documento VARCHAR(100) NOT NULL, -- 'Acta de Entrega', 'Cuadratura Final', 'GarantÃ­as'
    url_s3 TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (tipo_documento IN ('Acta de Entrega', 'Cuadratura Final', 'GarantÃ­as'))
);

-- Tabla de Planes de Pago (asociados a una Venta, ej. un PagarÃ©)
CREATE TABLE Planes_Pago (
    id SERIAL PRIMARY KEY,
    ficha_venta_id INT NOT NULL REFERENCES Fichas_Venta(id) ON DELETE CASCADE,
    tipo_plan VARCHAR(50) NOT NULL, -- 'PagarÃ©', 'Arriendo Garantizado', 'CrÃ©dito Directo'
    monto_total DECIMAL(12, 2) NOT NULL,
    numero_cuotas INT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Tabla de Cuotas (detalles de un Plan de Pago)
CREATE TABLE Cuotas (
    id SERIAL PRIMARY KEY,
    plan_pago_id INT NOT NULL REFERENCES Planes_Pago(id) ON DELETE CASCADE,
    numero_cuota INT NOT NULL,
    monto_cuota DECIMAL(12, 2) NOT NULL,
    fecha_vencimiento DATE NOT NULL,
    estado VARCHAR(50) NOT NULL DEFAULT 'Pendiente', -- 'Pendiente', 'Pagada'
    fecha_pago DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CHECK (estado IN ('Pendiente', 'Pagada'))
);

-- CreaciÃ³n de Ãndices para optimizar bÃºsquedas comunes
CREATE INDEX idx_unidades_proyecto ON Unidades(proyecto_id);
CREATE INDEX idx_unidades_estado ON Unidades(estado);
CREATE INDEX idx_unidades_reserva_expira ON Unidades(reserva_expira_en) WHERE estado = 'Reservada';
CREATE INDEX idx_clientes_rut ON Clientes(rut);
CREATE INDEX idx_documentos_cliente_id ON Documentos_Cliente(cliente_id);
CREATE INDEX idx_fichas_venta_estado ON Fichas_Venta(estado_ficha);
CREATE INDEX idx_fichas_venta_estado_escritura ON Fichas_Venta(estado_escritura);
CREATE INDEX idx_fichas_venta_estado_comision ON Fichas_Venta(estado_comision_broker);
CREATE INDEX idx_documentos_venta_ficha ON Documentos_Venta(ficha_venta_id);
CREATE INDEX idx_ficha_clientes_ficha ON Ficha_Clientes(ficha_venta_id);
CREATE INDEX idx_ficha_clientes_cliente ON Ficha_Clientes(cliente_id);
CREATE INDEX idx_ficha_adicionales_ficha ON Ficha_Adicionales(ficha_venta_id);
CREATE INDEX idx_planes_pago_ficha ON Planes_Pago(ficha_venta_id);
CREATE INDEX idx_cuotas_plan ON Cuotas(plan_pago_id);
CREATE INDEX idx_cuotas_estado ON Cuotas(estado);



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\database\seed.sql
================================================================

-- Seed Data for InmoApp

-- Insertar Proyectos
INSERT INTO Proyectos (nombre, direccion, comuna, imagen_principal_url) VALUES
('Edificio Vista Mar', 'Av. del Mar 1234', 'La Serena', 'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?auto=format&fit=crop&w=1000&q=80'),
('Condominio Los Andes', 'Calle Los Andes 567', 'Las Condes', 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format&fit=crop&w=1000&q=80')
ON CONFLICT (nombre) DO NOTHING;

-- Insertar Unidades para Edificio Vista Mar (ID 1 asumiendo serial)
-- Nota: Usamos subquery para obtener el ID por nombre para ser mÃ¡s robustos
INSERT INTO Unidades (proyecto_id, nombre, tipologia, metros_cuadrados, piso, valor_uf, estado) VALUES
((SELECT id FROM Proyectos WHERE nombre = 'Edificio Vista Mar'), '101', '2D/2B', 65.5, 1, 3500.00, 'Disponible'),
((SELECT id FROM Proyectos WHERE nombre = 'Edificio Vista Mar'), '102', '1D/1B', 45.0, 1, 2800.00, 'Reservada'),
((SELECT id FROM Proyectos WHERE nombre = 'Edificio Vista Mar'), '201', '3D/2B', 85.0, 2, 4500.00, 'Disponible'),
((SELECT id FROM Proyectos WHERE nombre = 'Edificio Vista Mar'), '202', '2D/2B', 68.0, 2, 3600.00, 'Vendida');

-- Insertar Unidades para Condominio Los Andes
INSERT INTO Unidades (proyecto_id, nombre, tipologia, metros_cuadrados, piso, valor_uf, estado) VALUES
((SELECT id FROM Proyectos WHERE nombre = 'Condominio Los Andes'), 'A-101', '3D/3B', 120.0, 1, 8500.00, 'Disponible'),
((SELECT id FROM Proyectos WHERE nombre = 'Condominio Los Andes'), 'A-102', '3D/3B', 120.0, 1, 8500.00, 'Disponible'),
((SELECT id FROM Proyectos WHERE nombre = 'Condominio Los Andes'), 'B-201', '4D/3B', 140.0, 2, 9800.00, 'Reservada');

-- Insertar Usuario Admin por defecto
INSERT INTO Usuarios (nombre, email, password_hash, rol) VALUES
('Admin User', 'admin@inmoapp.cl', '$2b$10$EpIxT98hP7jF.L7eG.X.VO/y/0.0.0.0.0.0.0.0.0.0.0.0.0', 'Admin') -- Hash de ejemplo
ON CONFLICT (email) DO NOTHING;



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\database\seed_large_building.sql
================================================================

-- Seed Data for Large Building

-- Insertar Proyecto Grande
INSERT INTO Proyectos (nombre, direccion, comuna, imagen_principal_url) VALUES
('Edificio Torre Central', 'Av. Libertador 999', 'Santiago Centro', 'https://images.unsplash.com/photo-1574362848149-11496d93a7c7?auto=format&fit=crop&w=1000&q=80')
ON CONFLICT (nombre) DO NOTHING;

-- Generar Unidades (10 pisos, 8 deptos por piso)
DO $$
DECLARE
    p_id INT;
    piso INT;
    depto INT;
    estado_random TEXT;
    estados TEXT[] := ARRAY['Disponible', 'Disponible', 'Disponible', 'Reservada', 'Vendida']; -- MÃ¡s peso a Disponible
BEGIN
    SELECT id INTO p_id FROM Proyectos WHERE nombre = 'Edificio Torre Central';

    FOR piso IN 1..10 LOOP
        FOR depto IN 1..8 LOOP
            -- Seleccionar estado aleatorio
            estado_random := estados[1 + floor(random() * array_length(estados, 1))];
            
            INSERT INTO Unidades (proyecto_id, nombre, tipologia, metros_cuadrados, piso, valor_uf, estado)
            VALUES (
                p_id,
                piso || LPAD(depto::text, 2, '0'), -- Ej: 101, 102... 1001, 1002
                CASE WHEN depto <= 2 THEN '1D/1B' WHEN depto <= 6 THEN '2D/2B' ELSE '3D/2B' END,
                CASE WHEN depto <= 2 THEN 45.0 WHEN depto <= 6 THEN 70.0 ELSE 95.0 END,
                piso,
                CASE WHEN depto <= 2 THEN 2500 + (piso * 50) WHEN depto <= 6 THEN 4000 + (piso * 80) ELSE 5500 + (piso * 100) END,
                estado_random
            )
            ON CONFLICT (proyecto_id, nombre) DO NOTHING;
        END LOOP;
    END LOOP;
END $$;



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\.vscode\extensions.json
================================================================

{
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=827846
  "recommendations": ["angular.ng-template"]
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\.vscode\launch.json
================================================================

{
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
      "name": "ng serve",
      "type": "chrome",
      "request": "launch",
      "preLaunchTask": "npm: start",
      "url": "http://localhost:4200/"
    },
    {
      "name": "ng test",
      "type": "chrome",
      "request": "launch",
      "preLaunchTask": "npm: test",
      "url": "http://localhost:9876/debug.html"
    }
  ]
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\.vscode\tasks.json
================================================================

{
  // For more information, visit: https://go.microsoft.com/fwlink/?LinkId=733558
  "version": "2.0.0",
  "tasks": [
    {
      "type": "npm",
      "script": "start",
      "isBackground": true,
      "problemMatcher": {
        "owner": "typescript",
        "pattern": "$tsc",
        "background": {
          "activeOnStart": true,
          "beginsPattern": {
            "regexp": "(.*?)"
          },
          "endsPattern": {
            "regexp": "bundle generation complete"
          }
        }
      }
    },
    {
      "type": "npm",
      "script": "test",
      "isBackground": true,
      "problemMatcher": {
        "owner": "typescript",
        "pattern": "$tsc",
        "background": {
          "activeOnStart": true,
          "beginsPattern": {
            "regexp": "(.*?)"
          },
          "endsPattern": {
            "regexp": "bundle generation complete"
          }
        }
      }
    }
  ]
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\e2e\login.spec.ts
================================================================

import { test, expect, Page } from '@playwright/test';

test('login flow', async ({ page }: { page: Page }) => {
    // 1. Navigate to login page
    await page.goto('/login');

    // 2. Enter credentials
    await page.fill('input[name="username"]', 'testuser'); // Adjust selector as needed
    await page.fill('input[name="password"]', 'password123'); // Adjust selector as needed

    // 3. Click login button
    await page.click('button:has-text("Ingresar")');

    // 4. Verify redirection to dashboard
    await expect(page).toHaveURL(/\/dashboard/);
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-detail\client-detail.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-detail\client-detail.component.html
================================================================

<h3 class="text-lg leading-6 font-medium text-gray-900">Documentos</h3>
<p class="mt-1 max-w-2xl text-sm text-gray-500">Archivos adjuntos y estado de validaciÃ³n.</p>
<div>
    <button class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm">Subir
        Documento</button>
</div>
<ul role="list" class="divide-y divide-gray-200">
    <li *ngFor="let doc of client?.documentos" class="px-4 py-4 sm:px-6">
        <div class="flex items-center justify-between">
            <div class="text-sm font-medium text-blue-600 truncate">
                {{ doc.tipoDocumento }}
            </div>
            <div class="ml-2 flex-shrink-0 flex">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [ngClass]="{'bg-green-100 text-green-800': doc.estadoValidacion === 'Aprobado', 'bg-yellow-100 text-yellow-800': doc.estadoValidacion === 'Pendiente'}">
                    {{ doc.estadoValidacion }}
                </span>
            </div>
        </div>
        <div class="mt-2 sm:flex sm:justify-between">
            <div class="sm:flex">
                <p class="flex items-center text-sm text-gray-500">
                    Subido el {{ doc.createdAt | date }}
                </p>
            </div>
        </div>
    </li>
    <li *ngIf="!client?.documentos?.length" class="px-4 py-4 sm:px-6 text-sm text-gray-500 text-center">
        No hay documentos registrados.
    </li>
</ul>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-detail\client-detail.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { ClientDetailComponent } from './client-detail.component';

describe('ClientDetailComponent', () => {
  let component: ClientDetailComponent;
  let fixture: ComponentFixture<ClientDetailComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [ClientDetailComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(ClientDetailComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-detail\client-detail.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ActivatedRoute } from '@angular/router';
import { ClientsService } from '../../services/clients.service';
import { Cliente } from '../../models';

@Component({
  selector: 'app-client-detail',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './client-detail.component.html',
  styleUrls: ['./client-detail.component.css']
})
export class ClientDetailComponent implements OnInit {
  client: Cliente | null = null;

  constructor(
    private route: ActivatedRoute,
    private clientsService: ClientsService
  ) { }

  ngOnInit(): void {
    const id = +this.route.snapshot.paramMap.get('id')!;
    this.clientsService.getClient(id).subscribe(data => {
      this.client = data;
    });
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-form\client-form.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-form\client-form.component.html
================================================================

<div class="container mx-auto p-4">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md overflow-hidden md:max-w-lg">
        <div class="md:flex">
            <div class="w-full p-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Nuevo Cliente</h2>
                <form (ngSubmit)="onSubmit()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="nombre1">
                                Primer Nombre
                            </label>
                            <input [(ngModel)]="client.nombre1" name="nombre1"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="nombre1" type="text" placeholder="Juan" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="nombre2">
                                Segundo Nombre
                            </label>
                            <input [(ngModel)]="client.nombre2" name="nombre2"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="nombre2" type="text" placeholder="Andres">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="apellido1">
                                Primer Apellido
                            </label>
                            <input [(ngModel)]="client.apellido1" name="apellido1"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="apellido1" type="text" placeholder="Perez" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="apellido2">
                                Segundo Apellido
                            </label>
                            <input [(ngModel)]="client.apellido2" name="apellido2"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="apellido2" type="text" placeholder="Gonzalez">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="rut">
                            RUT
                        </label>
                        <input [(ngModel)]="client.rut" name="rut"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="rut" type="text" placeholder="12.345.678-9" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                                Email
                            </label>
                            <input [(ngModel)]="client.email" name="email"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="email" type="email" placeholder="juan@example.com" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="telefono">
                                Celular
                            </label>
                            <input [(ngModel)]="client.telefono" name="telefono"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="telefono" type="tel" placeholder="+569 1234 5678">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="fechaNacimiento">
                                Fecha Nacimiento
                            </label>
                            <input [(ngModel)]="client.fechaNacimiento" name="fechaNacimiento"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="fechaNacimiento" type="date">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="estadoCivil">
                                Estado Civil
                            </label>
                            <select [(ngModel)]="client.estadoCivil" name="estadoCivil"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="estadoCivil">
                                <option value="">Seleccione</option>
                                <option value="Soltero">Soltero</option>
                                <option value="Casado">Casado</option>
                                <option value="Viudo">Viudo</option>
                                <option value="Divorciado">Divorciado</option>
                                <option value="Conviviente Civil">Conviviente Civil</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="nacionalidad">
                                Nacionalidad
                            </label>
                            <input [(ngModel)]="client.nacionalidad" name="nacionalidad"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="nacionalidad" type="text" placeholder="Chilena">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="profesion">
                                ProfesiÃ³n
                            </label>
                            <input [(ngModel)]="client.profesion" name="profesion"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="profesion" type="text" placeholder="Ingeniero">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="renta">
                                Renta (CLP)
                            </label>
                            <input [(ngModel)]="client.renta" name="renta"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="renta" type="number" placeholder="1000000">
                        </div>
                    </div>

                    <h3 class="text-lg font-bold text-gray-800 mb-4 mt-4">DirecciÃ³n</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4 col-span-2">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="direccionCalle">
                                Calle
                            </label>
                            <input [(ngModel)]="client.direccionCalle" name="direccionCalle"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="direccionCalle" type="text" placeholder="Av. Providencia">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="direccionNumero">
                                NÃºmero
                            </label>
                            <input [(ngModel)]="client.direccionNumero" name="direccionNumero"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="direccionNumero" type="text" placeholder="1234">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="direccionComuna">
                                Comuna
                            </label>
                            <input [(ngModel)]="client.direccionComuna" name="direccionComuna"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="direccionComuna" type="text" placeholder="Providencia">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="direccionRegion">
                                RegiÃ³n
                            </label>
                            <input [(ngModel)]="client.direccionRegion" name="direccionRegion"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="direccionRegion" type="text" placeholder="Metropolitana">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="direccionPais">
                                PaÃ­s
                            </label>
                            <input [(ngModel)]="client.direccionPais" name="direccionPais"
                                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                id="direccionPais" type="text" placeholder="Chile">
                        </div>
                    </div>

                    <div class="flex items-center justify-end mt-6">
                        <button
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            type="submit">
                            Guardar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-form\client-form.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { ClientFormComponent } from './client-form.component';

describe('ClientFormComponent', () => {
  let component: ClientFormComponent;
  let fixture: ComponentFixture<ClientFormComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [ClientFormComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(ClientFormComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-form\client-form.component.ts
================================================================

import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { ClientsService } from '../../services/clients.service';
import { Cliente } from '../../models';

@Component({
  selector: 'app-client-form',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './client-form.component.html',
  styleUrls: ['./client-form.component.css']
})
export class ClientFormComponent {
  client: Partial<Cliente> = {};

  constructor(
    private clientsService: ClientsService,
    private router: Router
  ) { }

  onSubmit() {
    this.clientsService.createClient(this.client).subscribe(() => {
      this.router.navigate(['/clients']);
    });
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-list\client-list.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-list\client-list.component.html
================================================================

<div class="container mx-auto p-4">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">GestiÃ³n de Clientes</h1>
        <a routerLink="/clients/new" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Nuevo Cliente
        </a>
    </div>

    <div class="mb-4">
        <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()" placeholder="Buscar por nombre o RUT..."
            class="w-full p-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Nombre
                    </th>
                    <th
                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
            </thead>
        </table>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-list\client-list.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { ClientListComponent } from './client-list.component';

describe('ClientListComponent', () => {
  let component: ClientListComponent;
  let fixture: ComponentFixture<ClientListComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [ClientListComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(ClientListComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\client-list\client-list.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ClientsService } from '../../services/clients.service';
import { Cliente } from '../../models';
import { RouterModule } from '@angular/router';
import { FormsModule } from '@angular/forms';

@Component({
  selector: 'app-client-list',
  standalone: true,
  imports: [CommonModule, RouterModule, FormsModule],
  templateUrl: './client-list.component.html',
  styleUrls: ['./client-list.component.css']
})
export class ClientListComponent implements OnInit {
  clients: Cliente[] = [];
  searchTerm: string = '';

  constructor(private clientsService: ClientsService) { }

  ngOnInit(): void {
    this.loadClients();
  }

  loadClients() {
    this.clientsService.getClients(this.searchTerm).subscribe(data => {
      this.clients = data;
    });
  }

  onSearch() {
    this.loadClients();
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\commissions-list\commissions-list.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\commissions-list\commissions-list.component.html
================================================================

<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-6 text-gray-800">GestiÃ³n de Comisiones</h1>

    <div *ngIf="loading" class="text-center py-4">Cargando...</div>

    <div *ngIf="!loading" class="bg-white shadow overflow-hidden sm:rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Folio
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unidad
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agente
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor
                        Venta</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ComisiÃ³n
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let ficha of commissions">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ ficha.folio }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ficha.unidad.nombre }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ficha.agente?.nombre }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ ficha.valorTotalUf | number:'1.0-0'
                        }} UF</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">{{ ficha.comisionBrokerMonto
                        | number:'1.0-0' }} UF</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                            [ngClass]="getBadgeClass(ficha.estadoComisionBroker)">
                            {{ ficha.estadoComisionBroker }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <!-- Broker Actions -->
                        <button *ngIf="userRole === 'Broker' && ficha.estadoComisionBroker === 'Pendiente'"
                            (click)="updateStatus(ficha, 'Solicitar Factura')"
                            class="text-indigo-600 hover:text-indigo-900">
                            Solicitar Factura
                        </button>

                        <!-- Admin Actions -->
                        <div *ngIf="userRole === 'Admin' || userRole === 'Contabilidad'" class="space-x-2">
                            <button *ngIf="ficha.estadoComisionBroker === 'Solicitar Factura'"
                                (click)="updateStatus(ficha, 'Factura Recibida')"
                                class="text-blue-600 hover:text-blue-900">
                                Recibir Factura
                            </button>
                            <button *ngIf="ficha.estadoComisionBroker === 'Factura Recibida'"
                                (click)="updateStatus(ficha, 'Pagada')" class="text-green-600 hover:text-green-900">
                                Pagar
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\commissions-list\commissions-list.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { CommissionsListComponent } from './commissions-list.component';

describe('CommissionsListComponent', () => {
  let component: CommissionsListComponent;
  let fixture: ComponentFixture<CommissionsListComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [CommissionsListComponent]
    })
      .compileComponents();

    fixture = TestBed.createComponent(CommissionsListComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\commissions-list\commissions-list.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { CommissionsService } from '../../services/commissions.service';
import { AuthService } from '../../services/auth.service';
import { FichaVenta } from '../../models';

@Component({
  selector: 'app-commissions-list',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './commissions-list.component.html'
})
export class CommissionsListComponent implements OnInit {
  commissions: FichaVenta[] = [];
  loading = false;
  userRole: string = '';

  constructor(
    private commissionsService: CommissionsService,
    private authService: AuthService
  ) { }

  ngOnInit() {
    this.authService.currentUser$.subscribe(user => {
      if (user) {
        this.userRole = user.rol;
        this.loadCommissions();
      }
    });
  }

  loadCommissions() {
    this.loading = true;
    const request = this.userRole === 'Broker'
      ? this.commissionsService.getMyCommissions()
      : this.commissionsService.getAllCommissions();

    request.subscribe({
      next: (data) => {
        this.commissions = data;
        this.loading = false;
      },
      error: () => {
        this.loading = false;
      }
    });
  }

  updateStatus(ficha: FichaVenta, status: string) {
    this.commissionsService.updateStatus(ficha.id, status).subscribe(() => {
      ficha.estadoComisionBroker = status;
    });
  }

  getBadgeClass(status: string | undefined): string {
    switch (status) {
      case 'Pagada': return 'bg-green-100 text-green-800';
      case 'Factura Recibida': return 'bg-blue-100 text-blue-800';
      case 'Solicitar Factura': return 'bg-yellow-100 text-yellow-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\dashboard\dashboard.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\dashboard\dashboard.component.html
================================================================

<div class="p-6 bg-gray-50 min-h-screen">
  <h1 class="text-3xl font-bold text-gray-800 mb-8">Dashboard Gerencia</h1>

  <!-- KPIs -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" *ngIf="kpis">
    <!-- Ventas del Mes -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
      <div class="text-gray-500 text-sm font-medium uppercase mb-2">Ventas del Mes</div>
      <div class="text-3xl font-bold text-gray-800">{{ kpis.ventasMes }}</div>
    </div>

    <!-- Monto Total Fundit -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
      <div class="text-gray-500 text-sm font-medium uppercase mb-2">Monto Fundit Colocado</div>
      <div class="text-3xl font-bold text-gray-800">{{ kpis.totalFundit | currency:'CLP':'symbol-narrow':'1.0-0' }}</div>
    </div>

    <!-- Cuotas Atrasadas -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
      <div class="text-gray-500 text-sm font-medium uppercase mb-2">Cuotas Atrasadas</div>
      <div class="text-3xl font-bold text-gray-800">{{ kpis.cuotasAtrasadas }}</div>
    </div>

    <!-- Propiedades en Arriendo -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
      <div class="text-gray-500 text-sm font-medium uppercase mb-2">Arriendo Garantizado</div>
      <div class="text-3xl font-bold text-gray-800">{{ kpis.activeBenefits }}</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-6">Ventas por Broker</h2>
    <div class="h-[400px] w-full flex justify-center items-center">
      <ngx-charts-bar-vertical
        [view]="view"
        [scheme]="colorScheme"
        [results]="salesByBroker"
        [gradient]="gradient"
        [xAxis]="showXAxis"
        [yAxis]="showYAxis"
        [legend]="showLegend"
        [showXAxisLabel]="showXAxisLabel"
        [showYAxisLabel]="showYAxisLabel"
        [xAxisLabel]="xAxisLabel"
        [yAxisLabel]="yAxisLabel">
      </ngx-charts-bar-vertical>
    </div>
  </div>
</div>



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\dashboard\dashboard.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { NgxChartsModule } from '@swimlane/ngx-charts';
import { DashboardService, KPIs, SalesByBroker } from '../../services/dashboard.service';

@Component({
    selector: 'app-dashboard',
    standalone: true,
    imports: [CommonModule, NgxChartsModule],
    templateUrl: './dashboard.component.html',
    styleUrls: ['./dashboard.component.css']
})
export class DashboardComponent implements OnInit {
    kpis: KPIs | null = null;
    salesByBroker: SalesByBroker[] = [];

    // Chart options
    view: [number, number] = [700, 400];
    showXAxis = true;
    showYAxis = true;
    gradient = false;
    showLegend = true;
    showXAxisLabel = true;
    xAxisLabel = 'Broker';
    showYAxisLabel = true;
    yAxisLabel = 'Ventas';
    colorScheme = {
        domain: ['#5AA454', '#A10A28', '#C7B42C', '#AAAAAA']
    };

    constructor(private dashboardService: DashboardService) { }

    ngOnInit(): void {
        this.loadData();
    }

    loadData() {
        this.dashboardService.getKPIs().subscribe(data => {
            this.kpis = data;
        });

        this.dashboardService.getSalesByBroker().subscribe(data => {
            this.salesByBroker = data;
        });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\deed-tracking\deed-tracking.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\deed-tracking\deed-tracking.component.html
================================================================

<p>deed-tracking works!</p>



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\deed-tracking\deed-tracking.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { DeedTrackingComponent } from './deed-tracking.component';

describe('DeedTrackingComponent', () => {
  let component: DeedTrackingComponent;
  let fixture: ComponentFixture<DeedTrackingComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [DeedTrackingComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(DeedTrackingComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\deed-tracking\deed-tracking.component.ts
================================================================

import { Component } from '@angular/core';

@Component({
  selector: 'app-deed-tracking',
  standalone: true,
  imports: [],
  templateUrl: './deed-tracking.component.html',
  styleUrl: './deed-tracking.component.css'
})
export class DeedTrackingComponent {

}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\delivery-act\delivery-act.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\delivery-act\delivery-act.component.html
================================================================

<p>delivery-act works!</p>



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\delivery-act\delivery-act.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { DeliveryActComponent } from './delivery-act.component';

describe('DeliveryActComponent', () => {
  let component: DeliveryActComponent;
  let fixture: ComponentFixture<DeliveryActComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [DeliveryActComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(DeliveryActComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\delivery-act\delivery-act.component.ts
================================================================

import { Component } from '@angular/core';

@Component({
  selector: 'app-delivery-act',
  standalone: true,
  imports: [],
  templateUrl: './delivery-act.component.html',
  styleUrl: './delivery-act.component.css'
})
export class DeliveryActComponent {

}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\home\home.component.html
================================================================

<div class="bg-gray-50 min-h-screen">
    <!-- Hero Section -->
    <div class="relative bg-indigo-900 text-white overflow-hidden">
        <div class="absolute inset-0">
            <img src="assets/banner-projects.png" alt="Background" class="w-full h-full object-cover opacity-20">
        </div>
        <div class="relative container mx-auto px-4 py-24 sm:px-6 lg:px-8 flex flex-col items-center text-center">
            <h1 class="text-4xl font-extrabold tracking-tight sm:text-5xl lg:text-6xl mb-6">
                Bienvenido a Appimno
            </h1>
            <p class="text-xl text-indigo-200 max-w-2xl mx-auto mb-10">
                Tu plataforma integral para la gestiÃ³n inmobiliaria. Administra proyectos, clientes y comisiones en un
                solo lugar.
            </p>
        </div>
    </div>

    <!-- Navigation Cards -->
    <div class="container mx-auto px-4 py-12 -mt-16 relative z-10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Projects Card -->
            <a routerLink="/projects"
                class="group bg-white rounded-xl shadow-xl overflow-hidden transform transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl">
                <div class="h-48 overflow-hidden">
                    <img src="assets/banner-projects.png" alt="Proyectos"
                        class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500">
                </div>
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Proyectos</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <p class="text-gray-600">Explora y gestiona el inventario de unidades disponibles.</p>
                    <span class="mt-4 inline-block text-indigo-600 font-semibold group-hover:text-indigo-800">Ver
                        Proyectos &rarr;</span>
                </div>
            </a>

            <!-- Clients Card -->
            <a routerLink="/clients"
                class="group bg-white rounded-xl shadow-xl overflow-hidden transform transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl">
                <div class="h-48 overflow-hidden">
                    <img src="assets/banner-clients.png" alt="Clientes"
                        class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500">
                </div>
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Clientes</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <p class="text-gray-600">Administra tu base de datos de clientes y prospectos.</p>
                    <span class="mt-4 inline-block text-indigo-600 font-semibold group-hover:text-indigo-800">Gestionar
                        Clientes &rarr;</span>
                </div>
            </a>

            <!-- Commissions Card -->
            <a routerLink="/commissions"
                class="group bg-white rounded-xl shadow-xl overflow-hidden transform transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl">
                <div class="h-48 overflow-hidden">
                    <img src="assets/banner-commissions.png" alt="Comisiones"
                        class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500">
                </div>
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Comisiones</h2>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <p class="text-gray-600">Revisa el estado de tus ventas y comisiones pendientes.</p>
                    <span class="mt-4 inline-block text-indigo-600 font-semibold group-hover:text-indigo-800">Ver
                        Comisiones &rarr;</span>
                </div>
            </a>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\home\home.component.ts
================================================================

import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterLink } from '@angular/router';

@Component({
    selector: 'app-home',
    standalone: true,
    imports: [CommonModule, RouterLink],
    templateUrl: './home.component.html'
})
export class HomeComponent { }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\building-viewer\building-viewer.component.css
================================================================

.building-viewer-container {
    padding: 20px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    max-width: 1200px;
    margin: 0 auto;
}

.header-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    border-bottom: 1px solid #eee;
    padding-bottom: 20px;
}

h1 {
    margin: 0;
    font-size: 1.8rem;
    color: #333;
}

.selector-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
    background-color: white;
    cursor: pointer;
}

.loading-indicator {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

.building-info {
    margin-bottom: 20px;
}

.building-info h2 {
    margin: 0 0 5px 0;
    color: #444;
}

.stats {
    color: #888;
    font-size: 0.9rem;
}

.floors-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\building-viewer\building-viewer.component.html
================================================================

<div class="building-viewer-container">
    <div class="header-controls">
        <h1>Disponibilidad DinÃ¡mica</h1>
        <div class="selector-wrapper">
            <label for="building-select">Seleccionar Edificio:</label>
            <select id="building-select" (change)="onBuildingSelect($event)" [value]="selectedBuildingId">
                <option *ngFor="let b of buildings" [value]="b.id">{{ b.name }}</option>
            </select>
        </div>
    </div>

    <div class="loading-indicator" *ngIf="loading">
        Cargando datos del edificio...
    </div>

    <div class="matrix-container" *ngIf="buildingData && !loading">
        <div class="building-info">
            <h2>{{ buildingData.name }}</h2>
            <div class="stats">
                <span>Pisos: {{ buildingData.totalFloors }}</span>
            </div>
        </div>

        <div class="floors-list">
            <app-floor-row *ngFor="let floor of buildingData.floorStructure" [floor]="floor">
            </app-floor-row>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\building-viewer\building-viewer.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { InventoryService } from '../../../services/inventory.service';
import { BuildingResponseDTO } from '../../../models/inventory.model';
import { FloorRowComponent } from '../floor-row/floor-row.component';

@Component({
    selector: 'app-building-viewer',
    standalone: true,
    imports: [CommonModule, FloorRowComponent],
    templateUrl: './building-viewer.component.html',
    styleUrls: ['./building-viewer.component.css']
})
export class BuildingViewerComponent implements OnInit {
    selectedBuildingId: string = 'A';
    buildingData: BuildingResponseDTO | null = null;
    buildings: { id: string, name: string }[] = [];
    loading: boolean = false;

    constructor(private inventoryService: InventoryService) { }

    ngOnInit(): void {
        this.loadBuildings();
        this.loadBuildingData(this.selectedBuildingId);
    }

    loadBuildings(): void {
        this.inventoryService.getBuildings().subscribe(buildings => {
            this.buildings = buildings;
        });
    }

    onBuildingSelect(event: Event): void {
        const selectElement = event.target as HTMLSelectElement;
        this.selectedBuildingId = selectElement.value;
        this.loadBuildingData(this.selectedBuildingId);
    }

    loadBuildingData(buildingId: string): void {
        this.loading = true;
        this.inventoryService.getBuildingData(buildingId).subscribe(data => {
            this.buildingData = data;
            this.loading = false;
        });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\floor-row\floor-row.component.css
================================================================

:host {
    display: block;
    margin-bottom: 10px;
}

.floor-row {
    display: flex;
    align-items: center;
    background-color: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    transition: background-color 0.2s;
}

.floor-row:hover {
    background-color: #f0f0f0;
}

.floor-label {
    width: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    color: #555;
    font-size: 0.9rem;
    border-right: 1px solid #ddd;
    padding-right: 15px;
}

.floor-label strong {
    font-size: 1.5rem;
    color: #333;
}

.units-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    flex: 1;
}


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\floor-row\floor-row.component.html
================================================================

<div class="floor-row">
    <div class="floor-label">
        <span>Piso</span>
        <strong>{{ floor.floorNumber }}</strong>
    </div>
    <div class="units-container">
        <app-unit-card *ngFor="let unit of floor.units" [unit]="unit">
        </app-unit-card>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\floor-row\floor-row.component.ts
================================================================

import { Component, Input } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FloorDTO } from '../../../models/inventory.model';
import { UnitCardComponent } from '../unit-card/unit-card.component';

@Component({
    selector: 'app-floor-row',
    standalone: true,
    imports: [CommonModule, UnitCardComponent],
    templateUrl: './floor-row.component.html',
    styleUrls: ['./floor-row.component.css']
})
export class FloorRowComponent {
    @Input() floor!: FloorDTO;
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\unit-card\unit-card.component.css
================================================================

:host {
  display: block;
}

.unit-card {
  position: relative;
  width: 60px;
  height: 60px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  border: 1px solid transparent;
  background-color: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
}

.unit-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
  z-index: 10;
}

.unit-number {
  font-weight: 600;
  font-size: 0.9rem;
  color: #333;
}

/* Status Styles using CSS Variables */
.status-available {
  border-color: #4CAF50; /* Green */
  background-color: #f1f8e9;
}
.status-available .unit-number { color: #2e7d32; }

.status-reserved {
  background-color: #fff8e1; /* Amber/Orange light */
  border-color: #ffb300;
}
.status-reserved .unit-number { color: #f57f17; }

.status-sold {
  background-color: #f5f5f5; /* Grey */
  border-color: #bdbdbd;
  opacity: 0.8;
}
.status-sold .unit-number { color: #757575; }

/* Tooltip Styles */
.unit-tooltip {
  visibility: hidden;
  width: 160px;
  background-color: #333;
  color: #fff;
  text-align: left;
  border-radius: 6px;
  padding: 10px;
  position: absolute;
  z-index: 100;
  bottom: 125%; /* Position above */
  left: 50%;
  margin-left: -80px;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
  font-size: 0.8rem;
}

.unit-tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #333 transparent transparent transparent;
}

.unit-card:hover .unit-tooltip {
  visibility: visible;
  opacity: 1;
}

.tooltip-header {
  font-weight: bold;
  border-bottom: 1px solid #555;
  padding-bottom: 5px;
  margin-bottom: 5px;
  text-align: center;
}

.tooltip-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 3px;
}

.tooltip-row.price {
  font-weight: bold;
  color: #ffd700; /* Gold */
  margin-top: 5px;
}

.tooltip-status {
  text-align: center;
  margin-top: 5px;
  padding: 2px 5px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-weight: bold;
  text-transform: uppercase;
}

/* Override status colors for tooltip tags */
.tooltip-status.status-available { background-color: #4CAF50; color: white; }
.tooltip-status.status-reserved { background-color: #ffb300; color: black; }
.tooltip-status.status-sold { background-color: #9e9e9e; color: white; }



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\unit-card\unit-card.component.html
================================================================

<div class="unit-card" [ngClass]="statusClass">
    <div class="unit-number">{{ unit.number }}</div>
    <div class="unit-status-indicator"></div>

    <!-- Tooltip -->
    <div class="unit-tooltip">
        <div class="tooltip-header">Unit {{ unit.number }}</div>
        <div class="tooltip-row">
            <span>Type:</span> <span>{{ unit.typology }}</span>
        </div>
        <div class="tooltip-row">
            <span>Area:</span> <span>{{ unit.area }} mÂ²</span>
        </div>
        <div class="tooltip-row">
            <span>Orient:</span> <span>{{ unit.orientation }}</span>
        </div>
        <div class="tooltip-row price">
            <span>Price:</span> <span>{{ unit.price | number }} UF</span>
        </div>
        <div class="tooltip-status" [ngClass]="statusClass">
            {{ unit.status }}
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory\unit-card\unit-card.component.ts
================================================================

import { Component, Input } from '@angular/core';
import { CommonModule } from '@angular/common';
import { UnitDTO } from '../../../models/inventory.model';

@Component({
    selector: 'app-unit-card',
    standalone: true,
    imports: [CommonModule],
    templateUrl: './unit-card.component.html',
    styleUrls: ['./unit-card.component.css']
})
export class UnitCardComponent {
    @Input() unit!: UnitDTO;

    get statusClass(): string {
        switch (this.unit.status) {
            case 'AVAILABLE': return 'status-available';
            case 'RESERVED': return 'status-reserved';
            case 'SOLD': return 'status-sold';
            default: return '';
        }
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory-view\inventory-view.component.css
================================================================

/* Estilos personalizados para el scroll horizontal */
:host ::ng-deep .overflow-x-auto {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f7fafc;
}

:host ::ng-deep .overflow-x-auto::-webkit-scrollbar {
    height: 8px;
}

:host ::ng-deep .overflow-x-auto::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 4px;
}

:host ::ng-deep .overflow-x-auto::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}

:host ::ng-deep .overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory-view\inventory-view.component.html
================================================================

<div class="w-full">
    <!-- Legend -->
    <div class="flex justify-center space-x-6 mb-4">
        <div class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span> Disponible</div>
        <div class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span> Reservada</div>
        <div class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span> Vendida</div>
    </div>

    <!-- Building View with Horizontal Scroll -->
    <div class="overflow-x-auto pb-4">
        <div class="inline-block min-w-full">
            <div class="flex flex-col space-y-2">
                <div *ngFor="let floor of floors" class="flex items-center">
                    <div class="w-12 font-bold text-gray-700 text-right pr-2 text-xs flex-shrink-0">P{{
                        floor.floorNumber }}</div>
                    <div class="flex space-x-1.5">
                        <div *ngFor="let unit of floor.units"
                            class="group relative flex-shrink-0 w-20 p-1.5 rounded shadow-md text-white cursor-pointer hover:shadow-lg transition-all duration-200"
                            [ngClass]="getStatusColor(unit.estado)">
                            <div class="font-bold text-xs">{{ unit.nombre }}</div>
                            <div class="text-[10px] opacity-90">{{ unit.tipologia }}</div>
                            <div class="text-[10px] opacity-90">{{ unit.metrosCuadrados }} mÂ²</div>
                            <div class="mt-0.5 font-semibold text-[10px]">{{ unit.valorUf | number:'1.0-0' }} UF</div>

                            <!-- Tooltip -->
                            <div
                                class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10 pointer-events-none">
                                <div class="font-bold text-sm mb-2 border-b border-gray-700 pb-2">{{ unit.nombre }} - {{
                                    unit.tipologia }}</div>

                                <div class="space-y-1">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Estado:</span>
                                        <span class="font-semibold">{{ unit.estado }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Superficie:</span>
                                        <span>{{ unit.metrosCuadrados }} mÂ²</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Precio:</span>
                                        <span class="font-bold text-green-400">{{ unit.valorUf | number:'1.0-0' }}
                                            UF</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Piso:</span>
                                        <span>{{ unit.piso }}</span>
                                    </div>

                                    <!-- Conditional info based on status -->
                                    <div *ngIf="unit.estado === 'Vendida'" class="mt-2 pt-2 border-t border-gray-700">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">EscrituraciÃ³n:</span>
                                            <span class="text-yellow-400">Pendiente</span>
                                        </div>
                                    </div>

                                    <div *ngIf="unit.estado === 'Disponible'"
                                        class="mt-2 pt-2 border-t border-gray-700 text-green-300">
                                        <div class="text-xs">âœ“ Disponible para reserva inmediata</div>
                                        <div class="text-xs">âœ“ Excelente orientaciÃ³n</div>
                                        <div class="text-xs">âœ“ Financiamiento disponible</div>
                                    </div>

                                    <div *ngIf="unit.estado === 'Reservada'" class="mt-2 pt-2 border-t border-gray-700">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Reserva expira:</span>
                                            <span class="text-yellow-400">{{ unit.reservaExpiraEn ?
                                                (unit.reservaExpiraEn | date:'short') : 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Arrow -->
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                    <div
                                        class="w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory-view\inventory-view.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { InventoryViewComponent } from './inventory-view.component';

describe('InventoryViewComponent', () => {
  let component: InventoryViewComponent;
  let fixture: ComponentFixture<InventoryViewComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [InventoryViewComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(InventoryViewComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\inventory-view\inventory-view.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ActivatedRoute } from '@angular/router';
import { ProjectsService } from '../../services/projects.service';
import { Unidad, Proyecto } from '../../models';

@Component({
  selector: 'app-inventory-view',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './inventory-view.component.html',
  styleUrls: ['./inventory-view.component.css']
})
export class InventoryViewComponent implements OnInit {
  units: Unidad[] = [];
  filteredUnits: Unidad[] = [];
  projectId!: number;

  constructor(
    private route: ActivatedRoute,
    private projectsService: ProjectsService
  ) { }

  ngOnInit(): void {
    this.route.paramMap.subscribe(params => {
      this.projectId = +params.get('id')!;
      this.loadUnits();
    });
  }

  floors: { floorNumber: number, units: Unidad[] }[] = [];

  loadUnits() {
    this.projectsService.getUnits(this.projectId).subscribe(data => {
      this.units = data;
      this.filteredUnits = data;
      this.groupUnitsByFloor();
    });
  }

  groupUnitsByFloor() {
    const grouped = this.filteredUnits.reduce((acc, unit) => {
      const floor = unit.piso;
      if (!acc[floor]) {
        acc[floor] = [];
      }
      acc[floor].push(unit);
      return acc;
    }, {} as { [key: number]: Unidad[] });

    this.floors = Object.keys(grouped)
      .map(floor => ({
        floorNumber: +floor,
        units: grouped[+floor].sort((a, b) => {
          // Extraer los Ãºltimos 2 dÃ­gitos del nombre (D-201 -> 01, D-S1015 -> 15)
          const getLastTwoDigits = (name: string) => {
            const match = name.match(/(\d{2})$/);
            return match ? parseInt(match[1]) : 0;
          };
          return getLastTwoDigits(a.nombre) - getLastTwoDigits(b.nombre);
        })
      }))
      .sort((a, b) => b.floorNumber - a.floorNumber); // Sort floors descending (top to bottom)
  }

  getStatusColor(status: string): string {
    switch (status) {
      case 'Disponible': return 'bg-green-500';
      case 'Reservada': return 'bg-yellow-500';
      case 'Vendida': return 'bg-red-500';
      default: return 'bg-gray-500';
    }
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\payment-plan\payment-plan.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\payment-plan\payment-plan.component.html
================================================================

<div *ngIf="plan" class="bg-white shadow rounded-lg overflow-hidden">
    <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Plan de Pago</h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">Detalle de cuotas y estado de pago.</p>
    </div>

    <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded">
                <div class="text-sm text-gray-500">Monto Total</div>
                <div class="text-xl font-bold">{{ plan.montoTotal | number:'1.0-0' }} UF</div>
            </div>
            <div class="bg-green-50 p-4 rounded">
                <div class="text-sm text-gray-500">Pie Pagado</div>
                <div class="text-xl font-bold">{{ plan.montoPie | number:'1.0-0' }} UF</div>
            </div>
            <div class="bg-yellow-50 p-4 rounded">
                <div class="text-sm text-gray-500">Saldo a Pagar</div>
                <div class="text-xl font-bold">{{ plan.saldoAPagar | number:'1.0-0' }} UF</div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Vencimiento</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Estado</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr *ngFor="let cuota of plan.cuotas">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ cuota.numeroCuota
                            }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ cuota.fechaVencimiento |
                            date:'dd/MM/yyyy' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ cuota.montoCuota |
                            number:'1.0-0' }} UF</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                [class.bg-green-100]="cuota.estado === 'Pagada'"
                                [class.text-green-800]="cuota.estado === 'Pagada'"
                                [class.bg-yellow-100]="cuota.estado === 'Pendiente'"
                                [class.text-yellow-800]="cuota.estado === 'Pendiente'">
                                {{ cuota.estado }}
                            </span>
                            <div *ngIf="cuota.fechaPago" class="text-xs text-gray-500 mt-1">
                                {{ cuota.fechaPago | date:'dd/MM/yyyy' }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button *ngIf="cuota.estado === 'Pendiente'" (click)="payCuota(cuota)"
                                class="text-indigo-600 hover:text-indigo-900 font-bold">
                                Pagar
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\payment-plan\payment-plan.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { PaymentPlanComponent } from './payment-plan.component';

describe('PaymentPlanComponent', () => {
  let component: PaymentPlanComponent;
  let fixture: ComponentFixture<PaymentPlanComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [PaymentPlanComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(PaymentPlanComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\payment-plan\payment-plan.component.ts
================================================================

import { Component, Input, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FinanceService } from '../../services/finance.service';
import { PlanPago, Cuota } from '../../models';

@Component({
  selector: 'app-payment-plan',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './payment-plan.component.html',
  styleUrls: ['./payment-plan.component.css']
})
export class PaymentPlanComponent implements OnInit {
  @Input() fichaId: number | null = null;
  plan: PlanPago | null = null;

  constructor(private financeService: FinanceService) { }

  ngOnInit() {
    if (this.fichaId) {
      this.loadPlan();
    }
  }

  loadPlan() {
    if (this.fichaId) {
      this.financeService.getPlan(this.fichaId).subscribe(data => this.plan = data);
    }
  }

  payCuota(cuota: Cuota) {
    if (confirm(`Â¿Confirmar pago de cuota #${cuota.numeroCuota}?`)) {
      this.financeService.markAsPaid(cuota.id).subscribe(() => {
        this.loadPlan(); // Reload to update status
      });
    }
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\post-sales\deed-tracking\deed-tracking.component.html
================================================================

<div class="bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-700">Seguimiento de Escritura</h2>

    <div *ngIf="loading" class="text-gray-500">Cargando...</div>

    <div *ngIf="!loading && !escritura">
        <p class="text-gray-500 mb-4">No se ha iniciado el proceso de escrituraciÃ³n.</p>
        <button (click)="createEscritura()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Iniciar EscrituraciÃ³n
        </button>
    </div>

    <div *ngIf="!loading && escritura" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Estado</label>
                <select [(ngModel)]="escritura.estado" (change)="updateEscritura()"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">NotarÃ­a</label>
                <input type="text" [(ngModel)]="escritura.notaria" (blur)="updateEscritura()"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Repertorio</label>
                <input type="text" [(ngModel)]="escritura.repertorio" (blur)="updateEscritura()"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Fecha Firma</label>
                <input type="date" [(ngModel)]="escritura.fechaFirma" (blur)="updateEscritura()"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\post-sales\deed-tracking\deed-tracking.component.ts
================================================================

import { Component, Input, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { PostSalesService, Escritura } from '../../../services/post-sales.service';

@Component({
    selector: 'app-deed-tracking',
    standalone: true,
    imports: [CommonModule, FormsModule],
    templateUrl: './deed-tracking.component.html'
})
export class DeedTrackingComponent implements OnInit {
    @Input() fichaId!: number;
    escritura: Escritura | null = null;
    loading = false;

    estados = ['En RedacciÃ³n', 'Firmada', 'Ingresada CBR', 'Inscrita CBR', 'Entregada'];

    constructor(private postSalesService: PostSalesService) { }

    ngOnInit() {
        this.loadEscritura();
    }

    loadEscritura() {
        this.loading = true;
        this.postSalesService.getEscritura(this.fichaId).subscribe({
            next: (data) => {
                this.escritura = data;
                this.loading = false;
            },
            error: () => {
                this.loading = false;
            }
        });
    }

    createEscritura() {
        this.postSalesService.createEscritura(this.fichaId, { estado: 'En RedacciÃ³n' }).subscribe(data => {
            this.escritura = data;
        });
    }

    updateEscritura() {
        if (!this.escritura) return;
        this.postSalesService.updateEscritura(this.escritura.id, this.escritura).subscribe(data => {
            this.escritura = data;
            alert('Escritura actualizada');
        });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\post-sales\delivery-act\delivery-act.component.html
================================================================

<div class="bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-700">Acta de Entrega</h2>

    <div *ngIf="loading" class="text-gray-500">Cargando...</div>

    <div *ngIf="!loading && !entrega">
        <p class="text-gray-500 mb-4">No hay entrega programada.</p>
        <div class="flex gap-4">
            <input type="date" [(ngModel)]="scheduleDate"
                class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            <button (click)="schedule()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Agendar Entrega
            </button>
        </div>
    </div>

    <div *ngIf="!loading && entrega" class="space-y-4">
        <div *ngIf="!entrega.firmada">
            <p class="text-lg font-medium text-blue-600 mb-2">
                Entrega Programada: {{ entrega.fechaProgramada | date:'dd/MM/yyyy' }}
            </p>

            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">Observaciones</label>
                <textarea [(ngModel)]="observations" rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
            </div>

            <button (click)="complete()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Firmar Acta de Entrega
            </button>
        </div>

        <div *ngIf="entrega.firmada" class="bg-green-50 p-4 rounded-md">
            <p class="text-green-800 font-semibold">Entrega Realizada</p>
            <p class="text-sm text-green-600">Fecha: {{ entrega.fechaReal | date:'dd/MM/yyyy HH:mm' }}</p>
            <p class="text-sm text-gray-600 mt-2">Observaciones: {{ entrega.observaciones || 'Ninguna' }}</p>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\post-sales\delivery-act\delivery-act.component.ts
================================================================

import { Component, Input, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { PostSalesService, Entrega } from '../../../services/post-sales.service';

@Component({
    selector: 'app-delivery-act',
    standalone: true,
    imports: [CommonModule, FormsModule],
    templateUrl: './delivery-act.component.html'
})
export class DeliveryActComponent implements OnInit {
    @Input() fichaId!: number;
    entrega: Entrega | null = null;
    loading = false;
    scheduleDate: string = '';
    observations: string = '';

    constructor(private postSalesService: PostSalesService) { }

    ngOnInit() {
        this.loadEntrega();
    }

    loadEntrega() {
        this.loading = true;
        this.postSalesService.getEntrega(this.fichaId).subscribe({
            next: (data) => {
                this.entrega = data;
                if (data && data.fechaProgramada) {
                    this.scheduleDate = new Date(data.fechaProgramada).toISOString().split('T')[0];
                }
                this.loading = false;
            },
            error: () => {
                this.loading = false;
            }
        });
    }

    schedule() {
        if (!this.scheduleDate) return;
        this.postSalesService.scheduleEntrega(this.fichaId, new Date(this.scheduleDate)).subscribe(data => {
            this.entrega = data;
            alert('Entrega agendada');
        });
    }

    complete() {
        if (!this.entrega) return;
        this.postSalesService.completeEntrega(this.entrega.id, this.observations).subscribe(data => {
            this.entrega = data;
            alert('Entrega realizada con Ã©xito');
        });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\project-list\project-list.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\project-list\project-list.component.html
================================================================

<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Proyectos Disponibles</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div *ngFor="let project of projects"
            class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300">
            <img [src]="project.imagenPrincipalUrl || 'https://via.placeholder.com/400x200'" alt="{{ project.nombre }}"
                class="w-full h-48 object-cover">
            <div class="p-4">
                <h2 class="text-xl font-semibold mb-2">{{ project.nombre }}</h2>
                <p class="text-gray-600 mb-2">{{ project.comuna }}</p>
                <a [routerLink]="['/inventory', project.id]"
                    class="block w-full text-center bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors">
                    Ver Inventario
                </a>
            </div>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\project-list\project-list.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { ProjectListComponent } from './project-list.component';

describe('ProjectListComponent', () => {
  let component: ProjectListComponent;
  let fixture: ComponentFixture<ProjectListComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [ProjectListComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(ProjectListComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\project-list\project-list.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ProjectsService } from '../../services/projects.service';
import { Proyecto } from '../../models';
import { RouterModule } from '@angular/router';

@Component({
  selector: 'app-project-list',
  standalone: true,
  imports: [CommonModule, RouterModule],
  templateUrl: './project-list.component.html',
  styleUrls: ['./project-list.component.css']
})
export class ProjectListComponent implements OnInit {
  projects: Proyecto[] = [];

  constructor(private projectsService: ProjectsService) { }

  ngOnInit(): void {
    this.projectsService.getProjects().subscribe(data => {
      this.projects = data;
    });
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-detail\sales-detail.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-detail\sales-detail.component.html
================================================================

<div *ngIf="ficha" class="container mx-auto p-4">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Ficha de Venta: {{ ficha.folio }}</h1>
            <span class="px-2 py-1 text-sm font-semibold rounded-full"
                [class.bg-yellow-100]="ficha.estadoFicha === 'Borrador'"
                [class.text-yellow-800]="ficha.estadoFicha === 'Borrador'"
                [class.bg-green-100]="ficha.estadoFicha === 'Confirmada'"
                [class.text-green-800]="ficha.estadoFicha === 'Confirmada'">
                {{ ficha.estadoFicha }}
            </span>
        </div>
        <button (click)="downloadPromesa()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            Descargar Promesa
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Unit Info -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Unidad</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500">Unidad</label>
                    <p class="text-lg font-medium">{{ ficha.unidad.nombre }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">TipologÃ­a</label>
                    <p class="text-lg font-medium">{{ ficha.unidad.tipologia }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">Valor</label>
                    <p class="text-lg font-medium">{{ ficha.unidad.valorUf | number:'1.0-0' }} UF</p>
                </div>
            </div>
        </div>

        <!-- Client Info -->
        <div class="bg-white rounded-lg shadow p-6" *ngIf="ficha.clientePrincipal">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Cliente Principal</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500">Nombre</label>
                    <p class="text-lg font-medium">{{ ficha.clientePrincipal.nombreCompleto }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">RUT</label>
                    <p class="text-lg font-medium">{{ ficha.clientePrincipal.rut }}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">Email</label>
                    <p class="text-lg font-medium">{{ ficha.clientePrincipal.email }}</p>
                    <div *ngIf="ficha" class="container mx-auto p-4">
                        <div class="mb-6 flex justify-between items-center">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">Ficha de Venta: {{ ficha.folio }}</h1>
                                <span class="px-2 py-1 text-sm font-semibold rounded-full"
                                    [class.bg-yellow-100]="ficha.estadoFicha === 'Borrador'"
                                    [class.text-yellow-800]="ficha.estadoFicha === 'Borrador'"
                                    [class.bg-green-100]="ficha.estadoFicha === 'Confirmada'"
                                    [class.text-green-800]="ficha.estadoFicha === 'Confirmada'">
                                    {{ ficha.estadoFicha }}
                                </span>
                            </div>
                            <button (click)="downloadPromesa()"
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Descargar Promesa
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- Unit Info -->
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-semibold mb-4 text-gray-700">Unidad</h2>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500">Unidad</label>
                                        <p class="text-lg font-medium">{{ ficha.unidad.nombre }}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500">TipologÃ­a</label>
                                        <p class="text-lg font-medium">{{ ficha.unidad.tipologia }}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500">Valor</label>
                                        <p class="text-lg font-medium">{{ ficha.unidad.valorUf | number:'1.0-0' }} UF
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Client Info -->
                            <div class="bg-white rounded-lg shadow p-6" *ngIf="ficha.clientePrincipal">
                                <h2 class="text-xl font-semibold mb-4 text-gray-700">Cliente Principal</h2>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500">Nombre</label>
                                        <p class="text-lg font-medium">{{ ficha.clientePrincipal.nombreCompleto }}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500">RUT</label>
                                        <p class="text-lg font-medium">{{ ficha.clientePrincipal.rut }}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-500">Email</label>
                                        <p class="text-lg font-medium">{{ ficha.clientePrincipal.email }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Plan -->
                        <div class="mb-8">
                            <app-payment-plan [fichaId]="ficha.id"></app-payment-plan>
                        </div>

                        <!-- Post-Sales -->
                        <div *ngIf="ficha.estadoFicha === 'Confirmada'"
                            class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <app-deed-tracking [fichaId]="ficha.id"></app-deed-tracking>
                            <app-delivery-act [fichaId]="ficha.id"></app-delivery-act>
                        </div>
                    </div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-detail\sales-detail.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { SalesDetailComponent } from './sales-detail.component';

describe('SalesDetailComponent', () => {
  let component: SalesDetailComponent;
  let fixture: ComponentFixture<SalesDetailComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [SalesDetailComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(SalesDetailComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-detail\sales-detail.component.ts
================================================================

import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ActivatedRoute } from '@angular/router';
import { SalesService } from '../../services/sales.service';
import { FichaVenta } from '../../models';
import { PaymentPlanComponent } from '../payment-plan/payment-plan.component';
import { DeedTrackingComponent } from '../post-sales/deed-tracking/deed-tracking.component';
import { DeliveryActComponent } from '../post-sales/delivery-act/delivery-act.component';

@Component({
  selector: 'app-sales-detail',
  standalone: true,
  imports: [CommonModule, PaymentPlanComponent, DeedTrackingComponent, DeliveryActComponent],
  templateUrl: './sales-detail.component.html',
  styleUrls: ['./sales-detail.component.css']
})
export class SalesDetailComponent implements OnInit {
  ficha: FichaVenta | null = null;

  constructor(
    private route: ActivatedRoute,
    private salesService: SalesService
  ) { }

  ngOnInit() {
    const id = this.route.snapshot.paramMap.get('id');
    if (id) {
      this.salesService.getOne(+id).subscribe(data => this.ficha = data);
    }
  }

  downloadPromesa() {
    if (this.ficha) {
      window.open(`http://localhost:3000/documents/promesa/${this.ficha.id}`, '_blank');
    }
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-client\step-client.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-client\step-client.component.html
================================================================

<div class="space-y-6">
    <h2 class="text-xl font-semibold text-gray-800">Seleccionar Cliente</h2>

    <div class="flex space-x-2">
        <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="search()" placeholder="Buscar por nombre o RUT..."
            class="flex-1 p-2 border rounded">
        <button (click)="search()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Buscar</button>
    </div>

    <div *ngIf="clients.length > 0" class="border rounded overflow-hidden">
        <table class="min-w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left">Nombre</th>
                    <th class="px-4 py-2 text-left">RUT</th>
                    <th class="px-4 py-2 text-left">AcciÃ³n</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let client of clients" [class.bg-blue-50]="selectedClient?.id === client.id"
                    class="border-t hover:bg-gray-50">
                    <td class="px-4 py-2">{{ client.nombreCompleto }}</td>
                    <td class="px-4 py-2">{{ client.rut }}</td>
                    <td class="px-4 py-2">
                        <button (click)="selectClient(client)"
                            class="text-blue-600 hover:underline">Seleccionar</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="flex justify-between mt-6">
        <button (click)="back.emit()" class="text-gray-600 hover:text-gray-800">AtrÃ¡s</button>
        <button (click)="confirm()" [disabled]="!selectedClient"
            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
            Siguiente
        </button>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-client\step-client.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { StepClientComponent } from './step-client.component';

describe('StepClientComponent', () => {
  let component: StepClientComponent;
  let fixture: ComponentFixture<StepClientComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [StepClientComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(StepClientComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-client\step-client.component.ts
================================================================

import { Component, EventEmitter, Output } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { ClientsService } from '../../../services/clients.service';
import { Cliente } from '../../../models';

@Component({
  selector: 'app-step-client',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './step-client.component.html',
  styleUrls: ['./step-client.component.css']
})
export class StepClientComponent {
  @Output() clientSelected = new EventEmitter<Cliente>();
  @Output() back = new EventEmitter<void>();

  searchTerm: string = '';
  clients: Cliente[] = [];
  selectedClient: Cliente | null = null;

  constructor(private clientsService: ClientsService) { }

  search() {
    this.clientsService.getClients(this.searchTerm).subscribe(data => {
      this.clients = data;
    });
  }

  selectClient(client: Cliente) {
    this.selectedClient = client;
  }

  confirm() {
    if (this.selectedClient) {
      this.clientSelected.emit(this.selectedClient);
    }
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-payment\step-payment.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-payment\step-payment.component.html
================================================================

<div class="p-6 bg-white rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">DefiniciÃ³n Financiera</h2>

    <!-- Resumen Unidad -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <div class="flex justify-between items-center mb-2">
            <span class="text-gray-600">Valor Base Unidad:</span>
            <span class="font-semibold text-lg">{{ unitValue | number:'1.0-2' }} UF</span>
        </div>
    </div>

    <!-- Descuento -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Descuento (%)</label>
        <div class="flex items-center gap-4">
            <input type="number" [(ngModel)]="descuentoPorcentaje" (ngModelChange)="onDescuentoChange()" min="0"
                max="15" class="w-24 p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            <span class="text-red-600 font-medium">- {{ valorDescuento | number:'1.0-2' }} UF</span>
        </div>
        <p class="text-xs text-gray-500 mt-1">MÃ¡ximo 15%</p>
    </div>

    <!-- Adicionales -->
    <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-800 mb-3">Adicionales</h3>
        <div class="flex flex-col gap-3">
            <label class="flex items-center justify-between p-3 border rounded-md hover:bg-gray-50 cursor-pointer">
                <div class="flex items-center">
                    <input type="checkbox" [(ngModel)]="incluyeEstacionamiento" (change)="onOptionalChange()"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="ml-3 text-gray-700">Estacionamiento</span>
                </div>
                <span class="font-medium">+ {{ VALOR_ESTACIONAMIENTO }} UF</span>
            </label>

            <label class="flex items-center justify-between p-3 border rounded-md hover:bg-gray-50 cursor-pointer">
                <div class="flex items-center">
                    <input type="checkbox" [(ngModel)]="incluyeBodega" (change)="onOptionalChange()"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="ml-3 text-gray-700">Bodega</span>
                </div>
                <span class="font-medium">+ {{ VALOR_BODEGA }} UF</span>
            </label>
        </div>
    </div>

    <!-- Aporte Inmobiliaria -->
    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
        <label class="flex items-center justify-between cursor-pointer">
            <div class="flex items-center">
                <input type="checkbox" [(ngModel)]="usaAporteInmobiliaria" (change)="onOptionalChange()"
                    class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <div class="ml-3">
                    <span class="block text-sm font-medium text-blue-900">Aporte Inmobiliaria (10%)</span>
                    <span class="block text-xs text-blue-700">Suma 10% al valor total para cubrir pie</span>
                </div>
            </div>
            <span class="font-bold text-blue-800">+ {{ valorAporte | number:'1.0-2' }} UF</span>
        </label>
    </div>

    <!-- Total a Financiar -->
    <div class="mb-8 p-4 bg-gray-800 text-white rounded-lg flex justify-between items-center">
        <span class="text-lg">Valor Total Venta:</span>
        <span class="text-3xl font-bold">{{ valorTotal | number:'1.0-2' }} UF</span>
    </div>

    <!-- Forma de Pago -->
    <div class="mb-8">
        <h3 class="text-lg font-medium text-gray-800 mb-4">Forma de Pago</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Reserva</label>
                <input type="number" [(ngModel)]="formaPago.reserva" (ngModelChange)="onPaymentChange()"
                    class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ahorro / Transferencia</label>
                <input type="number" [(ngModel)]="formaPago.ahorro" (ngModelChange)="onPaymentChange()"
                    class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Aporte Inmobiliaria</label>
                <input type="number" [(ngModel)]="formaPago.aporteInmobiliario" disabled
                    class="w-full p-2 border rounded-md bg-gray-100 text-gray-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">CrÃ©dito Fundit</label>
                <input type="number" [(ngModel)]="formaPago.creditoFundit" (ngModelChange)="onPaymentChange()"
                    class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">CrÃ©dito Hipotecario</label>
                <input type="number" [(ngModel)]="formaPago.creditoHipotecario" (ngModelChange)="onPaymentChange()"
                    class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- ValidaciÃ³n Suma -->
        <div class="mt-4 flex justify-between items-center p-3 rounded-md"
            [ngClass]="isValid ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'">
            <span>Suma Pagos: {{ sumaPago | number:'1.0-2' }} UF</span>
            <span *ngIf="!isValid" class="font-medium">Faltan: {{ (valorTotal - sumaPago) | number:'1.0-2' }} UF</span>
            <span *ngIf="isValid" class="font-bold flex items-center">
                <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                        clip-rule="evenodd"></path>
                </svg>
                Correcto
            </span>
        </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-between mt-8">
        <button (click)="back.emit()"
            class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            AtrÃ¡s
        </button>
        <div class="flex gap-3">
            <button (click)="emitCotizacion()" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Generar CotizaciÃ³n
            </button>
            <button (click)="confirm()" [disabled]="!isValid"
                class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Confirmar Venta
            </button>
        </div>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-payment\step-payment.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { StepPaymentComponent } from './step-payment.component';

describe('StepPaymentComponent', () => {
  let component: StepPaymentComponent;
  let fixture: ComponentFixture<StepPaymentComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [StepPaymentComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(StepPaymentComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-payment\step-payment.component.ts
================================================================

import { Component, EventEmitter, Input, Output, OnChanges, SimpleChanges } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { FormaPago } from '../../../models';

@Component({
  selector: 'app-step-payment',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './step-payment.component.html',
  styleUrls: ['./step-payment.component.css']
})
export class StepPaymentComponent implements OnChanges {
  @Input() unitValue: number = 0;
  @Output() paymentDefined = new EventEmitter<any>();
  @Output() back = new EventEmitter<void>();
  @Output() generateCotizacion = new EventEmitter<any>();

  // Inputs
  descuentoPorcentaje: number = 0;
  incluyeEstacionamiento: boolean = false;
  incluyeBodega: boolean = false;
  usaAporteInmobiliaria: boolean = false;

  // Constants (Mock values for MVP)
  readonly VALOR_ESTACIONAMIENTO = 350;
  readonly VALOR_BODEGA = 100;

  // Calculated Values
  valorDescuento: number = 0;
  valorEstacionamiento: number = 0;
  valorBodega: number = 0;
  subtotal: number = 0;
  valorAporte: number = 0;
  valorTotal: number = 0;

  // Payment Methods
  formaPago: FormaPago = {
    reserva: 20,
    ahorro: 0,
    aporteInmobiliario: 0,
    creditoFundit: 0,
    creditoHipotecario: 0
  };

  sumaPago: number = 0;
  isValid: boolean = false;

  ngOnChanges(changes: SimpleChanges) {
    if (changes['unitValue']) {
      this.calculateFinancials();
    }
  }

  calculateFinancials() {
    // 1. Discount
    this.valorDescuento = Math.round(this.unitValue * (this.descuentoPorcentaje / 100));
    const valorConDescuento = this.unitValue - this.valorDescuento;

    // 2. Optionals
    this.valorEstacionamiento = this.incluyeEstacionamiento ? this.VALOR_ESTACIONAMIENTO : 0;
    this.valorBodega = this.incluyeBodega ? this.VALOR_BODEGA : 0;

    // 3. Subtotal
    this.subtotal = valorConDescuento + this.valorEstacionamiento + this.valorBodega;

    // 4. Aporte
    this.valorAporte = this.usaAporteInmobiliaria ? Math.round(this.subtotal * 0.10) : 0;
    this.formaPago.aporteInmobiliario = this.valorAporte; // Auto-set aporte payment

    // 5. Total
    this.valorTotal = this.subtotal + this.valorAporte;

    this.calculatePaymentSum();
  }

  calculatePaymentSum() {
    this.sumaPago =
      (this.formaPago.reserva || 0) +
      (this.formaPago.ahorro || 0) +
      (this.formaPago.aporteInmobiliario || 0) +
      (this.formaPago.creditoFundit || 0) +
      (this.formaPago.creditoHipotecario || 0);

    // Allow small floating point error
    this.isValid = Math.abs(this.sumaPago - this.valorTotal) < 0.1;
  }

  onDescuentoChange() {
    if (this.descuentoPorcentaje < 0) this.descuentoPorcentaje = 0;
    if (this.descuentoPorcentaje > 15) this.descuentoPorcentaje = 15;
    this.calculateFinancials();
  }

  onOptionalChange() {
    this.calculateFinancials();
  }

  onPaymentChange() {
    this.calculatePaymentSum();
  }

  confirm() {
    if (this.isValid) {
      this.paymentDefined.emit({
        descuentoPorcentaje: this.descuentoPorcentaje,
        incluyeEstacionamiento: this.incluyeEstacionamiento,
        incluyeBodega: this.incluyeBodega,
        usaAporteInmobiliaria: this.usaAporteInmobiliaria,
        formaPago: this.formaPago
      });
    }
  }

  emitCotizacion() {
    this.generateCotizacion.emit({
      descuentoPorcentaje: this.descuentoPorcentaje,
      incluyeEstacionamiento: this.incluyeEstacionamiento,
      incluyeBodega: this.incluyeBodega,
      usaAporteInmobiliaria: this.usaAporteInmobiliaria,
      formaPago: this.formaPago
    });
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-summary\step-summary.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-summary\step-summary.component.html
================================================================

<div class="space-y-6">
    <h2 class="text-xl font-semibold text-gray-800">Resumen de Venta</h2>

    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6 bg-gray-50">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Unidad</h3>
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
            <dl class="sm:divide-y sm:divide-gray-200">
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Nombre</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ unit?.nombre }}</dd>
                </div>
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Valor</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ unit?.valorUf | number:'1.0-0' }} UF
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6 bg-gray-50">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Cliente</h3>
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
            <dl class="sm:divide-y sm:divide-gray-200">
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Nombre</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ client?.nombreCompleto }}</dd>
                </div>
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">RUT</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ client?.rut }}</dd>
                </div>
            </dl>
        </div>
    </div>

    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:px-6 bg-gray-50">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Pago</h3>
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
            <dl class="sm:divide-y sm:divide-gray-200">
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Pie</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ fichaData.pieMonto | number:'1.0-0'
                        }} UF</dd>
                </div>
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Reserva</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ fichaData.reservaMonto |
                        number:'1.0-0' }} UF</dd>
                </div>
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-500">Cuotas</dt>
                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ fichaData.cuotas?.length }}</dd>
                </div>
            </dl>
        </div>
    </div>

    <div class="flex justify-between mt-6">
        <button (click)="back.emit()" class="text-gray-600 hover:text-gray-800">AtrÃ¡s</button>
        <button (click)="confirm.emit()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">
            Confirmar Venta
        </button>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-summary\step-summary.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { StepSummaryComponent } from './step-summary.component';

describe('StepSummaryComponent', () => {
  let component: StepSummaryComponent;
  let fixture: ComponentFixture<StepSummaryComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [StepSummaryComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(StepSummaryComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-summary\step-summary.component.ts
================================================================

import { Component, EventEmitter, Input, Output } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Unidad, Cliente, CreateFichaDto } from '../../../models';

@Component({
  selector: 'app-step-summary',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './step-summary.component.html',
  styleUrls: ['./step-summary.component.css']
})
export class StepSummaryComponent {
  @Input() unit: Unidad | null = null;
  @Input() client: Cliente | null = null;
  @Input() fichaData: Partial<CreateFichaDto> = {};
  @Output() confirm = new EventEmitter<void>();
  @Output() back = new EventEmitter<void>();
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-unit\step-unit.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-unit\step-unit.component.html
================================================================

<div class="space-y-6">
    <h2 class="text-xl font-semibold text-gray-800">Seleccionar Unidad</h2>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Proyecto</label>
        <select [(ngModel)]="selectedProjectId" (change)="onProjectChange()" class="w-full p-2 border rounded">
            <option [ngValue]="null">Seleccione un proyecto...</option>
            <option *ngFor="let p of projects" [value]="p.id">{{ p.nombre }}</option>
        </select>
    </div>

    <div *ngIf="units.length > 0" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div *ngFor="let unit of units" (click)="selectUnit(unit)"
            class="p-4 border rounded cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-colors">
            <div class="font-bold">{{ unit.nombre }}</div>
            <div class="text-sm text-gray-600">{{ unit.tipologia }}</div>
            <div class="text-sm font-semibold mt-2">{{ unit.valorUf | number:'1.0-0' }} UF</div>
        </div>
    </div>

    <div *ngIf="selectedProjectId && units.length === 0" class="text-center text-gray-500 py-8">
        No hay unidades disponibles en este proyecto.
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-unit\step-unit.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { StepUnitComponent } from './step-unit.component';

describe('StepUnitComponent', () => {
  let component: StepUnitComponent;
  let fixture: ComponentFixture<StepUnitComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [StepUnitComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(StepUnitComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\step-unit\step-unit.component.ts
================================================================

import { Component, EventEmitter, OnInit, Output } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ProjectsService } from '../../../services/projects.service';
import { Proyecto, Unidad } from '../../../models';
import { FormsModule } from '@angular/forms';

@Component({
  selector: 'app-step-unit',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './step-unit.component.html',
  styleUrls: ['./step-unit.component.css']
})
export class StepUnitComponent implements OnInit {
  @Output() unitSelected = new EventEmitter<Unidad>();

  projects: Proyecto[] = [];
  selectedProjectId: number | null = null;
  units: Unidad[] = [];

  constructor(private projectsService: ProjectsService) { }

  ngOnInit() {
    this.projectsService.getProjects().subscribe(data => this.projects = data);
  }

  onProjectChange() {
    if (this.selectedProjectId) {
      this.projectsService.getUnits(this.selectedProjectId).subscribe(data => {
        this.units = data.filter(u => u.estado === 'Disponible');
      });
    } else {
      this.units = [];
    }
  }

  selectUnit(unit: Unidad) {
    this.unitSelected.emit(unit);
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\sales-wizard.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\sales-wizard.component.html
================================================================

<div class="container mx-auto p-4">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Nueva Venta</h1>

        <!-- Stepper -->
        <div class="flex items-center justify-between mb-8">
            <div class="flex flex-col items-center" [class.text-blue-600]="currentStep >= 1"
                [class.text-gray-400]="currentStep < 1">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 font-bold mb-2"
                    [class.border-blue-600]="currentStep >= 1" [class.bg-blue-600]="currentStep > 1"
                    [class.text-white]="currentStep > 1">
                    1
                </div>
                <span class="text-sm">Unidad</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4" [class.bg-blue-600]="currentStep > 1"></div>

            <div class="flex flex-col items-center" [class.text-blue-600]="currentStep >= 2"
                [class.text-gray-400]="currentStep < 2">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 font-bold mb-2"
                    [class.border-blue-600]="currentStep >= 2" [class.bg-blue-600]="currentStep > 2"
                    [class.text-white]="currentStep > 2">
                    2
                </div>
                <span class="text-sm">Cliente</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4" [class.bg-blue-600]="currentStep > 2"></div>

            <div class="flex flex-col items-center" [class.text-blue-600]="currentStep >= 3"
                [class.text-gray-400]="currentStep < 3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 font-bold mb-2"
                    [class.border-blue-600]="currentStep >= 3" [class.bg-blue-600]="currentStep > 3"
                    [class.text-white]="currentStep > 3">
                    3
                </div>
                <span class="text-sm">Pago</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4" [class.bg-blue-600]="currentStep > 3"></div>

            <div class="flex flex-col items-center" [class.text-blue-600]="currentStep >= 4"
                [class.text-gray-400]="currentStep < 4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 font-bold mb-2"
                    [class.border-blue-600]="currentStep >= 4" [class.bg-blue-600]="currentStep >= 4"
                    [class.text-white]="currentStep >= 4">
                    4
                </div>
                <span class="text-sm">Resumen</span>
            </div>
        </div>
    </div>

    <!-- Steps Content -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <app-step-unit *ngIf="currentStep === 1" (unitSelected)="onUnitSelected($event)"></app-step-unit>

        <app-step-client *ngIf="currentStep === 2" (clientSelected)="onClientSelected($event)" (back)="prevStep()">
        </app-step-client>

        <app-step-payment *ngIf="currentStep === 3" [unitValue]="selectedUnit?.valorUf ?? 0"
            (paymentDefined)="onPaymentDefined($event)" (generateCotizacion)="onGenerateCotizacion($event)"
            (back)="prevStep()">
        </app-step-payment>

        <app-step-summary *ngIf="currentStep === 4" [unit]="selectedUnit" [client]="selectedClient"
            [fichaData]="fichaData" (confirm)="confirmSale()" (back)="prevStep()">
        </app-step-summary>
    </div>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\sales-wizard.component.spec.ts
================================================================

import { ComponentFixture, TestBed } from '@angular/core/testing';

import { SalesWizardComponent } from './sales-wizard.component';

describe('SalesWizardComponent', () => {
  let component: SalesWizardComponent;
  let fixture: ComponentFixture<SalesWizardComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [SalesWizardComponent]
    })
    .compileComponents();
    
    fixture = TestBed.createComponent(SalesWizardComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\components\sales-wizard\sales-wizard.component.ts
================================================================

import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { StepUnitComponent } from './step-unit/step-unit.component';
import { StepClientComponent } from './step-client/step-client.component';
import { StepPaymentComponent } from './step-payment/step-payment.component';
import { StepSummaryComponent } from './step-summary/step-summary.component';
import { CreateFichaDto, Unidad, Cliente } from '../../models';
import { SalesService } from '../../services/sales.service';
import { Router } from '@angular/router';

@Component({
  selector: 'app-sales-wizard',
  standalone: true,
  imports: [CommonModule, RouterModule, StepUnitComponent, StepClientComponent, StepPaymentComponent, StepSummaryComponent],
  templateUrl: './sales-wizard.component.html',
  styleUrls: ['./sales-wizard.component.css']
})
export class SalesWizardComponent {
  currentStep = 1;
  fichaData: Partial<CreateFichaDto> = {
    cuotas: []
  };
  selectedUnit: Unidad | null = null;
  selectedClient: Cliente | null = null;

  constructor(private salesService: SalesService, private router: Router) { }

  nextStep() {
    this.currentStep++;
  }

  prevStep() {
    this.currentStep--;
  }

  onUnitSelected(unit: Unidad) {
    this.selectedUnit = unit;
    this.fichaData.unidadId = unit.id;
    this.nextStep();
  }

  onClientSelected(client: Cliente) {
    this.selectedClient = client;
    this.fichaData.clienteId = client.id;
    this.nextStep();
  }

  onPaymentDefined(paymentData: any) {
    this.fichaData.descuentoPorcentaje = paymentData.descuentoPorcentaje;
    this.fichaData.incluyeEstacionamiento = paymentData.incluyeEstacionamiento;
    this.fichaData.incluyeBodega = paymentData.incluyeBodega;
    this.fichaData.usaAporteInmobiliaria = paymentData.usaAporteInmobiliaria;
    this.fichaData.formaPago = paymentData.formaPago;

    // Legacy mapping (optional, but good for safety if other parts use it)
    this.fichaData.pieMonto = paymentData.formaPago.ahorro;
    this.fichaData.reservaMonto = paymentData.formaPago.reserva;

    this.nextStep();
  }

  onGenerateCotizacion(paymentData: any) {
    const data: CreateFichaDto = {
      ...this.fichaData,
      descuentoPorcentaje: paymentData.descuentoPorcentaje,
      incluyeEstacionamiento: paymentData.incluyeEstacionamiento,
      incluyeBodega: paymentData.incluyeBodega,
      usaAporteInmobiliaria: paymentData.usaAporteInmobiliaria,
      formaPago: paymentData.formaPago
    } as CreateFichaDto;

    if (data.unidadId && data.clienteId) {
      this.salesService.generateCotizacion(data).subscribe({
        next: (res) => {
          console.log('CotizaciÃ³n generada:', res);
          // Here we would generate the PDF. For now, just alert or log.
          // In a real app, we might open a new window with the PDF or download it.
          // We can format the JSON to a readable string for the alert.
          const summary = `
CotizaciÃ³n Generada:
Cliente: ${res.clienteNombre}
Unidad: ${res.unidadNumero} (${res.unidadTipo})
Valor Base: ${res.valorBaseUf} UF
Descuento: ${res.descuentoPorcentaje}% (-${res.valorDescuentoUf} UF)
Estacionamiento: ${res.valorEstacionamientoUf} UF
Bodega: ${res.valorBodegaUf} UF
Subtotal: ${res.subtotalUf} UF
Aporte Inmobiliaria: ${res.valorAporteInmobiliariaUf} UF
TOTAL: ${res.valorTotalUf} UF
                `;
          alert(summary);
        },
        error: (err) => alert('Error al generar cotizaciÃ³n: ' + err.message)
      });
    } else {
      alert('Faltan datos para generar la cotizaciÃ³n (Unidad o Cliente)');
    }
  }

  confirmSale() {
    if (this.fichaData.unidadId && this.fichaData.clienteId) {
      this.salesService.createFicha(this.fichaData as CreateFichaDto).subscribe({
        next: (res) => {
          alert('Venta creada exitosamente: ' + res.folio);
          this.router.navigate(['/sales']);
        },
        error: (err) => alert('Error al crear venta: ' + err.message)
      });
    }
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\models\inventory.model.ts
================================================================

export interface UnitDTO {
    id: string;
    number: string;
    status: 'AVAILABLE' | 'RESERVED' | 'SOLD';
    typology: string; // e.g., "1D1B"
    area: number; // m2
    orientation: string; // e.g., "NE", "SW"
    price: number; // UF or CLP
}

export interface FloorDTO {
    floorNumber: number;
    units: UnitDTO[];
}

export interface BuildingResponseDTO {
    id: string;
    name: string;
    totalFloors: number;
    floorStructure: FloorDTO[];
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\auth.service.ts
================================================================

import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';

export interface User {
    id: number;
    nombre: string;
    rol: 'Admin' | 'Agente' | 'Broker' | 'Contabilidad';
}

@Injectable({
    providedIn: 'root'
})
export class AuthService {
    // Mock user for development
    private currentUserSubject = new BehaviorSubject<User | null>({
        id: 1,
        nombre: 'Admin User',
        rol: 'Admin'
    });

    currentUser$ = this.currentUserSubject.asObservable();

    constructor() { }

    get currentUserValue(): User | null {
        return this.currentUserSubject.value;
    }

    // Method to switch roles for testing
    loginAs(role: 'Admin' | 'Agente' | 'Broker' | 'Contabilidad') {
        this.currentUserSubject.next({
            id: role === 'Broker' ? 3 : 1,
            nombre: `${role} User`,
            rol: role
        });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\clients.service.spec.ts
================================================================

import { TestBed } from '@angular/core/testing';

import { ClientsService } from './clients.service';

describe('ClientsService', () => {
  let service: ClientsService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(ClientsService);
  });

  it('should be created', () => {
    expect(service).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\clients.service.ts
================================================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { Cliente } from '../models';

@Injectable({
  providedIn: 'root'
})
export class ClientsService {
  private apiUrl = 'http://localhost:3000/clients';

  constructor(private http: HttpClient) { }

  getClients(search?: string): Observable<Cliente[]> {
    let params: any = {};
    if (search) {
      params.search = search;
    }
    return this.http.get<Cliente[]>(this.apiUrl, { params });
  }

  getClient(id: number): Observable<Cliente> {
    return this.http.get<Cliente>(`${this.apiUrl}/${id}`);
  }

  createClient(client: Partial<Cliente>): Observable<Cliente> {
    return this.http.post<Cliente>(this.apiUrl, client);
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\commissions.service.ts
================================================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';
import { FichaVenta } from '../models';

@Injectable({
    providedIn: 'root'
})
export class CommissionsService {
    private apiUrl = `${environment.apiUrl}/commissions`;

    constructor(private http: HttpClient) { }

    getMyCommissions(): Observable<FichaVenta[]> {
        return this.http.get<FichaVenta[]>(`${this.apiUrl}/my`);
    }

    getAllCommissions(): Observable<FichaVenta[]> {
        return this.http.get<FichaVenta[]>(`${this.apiUrl}/all`);
    }

    updateStatus(fichaId: number, status: string): Observable<FichaVenta> {
        return this.http.patch<FichaVenta>(`${this.apiUrl}/${fichaId}/status`, { status });
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\dashboard.service.ts
================================================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface KPIs {
    ventasMes: number;
    totalFundit: number;
    cuotasAtrasadas: number;
    activeBenefits: number;
}

export interface SalesByBroker {
    name: string;
    value: number;
}

@Injectable({
    providedIn: 'root'
})
export class DashboardService {
    private apiUrl = `${environment.apiUrl}/dashboard`;

    constructor(private http: HttpClient) { }

    getKPIs(): Observable<KPIs> {
        return this.http.get<KPIs>(`${this.apiUrl}/kpis`);
    }

    getSalesByBroker(): Observable<SalesByBroker[]> {
        return this.http.get<SalesByBroker[]>(`${this.apiUrl}/sales-by-broker`);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\finance.service.spec.ts
================================================================

import { TestBed } from '@angular/core/testing';

import { FinanceService } from './finance.service';

describe('FinanceService', () => {
  let service: FinanceService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(FinanceService);
  });

  it('should be created', () => {
    expect(service).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\finance.service.ts
================================================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { PlanPago, Cuota } from '../models';

@Injectable({
  providedIn: 'root'
})
export class FinanceService {
  private apiUrl = 'http://localhost:3000/finance';

  constructor(private http: HttpClient) { }

  getPlan(fichaId: number): Observable<PlanPago> {
    return this.http.get<PlanPago>(`${this.apiUrl}/fichas/${fichaId}/plan`);
  }

  markAsPaid(cuotaId: number): Observable<Cuota> {
    return this.http.patch<Cuota>(`${this.apiUrl}/cuotas/${cuotaId}/pay`, {});
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\inventory.service.ts
================================================================

import { Injectable } from '@angular/core';
import { Observable, of } from 'rxjs';
import { BuildingResponseDTO, FloorDTO, UnitDTO } from '../models/inventory.model';

@Injectable({
    providedIn: 'root'
})
export class InventoryService {

    constructor() { }

    getBuildingData(buildingId: string): Observable<BuildingResponseDTO> {
        // Mock data generation
        const floors: FloorDTO[] = [];
        const totalFloors = buildingId === 'A' ? 10 : 25;
        const unitsPerFloor = buildingId === 'A' ? 5 : 12;

        for (let i = 1; i <= totalFloors; i++) {
            const units: UnitDTO[] = [];
            for (let j = 1; j <= unitsPerFloor; j++) {
                const statusRandom = Math.random();
                let status: 'AVAILABLE' | 'RESERVED' | 'SOLD' = 'AVAILABLE';
                if (statusRandom > 0.7) status = 'RESERVED';
                if (statusRandom > 0.9) status = 'SOLD';

                units.push({
                    id: `${buildingId}-${i}-${j}`,
                    number: `${i}0${j}`,
                    status: status,
                    typology: j % 2 === 0 ? '2D2B' : '1D1B',
                    area: j % 2 === 0 ? 85 : 50,
                    orientation: j % 2 === 0 ? 'NE' : 'SW',
                    price: j % 2 === 0 ? 5000 : 3500
                });
            }
            floors.push({ floorNumber: i, units: units });
        }

        const mockBuilding: BuildingResponseDTO = {
            id: buildingId,
            name: `Edificio ${buildingId}`,
            totalFloors: totalFloors,
            floorStructure: floors.reverse() // Top floors first usually
        };

        return of(mockBuilding);
    }

    getBuildings(): Observable<{ id: string, name: string }[]> {
        return of([
            { id: 'A', name: 'Edificio A' },
            { id: 'B', name: 'Edificio B' },
            { id: 'C', name: 'Edificio C' },
            { id: 'D', name: 'Edificio D' },
            { id: 'E', name: 'Edificio E' },
            { id: 'F', name: 'Edificio F' },
        ]);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\post-sales.service.ts
================================================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { environment } from '../../environments/environment';

export interface Escritura {
    id: number;
    estado: string;
    notaria?: string;
    repertorio?: string;
    fechaFirma?: Date;
    fechaInscripcion?: Date;
    observaciones?: string;
}

export interface Entrega {
    id: number;
    fechaProgramada?: Date;
    fechaReal?: Date;
    firmada: boolean;
    observaciones?: string;
}

@Injectable({
    providedIn: 'root'
})
export class PostSalesService {
    private apiUrl = `${environment.apiUrl}/post-sales`;

    constructor(private http: HttpClient) { }

    // Escritura
    createEscritura(fichaId: number, data: any): Observable<Escritura> {
        return this.http.post<Escritura>(`${this.apiUrl}/escrituras/${fichaId}`, data);
    }

    updateEscritura(id: number, data: any): Observable<Escritura> {
        return this.http.patch<Escritura>(`${this.apiUrl}/escrituras/${id}`, data);
    }

    getEscritura(fichaId: number): Observable<Escritura> {
        return this.http.get<Escritura>(`${this.apiUrl}/escrituras/ficha/${fichaId}`);
    }

    // Entrega
    scheduleEntrega(fichaId: number, date: Date): Observable<Entrega> {
        return this.http.post<Entrega>(`${this.apiUrl}/entregas/${fichaId}/schedule`, { date });
    }

    completeEntrega(id: number, observations: string): Observable<Entrega> {
        return this.http.patch<Entrega>(`${this.apiUrl}/entregas/${id}/complete`, { observations });
    }

    getEntrega(fichaId: number): Observable<Entrega> {
        return this.http.get<Entrega>(`${this.apiUrl}/entregas/ficha/${fichaId}`);
    }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\projects.service.spec.ts
================================================================

import { TestBed } from '@angular/core/testing';

import { ProjectsService } from './projects.service';

describe('ProjectsService', () => {
  let service: ProjectsService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(ProjectsService);
  });

  it('should be created', () => {
    expect(service).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\projects.service.ts
================================================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { Proyecto, Unidad } from '../models';

@Injectable({
  providedIn: 'root'
})
export class ProjectsService {
  private apiUrl = 'http://localhost:3000/projects'; // TODO: Env var

  constructor(private http: HttpClient) { }

  getProjects(): Observable<Proyecto[]> {
    return this.http.get<Proyecto[]>(this.apiUrl);
  }

  getUnits(projectId: number): Observable<Unidad[]> {
    return this.http.get<Unidad[]>(`${this.apiUrl}/${projectId}/units`);
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\sales.service.spec.ts
================================================================

import { TestBed } from '@angular/core/testing';

import { SalesService } from './sales.service';

describe('SalesService', () => {
  let service: SalesService;

  beforeEach(() => {
    TestBed.configureTestingModule({});
    service = TestBed.inject(SalesService);
  });

  it('should be created', () => {
    expect(service).toBeTruthy();
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\services\sales.service.ts
================================================================

import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { CreateFichaDto, FichaVenta } from '../models';

@Injectable({
  providedIn: 'root'
})
export class SalesService {
  private apiUrl = 'http://localhost:3000/sales';

  constructor(private http: HttpClient) { }

  createFicha(data: CreateFichaDto): Observable<FichaVenta> {
    return this.http.post<FichaVenta>(this.apiUrl, data);
  }

  generateCotizacion(data: CreateFichaDto): Observable<any> {
    return this.http.post<any>(`${this.apiUrl}/cotizacion`, data);
  }

  getOne(id: number): Observable<FichaVenta> {
    return this.http.get<FichaVenta>(`${this.apiUrl}/${id}`);
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\app.component.css
================================================================



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\app.component.html
================================================================

<div class="min-h-screen bg-gray-100 flex">
    <!-- Sidebar -->
    <nav class="bg-gray-800 w-64 flex-shrink-0">
        <div class="p-4">
            <a href="/">
                <h1 class="text-white text-2xl font-bold">InmoApp</h1>
                <p class="text-gray-400 text-sm">ERP Inmobiliario</p>
            </a>
        </div>

        <div class="mt-8 px-4 space-y-2">
            <a routerLink="/projects" routerLinkActive="bg-gray-900 text-white"
                class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                Inventario
            </a>
            <a routerLink="/clients" routerLinkActive="bg-gray-900 text-white"
                class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                CRM Clientes
            </a>
            <a routerLink="/sales/new" routerLinkActive="bg-gray-900 text-white"
                class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                Nueva Venta
            </a>
            <a routerLink="/commissions" routerLinkActive="bg-gray-900 text-white"
                class="block px-4 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                Comisiones
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-8">
        <router-outlet></router-outlet>
    </main>
</div>


================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\app.component.spec.ts
================================================================

import { TestBed } from '@angular/core/testing';
import { AppComponent } from './app.component';

describe('AppComponent', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [AppComponent],
    }).compileComponents();
  });

  it('should create the app', () => {
    const fixture = TestBed.createComponent(AppComponent);
    const app = fixture.componentInstance;
    expect(app).toBeTruthy();
  });

  it(`should have the 'frontend' title`, () => {
    const fixture = TestBed.createComponent(AppComponent);
    const app = fixture.componentInstance;
    expect(app.title).toEqual('frontend');
  });

  it('should render title', () => {
    const fixture = TestBed.createComponent(AppComponent);
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h1')?.textContent).toContain('Hello, frontend');
  });
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\app.component.ts
================================================================

import { Component } from '@angular/core';
import { RouterOutlet, RouterLink, RouterLinkActive } from '@angular/router';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [RouterOutlet, RouterLink, RouterLinkActive, CommonModule],
  templateUrl: './app.component.html',
  styleUrl: './app.component.css'
})
export class AppComponent {
  title = 'frontend';
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\app.config.ts
================================================================

import { ApplicationConfig } from '@angular/core';
import { provideRouter } from '@angular/router';
import { provideHttpClient } from '@angular/common/http';

import { routes } from './app.routes';

export const appConfig: ApplicationConfig = {
  providers: [provideRouter(routes), provideHttpClient()]
};



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\app.routes.ts
================================================================

import { Routes } from '@angular/router';
import { ProjectListComponent } from './components/project-list/project-list.component';
import { HomeComponent } from './components/home/home.component';
import { InventoryViewComponent } from './components/inventory-view/inventory-view.component';
import { ClientListComponent } from './components/client-list/client-list.component';
import { ClientDetailComponent } from './components/client-detail/client-detail.component';
import { ClientFormComponent } from './components/client-form/client-form.component';
import { SalesWizardComponent } from './components/sales-wizard/sales-wizard.component';
import { SalesDetailComponent } from './components/sales-detail/sales-detail.component';
import { CommissionsListComponent } from './components/commissions-list/commissions-list.component';

export const routes: Routes = [
    { path: '', component: HomeComponent },
    { path: 'projects', component: ProjectListComponent },
    { path: 'inventory/:id', component: InventoryViewComponent },
    { path: 'clients', component: ClientListComponent },
    { path: 'clients/new', component: ClientFormComponent },
    { path: 'clients/:id', component: ClientDetailComponent },
    { path: 'sales/new', component: SalesWizardComponent },
    { path: 'sales/:id', component: SalesDetailComponent },
    { path: 'commissions', component: CommissionsListComponent },
    { path: 'dynamic-inventory', loadComponent: () => import('./components/inventory/building-viewer/building-viewer.component').then(m => m.BuildingViewerComponent) }
];



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\app\models.ts
================================================================

export interface Unidad {
    id: number;
    proyectoId: number;
    nombre: string;
    tipologia: string;
    metrosCuadrados: number;
    piso: number;
    valorUf: number;
    estado: 'Disponible' | 'Reservada' | 'Vendida';
    reservaExpiraEn?: string; // Optional: expiration date for reserved units
}

export interface Proyecto {
    id: number;
    nombre: string;
    direccion: string;
    comuna: string;
    imagenPrincipalUrl: string;
    unidades?: Unidad[];
}
export interface DocumentoCliente {
    id: number;
    tipoDocumento: string;
    urlS3: string;
    estadoValidacion: string;
    createdAt: string;
}

export interface Cliente {
    id: number;
    nombre1?: string;
    nombre2?: string;
    apellido1?: string;
    apellido2?: string;
    nombreCompleto: string;
    rut: string;
    email: string;
    telefono: string;
    fechaNacimiento?: string;
    estadoCivil?: string;
    profesion?: string;
    renta?: number;
    nacionalidad?: string;
    direccionCalle?: string;
    direccionNumero?: string;
    direccionComuna?: string;
    direccionCiudad?: string;
    direccionRegion?: string;
    direccionPais?: string;
    documentos?: DocumentoCliente[];
}

export interface CuotaDto {
    numero: number;
    monto: number;
    fechaVencimiento: string;
}

export interface FormaPago {
    reserva: number;
    ahorro: number;
    aporteInmobiliario: number;
    creditoFundit: number;
    creditoHipotecario: number;
}

export interface CreateFichaDto {
    unidadId: number;
    clienteId: number;
    descuentoPorcentaje?: number;
    incluyeEstacionamiento: boolean;
    incluyeBodega: boolean;
    usaAporteInmobiliaria: boolean;
    formaPago: FormaPago;
    // Legacy fields kept for compatibility if needed, but should be replaced by formaPago
    pieMonto?: number;
    reservaMonto?: number;
    cuotas?: CuotaDto[];
}

export interface FichaVenta {
    id: number;
    folio: string;
    estadoFicha: string;
    unidad: Unidad;
    clientePrincipal?: Cliente;
    agente?: { id: number; nombre: string; email: string };
    valorTotalUf: number;
    comisionBrokerMonto?: number;
    estadoComisionBroker?: string;
    createdAt: string;
}

export interface Cuota {
    id: number;
    numeroCuota: number;
    montoCuota: number;
    fechaVencimiento: string;
    estado: string;
    fechaPago?: string;
}

export interface PlanPago {
    id: number;
    tipoPlan: string;
    montoTotal: number;
    montoPie: number;
    montoReserva: number;
    saldoAPagar: number;
    numeroCuotas: number;
    cuotas?: Cuota[];
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\environments\environment.ts
================================================================

export const environment = {
    production: false,
    apiUrl: 'http://localhost:3000'
};



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\index.html
================================================================

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Frontend</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root></app-root>
</body>
</html>



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\main.ts
================================================================

import { bootstrapApplication } from '@angular/platform-browser';
import { appConfig } from './app/app.config';
import { AppComponent } from './app/app.component';

bootstrapApplication(AppComponent, appConfig)
  .catch((err) => console.error(err));



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\src\styles.css
================================================================

@tailwind base;
@tailwind components;
@tailwind utilities;



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\angular.json
================================================================

{
  "$schema": "./node_modules/@angular/cli/lib/config/schema.json",
  "version": 1,
  "newProjectRoot": "projects",
  "projects": {
    "frontend": {
      "projectType": "application",
      "schematics": {},
      "root": "",
      "sourceRoot": "src",
      "prefix": "app",
      "architect": {
        "build": {
          "builder": "@angular-devkit/build-angular:application",
          "options": {
            "outputPath": "dist/frontend",
            "index": "src/index.html",
            "browser": "src/main.ts",
            "polyfills": [
              "zone.js"
            ],
            "tsConfig": "tsconfig.app.json",
            "assets": [
              "src/favicon.ico",
              "src/assets"
            ],
            "styles": [
              "src/styles.css"
            ],
            "scripts": []
          },
          "configurations": {
            "production": {
              "budgets": [
                {
                  "type": "initial",
                  "maximumWarning": "500kb",
                  "maximumError": "1mb"
                },
                {
                  "type": "anyComponentStyle",
                  "maximumWarning": "2kb",
                  "maximumError": "4kb"
                }
              ],
              "outputHashing": "all"
            },
            "development": {
              "optimization": false,
              "extractLicenses": false,
              "sourceMap": true
            }
          },
          "defaultConfiguration": "production"
        },
        "serve": {
          "builder": "@angular-devkit/build-angular:dev-server",
          "configurations": {
            "production": {
              "buildTarget": "frontend:build:production"
            },
            "development": {
              "buildTarget": "frontend:build:development"
            }
          },
          "defaultConfiguration": "development"
        },
        "extract-i18n": {
          "builder": "@angular-devkit/build-angular:extract-i18n",
          "options": {
            "buildTarget": "frontend:build"
          }
        },
        "test": {
          "builder": "@angular-devkit/build-angular:karma",
          "options": {
            "polyfills": [
              "zone.js",
              "zone.js/testing"
            ],
            "tsConfig": "tsconfig.spec.json",
            "assets": [
              "src/favicon.ico",
              "src/assets"
            ],
            "styles": [
              "src/styles.css"
            ],
            "scripts": []
          }
        }
      }
    }
  },
  "cli": {
    "analytics": false
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\package.json
================================================================

{
  "name": "frontend",
  "version": "0.0.0",
  "scripts": {
    "ng": "ng",
    "start": "ng serve",
    "build": "ng build",
    "watch": "ng build --watch --configuration development",
    "test": "ng test",
    "e2e": "playwright test",
    "e2e:ui": "playwright test --ui"
  },
  "private": true,
  "dependencies": {
    "@angular/animations": "^17.3.0",
    "@angular/common": "^17.3.0",
    "@angular/compiler": "^17.3.0",
    "@angular/core": "^17.3.0",
    "@angular/forms": "^17.3.0",
    "@angular/platform-browser": "^17.3.0",
    "@angular/platform-browser-dynamic": "^17.3.0",
    "@angular/router": "^17.3.0",
    "rxjs": "~7.8.0",
    "tslib": "^2.3.0",
    "zone.js": "~0.14.3"
  },
  "devDependencies": {
    "@angular-devkit/build-angular": "^17.3.17",
    "@angular/cli": "^17.3.17",
    "@angular/compiler-cli": "^17.3.0",
    "@playwright/test": "^1.56.1",
    "@types/jasmine": "~5.1.0",
    "autoprefixer": "^10.4.22",
    "jasmine-core": "~5.1.0",
    "karma": "~6.4.0",
    "karma-chrome-launcher": "~3.2.0",
    "karma-coverage": "~2.2.0",
    "karma-jasmine": "~5.1.0",
    "karma-jasmine-html-reporter": "~2.1.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.18",
    "typescript": "~5.4.2"
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\playwright.config.ts
================================================================

import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
    testDir: './e2e',
    fullyParallel: true,
    forbidOnly: !!process.env['CI'],
    retries: process.env['CI'] ? 2 : 0,
    workers: process.env['CI'] ? 1 : undefined,
    reporter: 'html',
    use: {
        baseURL: 'http://localhost:4200',
        trace: 'on-first-retry',
    },
    projects: [
        {
            name: 'chromium',
            use: { ...devices['Desktop Chrome'] },
        },
        {
            name: 'firefox',
            use: { ...devices['Desktop Firefox'] },
        },
        {
            name: 'webkit',
            use: { ...devices['Desktop Safari'] },
        },
    ],
});



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\tsconfig.app.json
================================================================

/* To learn more about this file see: https://angular.io/config/tsconfig. */
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./out-tsc/app",
    "types": []
  },
  "files": [
    "src/main.ts"
  ],
  "include": [
    "src/**/*.d.ts"
  ]
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\tsconfig.json
================================================================

/* To learn more about this file see: https://angular.io/config/tsconfig. */
{
  "compileOnSave": false,
  "compilerOptions": {
    "outDir": "./dist/out-tsc",
    "strict": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "sourceMap": true,
    "declaration": false,
    "experimentalDecorators": true,
    "moduleResolution": "node",
    "importHelpers": true,
    "target": "ES2022",
    "module": "ES2022",
    "useDefineForClassFields": false,
    "lib": [
      "ES2022",
      "dom"
    ]
  },
  "angularCompilerOptions": {
    "enableI18nLegacyMessageIdFormat": false,
    "strictInjectionParameters": true,
    "strictInputAccessModifiers": true,
    "strictTemplates": true
  }
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\frontend\tsconfig.spec.json
================================================================

/* To learn more about this file see: https://angular.io/config/tsconfig. */
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./out-tsc/spec",
    "types": [
      "jasmine"
    ]
  },
  "include": [
    "src/**/*.spec.ts",
    "src/**/*.d.ts"
  ]
}



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\docker-compose.yml
================================================================

version: '3.8'
services:
  db:
    image: postgres:15
    container_name: inmoapp_db
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: adminpassword
      POSTGRES_DB: inmoapp_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  postgres_data:



================================================================
FILE: C:\Users\javie\proyectos\AppInmo\package.json
================================================================

{
  "name": "app-inmo-root",
  "private": true,
  "scripts": {
    "prepare": "husky install"
  },
  "devDependencies": {
    "husky": "^9.0.11",
    "lint-staged": "^15.2.2",
    "prettier": "^3.2.5",
    "eslint": "^8.57.0"
  }
}

